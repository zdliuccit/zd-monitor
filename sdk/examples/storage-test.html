<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°ç¼“å­˜å’Œå®šæ—¶ä¸ŠæŠ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .button-group {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .log {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .status {
            background-color: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å‰ç«¯æ€§èƒ½ç›‘æ§SDK - æœ¬åœ°ç¼“å­˜å’Œå®šæ—¶ä¸ŠæŠ¥æµ‹è¯•</h1>
        
        <div class="status">
            <h3>å½“å‰çŠ¶æ€</h3>
            <div id="status">åˆå§‹åŒ–ä¸­...</div>
        </div>

        <div class="button-group">
            <button onclick="sendPerformanceData()">å‘é€æ€§èƒ½æ•°æ®</button>
            <button onclick="sendErrorData()">å‘é€é”™è¯¯æ•°æ®</button>
            <button onclick="sendBehaviorData()">å‘é€è¡Œä¸ºæ•°æ®</button>
            <button onclick="checkStorage()">æ£€æŸ¥æœ¬åœ°å­˜å‚¨</button>
            <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="log" id="log">
            ç­‰å¾…æ“ä½œ...
        </div>
    </div>

    <script src="../dist/index.js"></script>
    <script>
        let monitor;
        let logContainer = document.getElementById('log');
        let statusContainer = document.getElementById('status');
        
        function log(message) {
            const now = new Date().toLocaleTimeString();
            logContainer.innerHTML += `[${now}] ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStatus(message) {
            statusContainer.innerHTML = message;
        }

        // åˆå§‹åŒ–ç›‘æ§SDK
        try {
            monitor = new WebMonitorSDK({
                appId: 'test-app',
                reportUrl: 'http://localhost:3000/api/report', // æ¨¡æ‹Ÿçš„ä¸ŠæŠ¥åœ°å€
                debug: true,
                reportInterval: 60000, // 1åˆ†é’Ÿ
                batchSize: 5,
                maxQueueSize: 20
            });
            
            log('âœ“ SDKåˆå§‹åŒ–æˆåŠŸï¼Œä¸ŠæŠ¥é—´éš”ï¼š1åˆ†é’Ÿ');
            updateStatus('SDKå·²åˆå§‹åŒ–ï¼Œä¸ŠæŠ¥é—´éš”ï¼š1åˆ†é’Ÿ');
        } catch (error) {
            log('âœ— SDKåˆå§‹åŒ–å¤±è´¥: ' + error.message);
            updateStatus('SDKåˆå§‹åŒ–å¤±è´¥');
        }

        function sendPerformanceData() {
            try {
                monitor.report({
                    type: 'performance',
                    data: {
                        type: 'LCP',
                        name: 'largest-contentful-paint',
                        value: 1200,
                        rating: 'good'
                    }
                });
                log('âœ“ æ€§èƒ½æ•°æ®å·²åŠ å…¥é˜Ÿåˆ—');
            } catch (error) {
                log('âœ— å‘é€æ€§èƒ½æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        function sendErrorData() {
            try {
                monitor.report({
                    type: 'error',
                    data: {
                        type: 'js_error',
                        message: 'æµ‹è¯•é”™è¯¯ä¿¡æ¯',
                        stack: 'Error: æµ‹è¯•é”™è¯¯\n    at test.html:1:1',
                        filename: 'test.html',
                        lineno: 1,
                        colno: 1
                    },
                    priority: 'high' // é«˜ä¼˜å…ˆçº§ï¼Œä¼šç«‹å³ä¸ŠæŠ¥
                });
                log('âœ“ é”™è¯¯æ•°æ®å·²å‘é€ï¼ˆé«˜ä¼˜å…ˆçº§ï¼Œç«‹å³ä¸ŠæŠ¥ï¼‰');
            } catch (error) {
                log('âœ— å‘é€é”™è¯¯æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        function sendBehaviorData() {
            try {
                monitor.report({
                    type: 'behavior',
                    data: {
                        type: 'click',
                        element: 'button',
                        selector: '#test-button',
                        text: 'æµ‹è¯•æŒ‰é’®'
                    }
                });
                log('âœ“ è¡Œä¸ºæ•°æ®å·²åŠ å…¥é˜Ÿåˆ—');
            } catch (error) {
                log('âœ— å‘é€è¡Œä¸ºæ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        function checkStorage() {
            try {
                const storageData = localStorage.getItem('web_monitor_queue');
                if (storageData) {
                    const data = JSON.parse(storageData);
                    log(`ğŸ“¦ æœ¬åœ°å­˜å‚¨ä¸­æœ‰ ${data.length} æ¡æ•°æ®:`);
                    data.forEach((item, index) => {
                        log(`   ${index + 1}. ${item.type} - ${new Date(item.timestamp).toLocaleTimeString()}`);
                    });
                } else {
                    log('ğŸ“¦ æœ¬åœ°å­˜å‚¨ä¸ºç©º');
                }
            } catch (error) {
                log('âœ— æ£€æŸ¥æœ¬åœ°å­˜å‚¨å¤±è´¥: ' + error.message);
            }
        }

        function clearLogs() {
            logContainer.innerHTML = '';
        }

        // ç›‘å¬é¡µé¢å…³é—­äº‹ä»¶
        window.addEventListener('beforeunload', () => {
            log('ğŸ”„ é¡µé¢å³å°†å…³é—­ï¼Œæ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
        });

        // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚å¤±è´¥çš„æƒ…å†µ
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0];
            if (url.includes('/api/report')) {
                // æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯
                return Promise.reject(new Error('æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯'));
            }
            return originalFetch.apply(this, args);
        };

        // å®šæœŸæ›´æ–°çŠ¶æ€
        setInterval(() => {
            if (monitor && monitor.transport) {
                const queueStatus = monitor.transport.getQueueStatus();
                if (queueStatus) {
                    updateStatus(`é˜Ÿåˆ—çŠ¶æ€ - é«˜:${queueStatus.high} ä¸­:${queueStatus.medium} ä½:${queueStatus.low} é‡è¯•:${queueStatus.retry} å‘é€ä¸­:${queueStatus.pending}`);
                }
            }
        }, 5000);

        log('ğŸš€ æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
        log('ğŸ’¡ è¯´æ˜ï¼š');
        log('   - æ•°æ®ä¼šå…ˆå­˜å‚¨åœ¨å†…å­˜é˜Ÿåˆ—ä¸­');
        log('   - æ¯1åˆ†é’Ÿè‡ªåŠ¨ä¸ŠæŠ¥ä¸€æ¬¡');
        log('   - é¡µé¢å…³é—­æ—¶æ•°æ®ä¼šä¿å­˜åˆ°localStorage');
        log('   - ä¸‹æ¬¡æ‰“å¼€é¡µé¢æ—¶ä¼šè‡ªåŠ¨æ¢å¤æœªä¸ŠæŠ¥çš„æ•°æ®');
        log('   - é”™è¯¯æ•°æ®ä¼šç«‹å³ä¸ŠæŠ¥ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰');
    </script>
</body>
</html>