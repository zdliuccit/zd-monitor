<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React Integration - Web Monitor SDK</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; text-align: center; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #eee; border-radius: 6px; }
        button {
            background: #61dafb;
            color: #20232a;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
        }
        button:hover { background: #4fa8c5; }
        button.danger { background: #e74c3c; color: white; }
        button.danger:hover { background: #c0392b; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .error-boundary {
            padding: 10px;
            border: 2px solid #e74c3c;
            border-radius: 4px;
            background: #fdf2f2;
            color: #e74c3c;
            margin: 10px 0;
        }
        .component-demo {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
            background: #f9f9f9;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- SDK -->
    <script src="../dist/web-monitor-sdk.dev.js"></script>

    <script>
        const { useState, useEffect, useCallback, Component } = React;
        const { createRoot } = ReactDOM;

        // ÂàùÂßãÂåñSDK
        const sdk = new WebMonitorSDK.default({
            appId: 'react-test-app',
            reportUrl: 'https://httpbin.org/post',
            debug: true,
            sampling: 1,
            beforeSend: (data) => {
                window.logMessage && window.logMessage('üì§ SDKÂèëÈÄÅÊï∞ÊçÆ:', data);
                return data;
            }
        });

        // ‰ΩøÁî®ReactÊèí‰ª∂
        sdk.use(WebMonitorSDK.ReactPlugin);

        // ÈîôËØØËæπÁïåÁªÑ‰ª∂
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                this.setState({
                    error: error,
                    errorInfo: errorInfo
                });
                
                window.logMessage && window.logMessage('‚ùå ReactÈîôËØØËæπÁïåÊçïËé∑:', {
                    message: error.message,
                    stack: error.stack,
                    componentStack: errorInfo.componentStack
                });
            }

            render() {
                if (this.state.hasError) {
                    return React.createElement('div', { className: 'error-boundary' }, [
                        React.createElement('h3', { key: 'title' }, 'ÁªÑ‰ª∂Âá∫Èîô‰∫ÜÔºÅ'),
                        React.createElement('p', { key: 'message' }, this.state.error?.message),
                        React.createElement('button', {
                            key: 'reset',
                            onClick: () => this.setState({ hasError: false, error: null, errorInfo: null })
                        }, 'ÈáçÁΩÆÁªÑ‰ª∂')
                    ]);
                }

                return this.props.children;
            }
        }

        // ÂèØËÉΩÂá∫ÈîôÁöÑÁªÑ‰ª∂
        function ErrorComponent({ shouldError }) {
            if (shouldError) {
                throw new Error('ËøôÊòØReactÁªÑ‰ª∂‰∏≠ÁöÑÈîôËØØ');
            }

            return React.createElement('div', { className: 'component-demo' }, [
                React.createElement('h3', { key: 'title' }, 'Ê≠£Â∏∏ÁªÑ‰ª∂'),
                React.createElement('p', { key: 'desc' }, 'Ëøô‰∏™ÁªÑ‰ª∂Áé∞Âú®ËøêË°åÊ≠£Â∏∏'),
                React.createElement('button', {
                    key: 'btn',
                    className: 'danger',
                    onClick: () => {
                        throw new Error('ÁªÑ‰ª∂ÂÜÖÊåâÈíÆËß¶ÂèëÁöÑÈîôËØØ');
                    }
                }, 'Ëß¶ÂèëÁªÑ‰ª∂ÂÜÖÈîôËØØ')
            ]);
        }

        // ‰∏ªÂ∫îÁî®ÁªÑ‰ª∂
        function App() {
            const [count, setCount] = useState(0);
            const [showErrorComponent, setShowErrorComponent] = useState(false);
            const [triggerError, setTriggerError] = useState(false);
            const [logs, setLogs] = useState('');

            // Êó•ÂøóÂáΩÊï∞
            const logMessage = useCallback((message, data = null) => {
                const time = new Date().toLocaleTimeString();
                let logEntry = `<div><span style="color: #666;">[${time}]</span> ${message}`;
                
                if (data) {
                    logEntry += `<br/><pre style="margin: 5px 0; color: #007bff; font-size: 10px;">${JSON.stringify(data, null, 2)}</pre>`;
                }
                
                logEntry += '</div>';
                setLogs(prev => prev + logEntry);
            }, []);

            // Â∞ÜlogMessageÊåÇËΩΩÂà∞ÂÖ®Â±Ä
            useEffect(() => {
                window.logMessage = logMessage;
                return () => {
                    delete window.logMessage;
                };
            }, [logMessage]);

            // ÁªÑ‰ª∂ÊåÇËΩΩÊó∂ÁöÑÊó•Âøó
            useEffect(() => {
                logMessage('‚úÖ ReactÂ∫îÁî®Â∑≤ÊåÇËΩΩ');
                logMessage('üîå ReactÊèí‰ª∂Â∑≤ÈõÜÊàê');
                
                // ËÆæÁΩÆÁî®Êà∑‰ø°ÊÅØ
                sdk.setUser('react-user-' + Date.now(), {
                    framework: 'React',
                    version: React.version
                });
            }, [logMessage]);

            // ÈîôËØØÂ§ÑÁêÜÂáΩÊï∞
            const throwError = () => {
                throw new Error('ËøôÊòØReactÂáΩÊï∞ÁªÑ‰ª∂‰∏≠ÁöÑÈîôËØØ');
            };

            const throwAsyncError = () => {
                setTimeout(() => {
                    throw new Error('ËøôÊòØReactÁªÑ‰ª∂‰∏≠ÁöÑÂºÇÊ≠•ÈîôËØØ');
                }, 100);
                logMessage('‚è∞ ÂºÇÊ≠•ÈîôËØØÂ∞ÜÂú®100msÂêéËß¶Âèë');
            };

            const triggerPromiseError = () => {
                Promise.reject(new Error('ËøôÊòØReactÁªÑ‰ª∂‰∏≠ÁöÑPromiseÈîôËØØ'));
                logMessage('üîÑ Ëß¶Âèë‰∫ÜPromiseÈîôËØØ');
            };

            const increment = () => {
                setCount(prev => prev + 1);
                logMessage(`üî¢ ËÆ°Êï∞Â¢ûÂä†Âà∞: ${count + 1}`);
            };

            const reset = () => {
                setCount(0);
                logMessage('üîÑ ËÆ°Êï∞Â∑≤ÈáçÁΩÆ');
            };

            const clearLogs = () => {
                setLogs('');
            };

            return React.createElement('div', { className: 'container' }, [
                React.createElement('h1', { key: 'title' }, 'React + Web Monitor SDK ÈõÜÊàêÊµãËØï'),
                
                // ËÆ°Êï∞Âô®ÈÉ®ÂàÜ
                React.createElement('div', { key: 'counter', className: 'section' }, [
                    React.createElement('h2', { key: 'title' }, 'ReactÁªÑ‰ª∂ÊµãËØï'),
                    React.createElement('p', { key: 'count' }, `ÂΩìÂâçËÆ°Êï∞: ${count}`),
                    React.createElement('button', { key: 'inc', onClick: increment }, 'Â¢ûÂä†ËÆ°Êï∞'),
                    React.createElement('button', { key: 'reset', onClick: reset }, 'ÈáçÁΩÆËÆ°Êï∞')
                ]),

                // ÈîôËØØÊµãËØïÈÉ®ÂàÜ
                React.createElement('div', { key: 'errors', className: 'section' }, [
                    React.createElement('h2', { key: 'title' }, 'ReactÈîôËØØÊµãËØï'),
                    React.createElement('button', { key: 'js-error', className: 'danger', onClick: throwError }, 'ÊäõÂá∫JSÈîôËØØ'),
                    React.createElement('button', { key: 'async-error', className: 'danger', onClick: throwAsyncError }, 'ÊäõÂá∫ÂºÇÊ≠•ÈîôËØØ'),
                    React.createElement('button', { key: 'promise-error', className: 'danger', onClick: triggerPromiseError }, 'Ëß¶ÂèëPromiseÈîôËØØ')
                ]),

                // ÈîôËØØËæπÁïåÊµãËØï
                React.createElement('div', { key: 'boundary', className: 'section' }, [
                    React.createElement('h2', { key: 'title' }, 'ÈîôËØØËæπÁïåÊµãËØï'),
                    React.createElement('button', {
                        key: 'toggle',
                        onClick: () => setShowErrorComponent(!showErrorComponent)
                    }, showErrorComponent ? 'ÈöêËóèÈîôËØØÁªÑ‰ª∂' : 'ÊòæÁ§∫ÈîôËØØÁªÑ‰ª∂'),
                    React.createElement('button', {
                        key: 'trigger',
                        className: 'danger',
                        onClick: () => setTriggerError(!triggerError)
                    }, 'Ëß¶ÂèëÁªÑ‰ª∂ÈîôËØØ'),
                    
                    showErrorComponent && React.createElement(ErrorBoundary, { key: 'error-boundary' },
                        React.createElement(ErrorComponent, { shouldError: triggerError })
                    )
                ]),

                // Êó•ÂøóÈÉ®ÂàÜ
                React.createElement('div', { key: 'logs', className: 'section' }, [
                    React.createElement('h2', { key: 'title' }, 'Êó•ÂøóËæìÂá∫'),
                    React.createElement('button', { key: 'clear', onClick: clearLogs }, 'Ê∏ÖÁ©∫Êó•Âøó'),
                    React.createElement('div', {
                        key: 'log-content',
                        className: 'log',
                        dangerouslySetInnerHTML: { __html: logs }
                    })
                ])
            ]);
        }

        // Ê∏≤ÊüìÂ∫îÁî®
        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(React.createElement(App));

        // ÁõëÂê¨ÂÖ®Â±ÄÈîôËØØ
        window.addEventListener('error', (e) => {
            if (window.logMessage) {
                window.logMessage('‚ùå ÂÖ®Â±ÄÈîôËØØ: ' + e.message);
            }
        });

        window.addEventListener('unhandledrejection', (e) => {
            if (window.logMessage) {
                window.logMessage('‚ùå PromiseÈîôËØØ: ' + e.reason);
            }
        });

        console.log('üéâ ReactÊµãËØïÈ°µÈù¢Âä†ËΩΩÂÆåÊàê');
    </script>
</body>
</html>