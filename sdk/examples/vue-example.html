<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue Integration - Web Monitor SDK</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; text-align: center; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #eee; border-radius: 6px; }
        button {
            background: #42b883;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #369870; }
        button.danger { background: #e74c3c; }
        button.danger:hover { background: #c0392b; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <h1>{{ title }}</h1>
            
            <div class="section">
                <h2>Vue组件测试</h2>
                <p>当前计数: {{ count }}</p>
                <button @click="increment">增加计数</button>
                <button @click="reset">重置计数</button>
            </div>

            <div class="section">
                <h2>Vue错误测试</h2>
                <button class="danger" @click="throwError">抛出组件错误</button>
                <button class="danger" @click="throwAsyncError">抛出异步错误</button>
                <button class="danger" @click="triggerComputedError">触发计算属性错误</button>
            </div>

            <div class="section">
                <h2>动态组件</h2>
                <button @click="showComponent = !showComponent">
                    {{ showComponent ? '隐藏' : '显示' }}动态组件
                </button>
                <error-component v-if="showComponent"></error-component>
            </div>

            <div class="section">
                <h2>日志输出</h2>
                <button @click="clearLogs">清空日志</button>
                <div class="log" ref="log" v-html="logs"></div>
            </div>
        </div>
    </div>

    <!-- Vue 2.x -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <!-- SDK -->
    <script src="../dist/web-monitor-sdk.dev.js"></script>

    <script>
        // 错误组件
        Vue.component('error-component', {
            template: `
                <div style="padding: 10px; border: 1px solid #ddd; margin: 10px 0;">
                    <h3>动态组件</h3>
                    <p>这是一个可能出错的组件</p>
                    <button @click="causeError" class="danger">在组件内触发错误</button>
                </div>
            `,
            methods: {
                causeError() {
                    // 故意访问不存在的属性
                    this.nonExistentProperty.someMethod();
                }
            }
        });

        // 初始化SDK
        const sdk = new WebMonitorSDK.default({
            appId: 'vue-test-app',
            reportUrl: 'https://httpbin.org/post',
            debug: true,
            sampling: 1,
            beforeSend: (data) => {
                app.logMessage('📤 SDK发送数据:', data);
                return data;
            }
        });

        // 使用Vue插件
        sdk.use(WebMonitorSDK.VuePlugin);

        // Vue应用
        const app = new Vue({
            el: '#app',
            data: {
                title: 'Vue + Web Monitor SDK 集成测试',
                count: 0,
                showComponent: false,
                logs: ''
            },
            computed: {
                errorComputed() {
                    if (this.count > 10) {
                        // 故意抛出错误
                        throw new Error('计算属性中的错误：count > 10');
                    }
                    return this.count * 2;
                }
            },
            methods: {
                increment() {
                    this.count++;
                    this.logMessage(`🔢 计数增加到: ${this.count}`);
                    
                    // 触发计算属性错误
                    if (this.count > 10) {
                        try {
                            const computed = this.errorComputed;
                        } catch (error) {
                            // 错误会被Vue错误处理器捕获
                        }
                    }
                },
                
                reset() {
                    this.count = 0;
                    this.logMessage('🔄 计数已重置');
                },
                
                throwError() {
                    // 在Vue方法中抛出错误
                    throw new Error('这是Vue组件方法中的错误');
                },
                
                throwAsyncError() {
                    // 异步错误
                    setTimeout(() => {
                        throw new Error('这是Vue组件中的异步错误');
                    }, 100);
                },
                
                triggerComputedError() {
                    this.count = 15; // 触发计算属性错误
                },
                
                logMessage(message, data = null) {
                    const time = new Date().toLocaleTimeString();
                    let logEntry = `<div><span style="color: #666;">[${time}]</span> ${message}`;
                    
                    if (data) {
                        logEntry += `<br/><pre style="margin: 5px 0; color: #007bff; font-size: 10px;">${JSON.stringify(data, null, 2)}</pre>`;
                    }
                    
                    logEntry += '</div>';
                    this.logs += logEntry;
                    
                    // 自动滚动到底部
                    this.$nextTick(() => {
                        const logEl = this.$refs.log;
                        if (logEl) {
                            logEl.scrollTop = logEl.scrollHeight;
                        }
                    });
                },
                
                clearLogs() {
                    this.logs = '';
                }
            },
            
            mounted() {
                this.logMessage('✅ Vue应用已挂载');
                this.logMessage('🔌 Vue插件已集成');
                
                // 设置用户信息
                sdk.setUser('vue-user-' + Date.now(), {
                    framework: 'Vue.js',
                    version: Vue.version
                });
            },
            
            errorCaptured(err, instance, info) {
                this.logMessage(`❌ Vue错误边界捕获: ${err.message}`, {
                    error: err.message,
                    component: instance.$options.name || 'Anonymous',
                    info: info
                });
                
                // 返回false阻止错误继续传播
                return false;
            }
        });

        // 监听全局错误
        window.addEventListener('error', (e) => {
            app.logMessage('❌ 全局错误: ' + e.message);
        });

        window.addEventListener('unhandledrejection', (e) => {
            app.logMessage('❌ Promise错误: ' + e.reason);
        });

        app.logMessage('🎉 Vue测试页面加载完成');
    </script>
</body>
</html>