!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).WebMonitorSDK={})}(this,function(e){"use strict";var t,r,o,i,n;e.DataType=void 0,(t=e.DataType||(e.DataType={})).PERFORMANCE="performance",t.ERROR="error",t.BEHAVIOR="behavior",e.PerformanceType=void 0,(r=e.PerformanceType||(e.PerformanceType={})).LCP="LCP",r.INP="INP",r.CLS="CLS",r.FCP="FCP",r.FID="FID",r.TTFB="TTFB",r.NAVIGATION="navigation",r.RESOURCE="resource",r.API="api",e.ErrorType=void 0,(o=e.ErrorType||(e.ErrorType={})).JS_ERROR="js_error",o.PROMISE_ERROR="promise_error",o.RESOURCE_ERROR="resource_error",o.API_ERROR="api_error",o.CUSTOM_ERROR="custom_error",e.BehaviorType=void 0,(i=e.BehaviorType||(e.BehaviorType={})).CLICK="click",i.INPUT="input",i.SCROLL="scroll",i.ROUTE_CHANGE="route_change",i.PAGE_VIEW="page_view",e.ReportPriority=void 0,(n=e.ReportPriority||(e.ReportPriority={})).LOW="low",n.MEDIUM="medium",n.HIGH="high";class a{constructor(){this.STORAGE_KEY="web_monitor_queue",this.MAX_STORAGE_SIZE=1048576}save(e){if(!this.isLocalStorageAvailable())return!1;try{const t=JSON.stringify(e);return!(t.length>this.MAX_STORAGE_SIZE)&&(localStorage.setItem(this.STORAGE_KEY,t),!0)}catch(e){return!1}}load(){if(!this.isLocalStorageAvailable())return[];try{const e=localStorage.getItem(this.STORAGE_KEY);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return this.clear(),[]}}clear(){if(this.isLocalStorageAvailable())try{localStorage.removeItem(this.STORAGE_KEY)}catch(e){}}isLocalStorageAvailable(){try{const e="__localStorage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}getStorageSize(){if(!this.isLocalStorageAvailable())return 0;try{const e=localStorage.getItem(this.STORAGE_KEY);return e?e.length:0}catch(e){return 0}}}class s{constructor(e){var t,r,o,i,n,s,u,c,l;this.highPriorityQueue=[],this.mediumPriorityQueue=[],this.lowPriorityQueue=[],this.reportTimer=null,this.isDestroyed=!1,this.pendingRequests=0,this.retryQueue=[],this.options={url:e.url,timeout:null!==(t=e.timeout)&&void 0!==t?t:5e3,withCredentials:null!==(r=e.withCredentials)&&void 0!==r&&r,headers:null!==(o=e.headers)&&void 0!==o?o:{},reportInterval:null!==(i=e.reportInterval)&&void 0!==i?i:6e4,batchSize:null!==(n=e.batchSize)&&void 0!==n?n:10,maxQueueSize:null!==(s=e.maxQueueSize)&&void 0!==s?s:100,enableImmediateReport:null===(u=e.enableImmediateReport)||void 0===u||u,retryCount:null!==(c=e.retryCount)&&void 0!==c?c:3,retryInterval:null!==(l=e.retryInterval)&&void 0!==l?l:1e3},this.storageManager=new a,this.loadDataFromStorage(),this.startReportTimer(),this.setupBeforeUnload(),this.startRetryTimer()}loadDataFromStorage(){this.storageManager.load().forEach(e=>{const t=e.priority||this.getDefaultPriority(e.type);this.addToQueue(e,t)}),this.storageManager.clear()}saveDataToStorage(){const e=[...this.highPriorityQueue,...this.mediumPriorityQueue,...this.lowPriorityQueue];e.length>0&&this.storageManager.save(e)}startReportTimer(){this.reportTimer=window.setInterval(()=>{this.processQueuedData()},this.options.reportInterval)}startRetryTimer(){setInterval(()=>{this.processRetryQueue()},this.options.retryInterval)}setupBeforeUnload(){window.addEventListener("beforeunload",()=>{this.saveDataToStorage(),this.flushAllQueues()}),window.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&(this.saveDataToStorage(),this.flushAllQueues())})}flushAllQueues(){const e=[...this.highPriorityQueue,...this.mediumPriorityQueue,...this.lowPriorityQueue];e.length>0&&(this.trySendBeacon(e),this.highPriorityQueue=[],this.mediumPriorityQueue=[],this.lowPriorityQueue=[])}send(t){if(this.isDestroyed)return;const r=t.priority||this.getDefaultPriority(t.type);r===e.ReportPriority.HIGH&&this.options.enableImmediateReport?this.sendImmediately([t]):(this.addToQueue(t,r),this.checkQueueOverflow())}processQueuedData(){if(this.isDestroyed||this.pendingRequests>3)return;const t=this.highPriorityQueue.length>0||this.mediumPriorityQueue.length>0||this.lowPriorityQueue.length>0;if(this.mediumPriorityQueue.length>0){const t=this.mediumPriorityQueue.splice(0,this.options.batchSize);this.sendBatch(t,e.ReportPriority.MEDIUM)}if(this.lowPriorityQueue.length>0){const t=this.lowPriorityQueue.splice(0,this.options.batchSize);this.sendBatch(t,e.ReportPriority.LOW)}t&&this.storageManager.clear()}sendBatch(t,r){if(this.isDestroyed)return;this.pendingRequests++;const o=JSON.stringify(t),i=r===e.ReportPriority.HIGH?this.trySendBeacon(t)||this.sendFetch(o):this.sendFetch(o).catch(()=>this.sendXHR(o));Promise.resolve(i).then(()=>{var e;this.pendingRequests--,null===(e=this.options.headers)||void 0===e||e.debug}).catch(()=>{this.pendingRequests--,this.addToRetryQueue(t)})}sendImmediately(t){this.sendBatch(t,e.ReportPriority.HIGH)}trySendBeacon(e){if(!navigator.sendBeacon)return null;try{const t=JSON.stringify(e),r=new Blob([t],{type:"application/json"});return navigator.sendBeacon(this.options.url,r)?Promise.resolve():Promise.reject(new Error("SendBeacon failed"))}catch(e){return Promise.reject(e)}}getDefaultPriority(t){switch(t){case"error":return e.ReportPriority.HIGH;case"performance":default:return e.ReportPriority.MEDIUM;case"behavior":return e.ReportPriority.LOW}}addToQueue(t,r){switch(r){case e.ReportPriority.HIGH:this.highPriorityQueue.push(t);break;case e.ReportPriority.MEDIUM:this.mediumPriorityQueue.push(t);break;case e.ReportPriority.LOW:this.lowPriorityQueue.push(t)}}checkQueueOverflow(){this.highPriorityQueue.length+this.mediumPriorityQueue.length+this.lowPriorityQueue.length>=this.options.maxQueueSize&&this.processQueuedData()}addToRetryQueue(e){const t={data:e,retryCount:0,nextRetryTime:Date.now()+this.options.retryInterval};this.retryQueue.push(t)}processRetryQueue(){if(0===this.retryQueue.length||this.pendingRequests>3)return;const t=Date.now();this.retryQueue.filter(e=>t>=e.nextRetryTime).forEach(r=>{if(r.retryCount<this.options.retryCount)r.retryCount++,r.nextRetryTime=t+this.options.retryInterval*Math.pow(2,r.retryCount),this.sendBatch(r.data,e.ReportPriority.MEDIUM);else{const e=this.retryQueue.indexOf(r);e>-1&&this.retryQueue.splice(e,1)}})}async sendFetch(e){const t=new AbortController,r=setTimeout(()=>t.abort(),this.options.timeout);try{await fetch(this.options.url,{method:"POST",headers:{"Content-Type":"application/json",...this.options.headers},body:e,credentials:this.options.withCredentials?"include":"omit",signal:t.signal})}finally{clearTimeout(r)}}sendXHR(e){const t=new XMLHttpRequest;t.open("POST",this.options.url,!0),t.timeout=this.options.timeout,t.withCredentials=this.options.withCredentials,t.setRequestHeader("Content-Type","application/json"),Object.entries(this.options.headers).forEach(([e,r])=>{t.setRequestHeader(e,r)}),t.onerror=()=>{},t.ontimeout=()=>{};try{t.send(e)}catch(e){}}destroy(){this.isDestroyed=!0,this.reportTimer&&(clearInterval(this.reportTimer),this.reportTimer=null),this.flushAllQueues(),this.retryQueue=[]}getQueueStatus(){return{high:this.highPriorityQueue.length,medium:this.mediumPriorityQueue.length,low:this.lowPriorityQueue.length,retry:this.retryQueue.length,pending:this.pendingRequests}}flush(){this.processQueuedData()}}function u(e){const t=[];let r=e;for(;r&&r.nodeType===Node.ELEMENT_NODE;){let e=r.nodeName.toLowerCase();if(r.id){e+=`#${r.id}`,t.unshift(e);break}{let t=1,o=r.previousElementSibling;for(;o;)o.nodeName.toLowerCase()===e&&t++,o=o.previousElementSibling;t>1&&(e+=`:nth-child(${t})`)}t.unshift(e),r=r.parentElement}return t.join(" > ")}class c{constructor(e){this.breadcrumbs=[],this.plugins=new Map,this.isDestroyed=!1,this.config=this.mergeConfig(e),this.sessionId=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,this.userId=function(){const e=localStorage.getItem("web_monitor_user_id");if(e)return e;const t=`user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{localStorage.setItem("web_monitor_user_id",t)}catch(e){}return t}(),this.transport=new s({url:this.config.reportUrl,reportInterval:this.config.reportInterval,batchSize:this.config.batchSize,maxQueueSize:this.config.maxQueueSize,enableImmediateReport:this.config.enableImmediateReport}),this.init()}mergeConfig(e){var t,r,o,i,n,a,s,u,c,l,d;return{appId:e.appId,reportUrl:e.reportUrl,sampling:null!==(t=e.sampling)&&void 0!==t?t:1,debug:null!==(r=e.debug)&&void 0!==r&&r,enablePerformance:null===(o=e.enablePerformance)||void 0===o||o,enableError:null===(i=e.enableError)||void 0===i||i,enableBehavior:null===(n=e.enableBehavior)||void 0===n||n,maxBreadcrumbsNum:null!==(a=e.maxBreadcrumbsNum)&&void 0!==a?a:20,beforeSend:null!==(s=e.beforeSend)&&void 0!==s?s:e=>e,reportInterval:null!==(u=e.reportInterval)&&void 0!==u?u:6e4,batchSize:null!==(c=e.batchSize)&&void 0!==c?c:10,maxQueueSize:null!==(l=e.maxQueueSize)&&void 0!==l?l:100,enableImmediateReport:null===(d=e.enableImmediateReport)||void 0===d||d}}init(){this.shouldSample()&&this.setupErrorHandling()}shouldSample(){return Math.random()<this.config.sampling}setupErrorHandling(){const e=console.error;console.error=(...t)=>{try{e.apply(console,t)}catch(e){}},window.addEventListener("error",e=>{this.safeExecute(()=>{})}),window.addEventListener("unhandledrejection",e=>{this.safeExecute(()=>{})})}safeExecute(e){try{this.isDestroyed||e()}catch(e){this.config.debug}}addBreadcrumb(e){this.breadcrumbs.length>=this.config.maxBreadcrumbsNum&&this.breadcrumbs.shift(),this.breadcrumbs.push(e)}report(e){this.safeExecute(()=>{const t={appId:this.config.appId,timestamp:Date.now(),sessionId:this.sessionId,userId:this.userId,url:window.location.href,userAgent:navigator.userAgent,breadcrumbs:[...this.breadcrumbs],...e},r=this.config.beforeSend(t);r&&(this.transport.send(r),this.config.debug)})}use(e){this.plugins.has(e.name)||(this.plugins.set(e.name,e),e.install(this))}unuse(e){const t=this.plugins.get(e);t&&t.uninstall&&t.uninstall(this),this.plugins.delete(e)}destroy(){this.isDestroyed=!0,this.transport.destroy(),this.plugins.forEach(e=>{e.uninstall&&e.uninstall(this)}),this.plugins.clear(),this.breadcrumbs=[]}get isDebug(){return this.config.debug}get appId(){return this.config.appId}get currentSessionId(){return this.sessionId}get currentUserId(){return this.userId}}var l,d,p,h,m=-1,y=function(e){addEventListener("pageshow",function(t){t.persisted&&(m=t.timeStamp,e(t))},!0)},g=function(){return window.performance&&performance.getEntriesByType&&performance.getEntriesByType("navigation")[0]},f=function(){var e=g();return e&&e.activationStart||0},v=function(e,t){var r=g(),o="navigate";return m>=0?o="back-forward-cache":r&&(document.prerendering||f()>0?o="prerender":document.wasDiscarded?o="restore":r.type&&(o=r.type.replace(/_/g,"-"))),{name:e,value:void 0===t?-1:t,rating:"good",delta:0,entries:[],id:"v3-".concat(Date.now(),"-").concat(Math.floor(8999999999999*Math.random())+1e12),navigationType:o}},R=function(e,t,r){try{if(PerformanceObserver.supportedEntryTypes.includes(e)){var o=new PerformanceObserver(function(e){Promise.resolve().then(function(){t(e.getEntries())})});return o.observe(Object.assign({type:e,buffered:!0},r||{})),o}}catch(e){}},w=function(e,t,r,o){var i,n;return function(a){t.value>=0&&(a||o)&&((n=t.value-(i||0))||void 0===i)&&(i=t.value,t.delta=n,t.rating=function(e,t){return e>t[1]?"poor":e>t[0]?"needs-improvement":"good"}(t.value,r),e(t))}},E=function(e){requestAnimationFrame(function(){return requestAnimationFrame(function(){return e()})})},T=function(e){var t=function(t){"pagehide"!==t.type&&"hidden"!==document.visibilityState||e(t)};addEventListener("visibilitychange",t,!0),addEventListener("pagehide",t,!0)},b=function(e){var t=!1;return function(r){t||(e(r),t=!0)}},S=-1,P=function(){return"hidden"!==document.visibilityState||document.prerendering?1/0:0},I=function(e){"hidden"===document.visibilityState&&S>-1&&(S="visibilitychange"===e.type?e.timeStamp:0,C())},D=function(){addEventListener("visibilitychange",I,!0),addEventListener("prerenderingchange",I,!0)},C=function(){removeEventListener("visibilitychange",I,!0),removeEventListener("prerenderingchange",I,!0)},O=function(){return S<0&&(S=P(),D(),y(function(){setTimeout(function(){S=P(),D()},0)})),{get firstHiddenTime(){return S}}},_=function(e){document.prerendering?addEventListener("prerenderingchange",function(){return e()},!0):e()},M=[1800,3e3],B=function(e,t){t=t||{},_(function(){var r,o=O(),i=v("FCP"),n=R("paint",function(e){e.forEach(function(e){"first-contentful-paint"===e.name&&(n.disconnect(),e.startTime<o.firstHiddenTime&&(i.value=Math.max(e.startTime-f(),0),i.entries.push(e),r(!0)))})});n&&(r=w(e,i,M,t.reportAllChanges),y(function(o){i=v("FCP"),r=w(e,i,M,t.reportAllChanges),E(function(){i.value=performance.now()-o.timeStamp,r(!0)})}))})},L=[.1,.25],A={passive:!0,capture:!0},Q=new Date,H=function(e,t){l||(l=t,d=e,p=new Date,$(removeEventListener),k())},k=function(){if(d>=0&&d<p-Q){var e={entryType:"first-input",name:l.type,target:l.target,cancelable:l.cancelable,startTime:l.timeStamp,processingStart:l.timeStamp+d};h.forEach(function(t){t(e)}),h=[]}},N=function(e){if(e.cancelable){var t=(e.timeStamp>1e12?new Date:performance.now())-e.timeStamp;"pointerdown"==e.type?function(e,t){var r=function(){H(e,t),i()},o=function(){i()},i=function(){removeEventListener("pointerup",r,A),removeEventListener("pointercancel",o,A)};addEventListener("pointerup",r,A),addEventListener("pointercancel",o,A)}(t,e):H(t,e)}},$=function(e){["mousedown","keydown","touchstart","pointerdown"].forEach(function(t){return e(t,N,A)})},U=[100,300],x=[2500,4e3],F={},V=[800,1800],q=function e(t){document.prerendering?_(function(){return e(t)}):"complete"!==document.readyState?addEventListener("load",function(){return e(t)},!0):setTimeout(t,0)},X=function(e,t){t=t||{};var r=v("TTFB"),o=w(e,r,V,t.reportAllChanges);q(function(){var i=g();if(i){var n=i.responseStart;if(n<=0||n>performance.now())return;r.value=Math.max(n-f(),0),r.entries=[i],o(!0),y(function(){r=v("TTFB",0),(o=w(e,r,V,t.reportAllChanges))(!0)})}})};class z{constructor(e){this.observer=null,this.monitor=e,this.init()}init(){this.collectWebVitals(),this.collectNavigationTiming(),this.collectResourceTiming(),this.collectAPITiming()}collectWebVitals(){!function(e,t){t=t||{},_(function(){var r,o=O(),i=v("LCP"),n=function(e){var t=e[e.length-1];t&&t.startTime<o.firstHiddenTime&&(i.value=Math.max(t.startTime-f(),0),i.entries=[t],r())},a=R("largest-contentful-paint",n);if(a){r=w(e,i,x,t.reportAllChanges);var s=b(function(){F[i.id]||(n(a.takeRecords()),a.disconnect(),F[i.id]=!0,r(!0))});["keydown","click"].forEach(function(e){addEventListener(e,function(){return setTimeout(s,0)},!0)}),T(s),y(function(o){i=v("LCP"),r=w(e,i,x,t.reportAllChanges),E(function(){i.value=performance.now()-o.timeStamp,F[i.id]=!0,r(!0)})})}})}(t=>{this.reportMetric({type:e.PerformanceType.LCP,name:"LCP",value:t.value,rating:t.rating,delta:t.delta,entries:t.entries})}),function(e,t){t=t||{},_(function(){var r,o=O(),i=v("FID"),n=function(e){e.startTime<o.firstHiddenTime&&(i.value=e.processingStart-e.startTime,i.entries.push(e),r(!0))},a=function(e){e.forEach(n)},s=R("first-input",a);r=w(e,i,U,t.reportAllChanges),s&&T(b(function(){a(s.takeRecords()),s.disconnect()})),s&&y(function(){var o;i=v("FID"),r=w(e,i,U,t.reportAllChanges),h=[],d=-1,l=null,$(addEventListener),o=n,h.push(o),k()})})}(t=>{this.reportMetric({type:e.PerformanceType.FID,name:"FID",value:t.value,rating:t.rating,delta:t.delta,entries:t.entries})}),function(e,t){t=t||{},B(b(function(){var r,o=v("CLS",0),i=0,n=[],a=function(e){e.forEach(function(e){if(!e.hadRecentInput){var t=n[0],r=n[n.length-1];i&&e.startTime-r.startTime<1e3&&e.startTime-t.startTime<5e3?(i+=e.value,n.push(e)):(i=e.value,n=[e])}}),i>o.value&&(o.value=i,o.entries=n,r())},s=R("layout-shift",a);s&&(r=w(e,o,L,t.reportAllChanges),T(function(){a(s.takeRecords()),r(!0)}),y(function(){i=0,o=v("CLS",0),r=w(e,o,L,t.reportAllChanges),E(function(){return r()})}),setTimeout(r,0))}))}(t=>{this.reportMetric({type:e.PerformanceType.CLS,name:"CLS",value:t.value,rating:t.rating,delta:t.delta,entries:t.entries})}),B(t=>{this.reportMetric({type:e.PerformanceType.FCP,name:"FCP",value:t.value,rating:t.rating,delta:t.delta,entries:t.entries})}),X(t=>{this.reportMetric({type:e.PerformanceType.TTFB,name:"TTFB",value:t.value,rating:t.rating,delta:t.delta,entries:t.entries})})}collectNavigationTiming(){window.addEventListener("load",()=>{setTimeout(()=>{const t=performance.getEntriesByType("navigation")[0];if(!t)return;const r={dnsLookup:t.domainLookupEnd-t.domainLookupStart,tcpConnect:t.connectEnd-t.connectStart,sslConnect:t.secureConnectionStart>0?t.connectEnd-t.secureConnectionStart:0,request:t.responseStart-t.requestStart,response:t.responseEnd-t.responseStart,domParse:t.domInteractive-t.responseEnd,domContentLoaded:t.domContentLoadedEventEnd-t.fetchStart,loadComplete:t.loadEventEnd-t.fetchStart,firstPaint:this.getFirstPaint(),firstContentfulPaint:this.getFirstContentfulPaint()};this.reportMetric({type:e.PerformanceType.NAVIGATION,name:"Navigation Timing",value:r.loadComplete,entries:[t],navigationType:this.getNavigationType("number"==typeof t.type?t.type:0)}),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.PERFORMANCE,category:"navigation",message:"Page loaded",level:"info",data:r})},0)})}collectResourceTiming(){if(PerformanceObserver)try{this.observer=new PerformanceObserver(t=>{t.getEntries().forEach(t=>{if("resource"===t.entryType){const r=t;if(r.name.includes(this.monitor.appId))return;this.reportMetric({type:e.PerformanceType.RESOURCE,name:r.name,value:r.duration,entries:[t]}),r.duration>3e3&&this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.PERFORMANCE,category:"resource",message:`Slow resource: ${r.name}`,level:"warning",data:{duration:r.duration,size:r.transferSize||0}})}})}),this.observer.observe({entryTypes:["resource"]})}catch(e){}}collectAPITiming(){const t=window.fetch;window.fetch=async(...r)=>{const o=performance.now(),i="string"==typeof r[0]?r[0]:r[0].url;try{const n=await t.apply(window,r),a=performance.now()-o;return this.reportMetric({type:e.PerformanceType.API,name:i,value:a,entries:[]}),a>2e3&&this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.PERFORMANCE,category:"api",message:`Slow API: ${i}`,level:"warning",data:{duration:a,status:n.status}}),n}catch(t){const r=performance.now()-o;throw this.reportMetric({type:e.PerformanceType.API,name:i,value:r,entries:[]}),t}};const r=XMLHttpRequest.prototype.open,o=XMLHttpRequest.prototype.send,i=this;XMLHttpRequest.prototype.open=function(e,t,o,i,n){return this._monitor_url=t.toString(),this._monitor_startTime=performance.now(),r.call(this,e,t,null==o||o,i,n)},XMLHttpRequest.prototype.send=function(t){const r=this,n=r._monitor_startTime,a=r._monitor_url;return r.addEventListener("readystatechange",()=>{if(4===r.readyState){const t=performance.now()-n;i&&a&&(i.reportMetric({type:e.PerformanceType.API,name:a,value:t,entries:[]}),t>2e3&&i.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.PERFORMANCE,category:"api",message:`Slow XHR: ${a}`,level:"warning",data:{duration:t,status:r.status}}))}}),o.call(this,t)}}getFirstPaint(){const e=performance.getEntriesByType("paint").find(e=>"first-paint"===e.name);return e?e.startTime:0}getFirstContentfulPaint(){const e=performance.getEntriesByType("paint").find(e=>"first-contentful-paint"===e.name);return e?e.startTime:0}getNavigationType(e){return["navigate","reload","back_forward","prerender"][e]||"unknown"}reportMetric(t){this.monitor.report({type:e.DataType.PERFORMANCE,data:t})}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null)}}class G{constructor(e){this.monitor=e,this.originalFetch=window.fetch,this.originalXHROpen=XMLHttpRequest.prototype.open,this.originalXHRSend=XMLHttpRequest.prototype.send,this.init()}init(){this.handleJSError(),this.handlePromiseError(),this.handleResourceError(),this.handleAPIError()}handleJSError(){window.addEventListener("error",t=>{const{message:r,filename:o,lineno:i,colno:n,error:a}=t,s={type:e.ErrorType.JS_ERROR,message:r||"Unknown error",filename:o,lineno:i,colno:n,stack:null==a?void 0:a.stack};this.reportError(s),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"javascript",message:`JS Error: ${r}`,level:"error",data:{filename:o,lineno:i,colno:n}})},!0)}handlePromiseError(){window.addEventListener("unhandledrejection",t=>{let r="Unhandled Promise Rejection",o="";if(t.reason)if(t.reason instanceof Error)r=t.reason.message,o=t.reason.stack||"";else if("string"==typeof t.reason)r=t.reason;else try{r=JSON.stringify(t.reason)}catch(e){r=String(t.reason)}const i={type:e.ErrorType.PROMISE_ERROR,message:r,stack:o};this.reportError(i),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"promise",message:`Promise Error: ${r}`,level:"error",data:{reason:t.reason}})})}handleResourceError(){window.addEventListener("error",t=>{const r=t.target;if(r&&r!==window&&("IMG"===r.tagName||"SCRIPT"===r.tagName||"LINK"===r.tagName||"AUDIO"===r.tagName||"VIDEO"===r.tagName)){const t={type:e.ErrorType.RESOURCE_ERROR,message:`Resource load error: ${r.tagName}`,resourceUrl:r.src||r.href||"",elementSelector:u(r)};this.reportError(t),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"resource",message:`Resource Error: ${r.tagName}`,level:"error",data:{url:t.resourceUrl,element:r.tagName}})}},!0)}handleAPIError(){window.fetch=async(...t)=>{const r="string"==typeof t[0]?t[0]:t[0].url,o=Date.now();try{const i=await this.originalFetch.apply(window,t);if(!i.ok){const t={type:e.ErrorType.API_ERROR,message:`API Error: ${i.status} ${i.statusText}`,resourceUrl:r,statusCode:i.status};this.reportError(t),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"api",message:`API Error: ${r}`,level:"error",data:{status:i.status,statusText:i.statusText,duration:Date.now()-o}})}return i}catch(t){const i={type:e.ErrorType.API_ERROR,message:`Network Error: ${t instanceof Error?t.message:"Unknown error"}`,resourceUrl:r,stack:t instanceof Error?t.stack:void 0};throw this.reportError(i),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"api",message:`Network Error: ${r}`,level:"error",data:{error:t instanceof Error?t.message:String(t),duration:Date.now()-o}}),t}};const t=this;XMLHttpRequest.prototype.open=function(e,r,o,i,n){return this._monitor_url=r.toString(),this._monitor_method=e,this._monitor_startTime=Date.now(),t.originalXHROpen.call(this,e,r,null==o||o,i,n)},XMLHttpRequest.prototype.send=function(r){const o=this,i=o._monitor_url,n=o._monitor_method,a=o._monitor_startTime;return o.addEventListener("error",()=>{const r={type:e.ErrorType.API_ERROR,message:`XMLHttpRequest Error: ${n} ${i}`,resourceUrl:i,statusCode:o.status};t.reportError(r),t.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"api",message:`XHR Error: ${n} ${i}`,level:"error",data:{method:n,status:o.status,duration:Date.now()-a}})}),o.addEventListener("load",()=>{if(o.status>=400){const r={type:e.ErrorType.API_ERROR,message:`API Error: ${o.status} ${o.statusText}`,resourceUrl:i,statusCode:o.status};t.reportError(r),t.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"api",message:`XHR ${o.status}: ${n} ${i}`,level:"error",data:{method:n,status:o.status,statusText:o.statusText,duration:Date.now()-a}})}}),t.originalXHRSend.call(this,r)}}reportError(t){this.monitor.report({type:e.DataType.ERROR,data:t})}reportCustomError(t,r){const o={type:e.ErrorType.CUSTOM_ERROR,message:t,stack:(new Error).stack,...r};this.reportError(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"custom",message:`Custom Error: ${t}`,level:"error",data:r})}destroy(){window.fetch=this.originalFetch,XMLHttpRequest.prototype.open=this.originalXHROpen,XMLHttpRequest.prototype.send=this.originalXHRSend}}class j{constructor(e){this.monitor=e,this.currentUrl=window.location.href,this.startTime=Date.now(),this.init()}init(){this.trackPageView(),this.trackClicks(),this.trackInputs(),this.trackScrolls(),this.trackRouteChanges()}trackPageView(){const t={type:e.BehaviorType.PAGE_VIEW,url:this.currentUrl};this.reportBehavior(t),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.BEHAVIOR,category:"navigation",message:`Page view: ${this.currentUrl}`,level:"info",data:{url:this.currentUrl,referrer:document.referrer}})}trackClicks(){document.addEventListener("click",t=>{const r=t.target;if(!r)return;const o={type:e.BehaviorType.CLICK,element:r.tagName,selector:u(r),text:(i=r,"INPUT"===i.tagName?i.value||i.placeholder||"":(null===(n=i.textContent)||void 0===n?void 0:n.trim().slice(0,100))||"")};var i,n;this.reportBehavior(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.BEHAVIOR,category:"interaction",message:`Click: ${r.tagName}`,level:"info",data:{text:o.text,selector:o.selector}})},!0)}trackInputs(){const t=function(e,t){let r=null;return function(...o){const i=this;r&&clearTimeout(r),r=window.setTimeout(()=>{e.apply(i,o),r=null},t)}}(t=>{const r=t.target;if(!r||"password"===r.type)return;const o={type:e.BehaviorType.INPUT,element:r.tagName,selector:u(r),text:"password"===r.type?"***":r.value.slice(0,100)};this.reportBehavior(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.BEHAVIOR,category:"interaction",message:`Input: ${r.tagName}`,level:"info",data:{type:r.type,selector:o.selector}})},500);document.addEventListener("input",t,!0),document.addEventListener("change",t,!0)}trackScrolls(){let t=0;const r=function(e,t){let r=null,o=0;return function(...i){const n=Date.now(),a=this;n-o>t?(e.apply(a,i),o=n):(r&&clearTimeout(r),r=window.setTimeout(()=>{e.apply(a,i),o=Date.now(),r=null},t-(n-o)))}}(()=>{const r=window.pageYOffset||document.documentElement.scrollTop,o=window.innerHeight,i=document.documentElement.scrollHeight,n=Math.round((r+o)/i*100);if(n>t&&(t=n,n>=25&&n%25==0)){const t={type:e.BehaviorType.SCROLL,text:`${n}%`};this.reportBehavior(t),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.BEHAVIOR,category:"interaction",message:`Scroll: ${n}%`,level:"info",data:{depth:n,scrollTop:r,documentHeight:i}})}},1e3);window.addEventListener("scroll",r,{passive:!0})}trackRouteChanges(){const t=history.pushState,r=history.replaceState,o=(t,r)=>{const o=Date.now()-this.startTime,i={type:e.BehaviorType.ROUTE_CHANGE,from:t,to:r,duration:o};this.reportBehavior(i),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.BEHAVIOR,category:"navigation",message:`Route change: ${t} -> ${r}`,level:"info",data:{from:t,to:r,duration:o}}),this.currentUrl=r,this.startTime=Date.now()};history.pushState=function(e,r,i){const n=window.location.href,a=t.apply(this,arguments),s=window.location.href;return n!==s&&o(n,s),a},history.replaceState=function(e,t,i){const n=window.location.href,a=r.apply(this,arguments),s=window.location.href;return n!==s&&o(n,s),a},window.addEventListener("popstate",()=>{const e=window.location.href;o(this.currentUrl,e)}),window.addEventListener("hashchange",()=>{const e=window.location.href;o(this.currentUrl,e)})}reportCustomBehavior(t,r){const o={type:t,...r};this.reportBehavior(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.BEHAVIOR,category:"custom",message:`Custom behavior: ${t}`,level:"info",data:r})}reportBehavior(t){this.monitor.report({type:e.DataType.BEHAVIOR,data:t})}destroy(){}}const J={name:"vue",install(t){if("undefined"!=typeof window&&window.Vue){window.Vue.config.errorHandler=(r,o,i)=>{var n,a;const s={type:e.ErrorType.JS_ERROR,message:r.message,stack:r.stack,source:`Vue ${i}`,filename:(null===(n=null==o?void 0:o.$options)||void 0===n?void 0:n.__file)||"Vue Component"};t.report({type:e.DataType.ERROR,data:s}),t.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"vue",message:`Vue Error: ${r.message}`,level:"error",data:{info:i,component:(null===(a=null==o?void 0:o.$options)||void 0===a?void 0:a.name)||"Anonymous Component"}})}}if("undefined"!=typeof window&&window.Vue&&window.Vue.version&&window.Vue.version.startsWith("3")){window.Vue.createApp({}).config.errorHandler=(r,o,i)=>{var n,a;const s={type:e.ErrorType.JS_ERROR,message:r.message,stack:r.stack,source:`Vue3 ${i}`,filename:(null===(n=null==o?void 0:o.$options)||void 0===n?void 0:n.__file)||"Vue3 Component"};t.report({type:e.DataType.ERROR,data:s}),t.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"vue3",message:`Vue3 Error: ${r.message}`,level:"error",data:{info:i,component:(null===(a=null==o?void 0:o.type)||void 0===a?void 0:a.name)||"Anonymous Component"}})}}}},K={name:"react",install(t){if("undefined"!=typeof window&&window.React){const r=window.React.createElement;window.React.createElement=function(o,i,...n){if("function"==typeof o&&o.prototype&&o.prototype.isReactComponent){const r=o.prototype.componentDidCatch;o.prototype.componentDidCatch=function(i,n){const a={type:e.ErrorType.JS_ERROR,message:i.message,stack:i.stack,source:"React Component",filename:n.componentStack};t.report({type:e.DataType.ERROR,data:a}),t.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"react",message:`React Error: ${i.message}`,level:"error",data:{componentStack:n.componentStack,component:o.name||"Anonymous Component"}}),r&&r.call(this,i,n)}}return r.apply(this,arguments)}}if("undefined"!=typeof window&&window.ReactDOM&&window.ReactDOM.createRoot){const r=window.ReactDOM.createRoot;window.ReactDOM.createRoot=function(o,i={}){const n={...i,onRecoverableError:(r,o)=>{const n={type:e.ErrorType.JS_ERROR,message:r.message,stack:r.stack,source:"React Recoverable Error"};t.report({type:e.DataType.ERROR,data:n}),t.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"react",message:`React Recoverable Error: ${r.message}`,level:"warning",data:o}),i.onRecoverableError&&i.onRecoverableError(r,o)}};return r.call(this,o,n)}}}};class WebMonitorSDK{constructor(e){this.isInitialized=!1,/bot|crawler|spider|crawling/i.test(navigator.userAgent)?this.monitor={}:(this.monitor=new c(e),this.init(),window.__webMonitorSDK=this)}init(){if(!this.isInitialized)try{this.monitor.config.enablePerformance&&(this.performanceMonitor=new z(this.monitor)),this.monitor.config.enableError&&(this.errorMonitor=new G(this.monitor)),this.monitor.config.enableBehavior&&(this.behaviorMonitor=new j(this.monitor)),this.isInitialized=!0,this.monitor.isDebug}catch(e){}}reportError(e,t){this.errorMonitor&&this.errorMonitor.reportCustomError(e,t)}reportBehavior(e,t){this.behaviorMonitor&&this.behaviorMonitor.reportCustomBehavior(e,t)}report(e){this.monitor.report(e)}use(e){return this.monitor.use(e),this}unuse(e){return this.monitor.unuse(e),this}setUser(e,t){this.monitor.userId=e,this.monitor.addBreadcrumb({timestamp:Date.now(),type:"behavior",category:"user",message:`User set: ${e}`,level:"info",data:t})}setTag(e,t){this.monitor.tags||(this.monitor.tags={}),this.monitor.tags[e]=t}setContext(e,t){this.monitor.contexts||(this.monitor.contexts={}),this.monitor.contexts[e]=t}destroy(){var e,t,r;this.isInitialized&&(null===(e=this.performanceMonitor)||void 0===e||e.destroy(),null===(t=this.errorMonitor)||void 0===t||t.destroy(),null===(r=this.behaviorMonitor)||void 0===r||r.destroy(),this.monitor.destroy(),this.isInitialized=!1,delete window.__webMonitorSDK,this.monitor.isDebug)}getConfig(){return this.monitor.config}getSessionId(){return this.monitor.currentSessionId}getUserId(){return this.monitor.currentUserId}}e.ReactPlugin=K,e.VuePlugin=J,e.WebMonitorSDK=WebMonitorSDK,e.createWebMonitorSDK=function(e){return new WebMonitorSDK(e)},e.default=WebMonitorSDK,Object.defineProperty(e,"__esModule",{value:!0})});
