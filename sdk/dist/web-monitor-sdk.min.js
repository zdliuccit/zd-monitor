!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).WebMonitorSDK={})}(this,function(e){"use strict";class t{constructor(){this.STORAGE_KEY="web_monitor_queue",this.TIMER_KEY="web_monitor_timer",this.MAX_STORAGE_SIZE=1048576}save(e){if(!this.isLocalStorageAvailable())return!1;try{const t=JSON.stringify(e);return!(t.length>this.MAX_STORAGE_SIZE)&&(localStorage.setItem(this.STORAGE_KEY,t),!0)}catch(e){return!1}}load(){if(!this.isLocalStorageAvailable())return[];try{const e=localStorage.getItem(this.STORAGE_KEY);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return this.clear(),[]}}clear(){if(this.isLocalStorageAvailable())try{localStorage.removeItem(this.STORAGE_KEY)}catch(e){}}isLocalStorageAvailable(){try{const e="__localStorage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}getStorageSize(){if(!this.isLocalStorageAvailable())return 0;try{const e=localStorage.getItem(this.STORAGE_KEY);return e?e.length:0}catch(e){return 0}}saveLastReportTime(e){if(!this.isLocalStorageAvailable())return!1;try{return localStorage.setItem(this.TIMER_KEY,e.toString()),!0}catch(e){return!1}}getLastReportTime(){if(!this.isLocalStorageAvailable())return 0;try{const e=localStorage.getItem(this.TIMER_KEY);return e?parseInt(e,10):0}catch(e){return 0}}clearTimer(){if(this.isLocalStorageAvailable())try{localStorage.removeItem(this.TIMER_KEY)}catch(e){}}getRawData(){if(!this.isLocalStorageAvailable())return null;try{return localStorage.getItem(this.STORAGE_KEY)}catch(e){return null}}getDebugInfo(){const e=this.load(),t=this.getRawData();return{hasData:e.length>0,dataCount:e.length,storageSize:t?t.length:0,lastReportTime:this.getLastReportTime(),data:e.length>0?e:null}}logStorageData(){const e=this.getDebugInfo();if(e.lastReportTime>0){new Date(e.lastReportTime)}e.data&&e.data.length>0&&e.data.forEach((e,t)=>{})}}class r{constructor(e){var r,o,a,n,i,s,c,l,h;this.dataQueue=[],this.reportTimer=null,this.isDestroyed=!1,this.pendingRequests=0,this.retryQueue=[],this.options={url:e.url,timeout:null!==(r=e.timeout)&&void 0!==r?r:5e3,withCredentials:null!==(o=e.withCredentials)&&void 0!==o&&o,headers:null!==(a=e.headers)&&void 0!==a?a:{},reportInterval:null!==(n=e.reportInterval)&&void 0!==n?n:6e4,batchSize:null!==(i=e.batchSize)&&void 0!==i?i:10,maxQueueSize:null!==(s=e.maxQueueSize)&&void 0!==s?s:100,enableImmediateReport:null===(c=e.enableImmediateReport)||void 0===c||c,retryCount:null!==(l=e.retryCount)&&void 0!==l?l:3,retryInterval:null!==(h=e.retryInterval)&&void 0!==h?h:1e3},this.storageManager=new t,this.loadDataFromStorage(),this.startReportTimer(),this.setupBeforeUnload(),this.startRetryTimer()}loadDataFromStorage(){const e=this.storageManager.load();this.dataQueue.push(...e),this.storageManager.clear()}saveDataToStorage(){this.dataQueue.length>0&&this.storageManager.save(this.dataQueue)}startReportTimer(){const e=Date.now(),t=this.storageManager.getLastReportTime();let r=this.options.reportInterval;if(t>0){const o=e-t;r=o<this.options.reportInterval?this.options.reportInterval-o:0}r<=0&&(this.processQueuedData(),r=this.options.reportInterval),this.reportTimer=window.setInterval(()=>{this.processQueuedData()},this.options.reportInterval),r!==this.options.reportInterval&&setTimeout(()=>{this.processQueuedData()},r)}startRetryTimer(){setInterval(()=>{this.processRetryQueue()},this.options.retryInterval)}setupBeforeUnload(){window.addEventListener("beforeunload",()=>{this.saveDataToStorage(),this.flushAllQueues()}),window.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&(this.saveDataToStorage(),this.flushAllQueues())})}flushAllQueues(){this.dataQueue.length>0&&(this.trySendBeacon(this.dataQueue),this.dataQueue=[])}send(e){this.isDestroyed||(this.dataQueue.push(e),this.checkQueueOverflow())}processQueuedData(){if(this.isDestroyed||this.pendingRequests>3)return;const e=this.dataQueue.length>0;if(this.dataQueue.length>0){const e=this.dataQueue.splice(0,this.options.batchSize);this.sendBatch(e),this.storageManager.saveLastReportTime(Date.now())}e&&this.storageManager.clear()}sendBatch(e){if(this.isDestroyed)return;this.pendingRequests++;const t=JSON.stringify(e),r=this.sendFetch(t).catch(()=>this.sendXHR(t));Promise.resolve(r).then(()=>{var e;this.pendingRequests--,null===(e=this.options.headers)||void 0===e||e.debug}).catch(()=>{this.pendingRequests--,this.addToRetryQueue(e)})}trySendBeacon(e){if(!navigator.sendBeacon)return null;try{const t=JSON.stringify(e),r=new Blob([t],{type:"application/json"});return navigator.sendBeacon(this.options.url,r)?Promise.resolve():Promise.reject(new Error("SendBeacon failed"))}catch(e){return Promise.reject(e)}}checkQueueOverflow(){this.dataQueue.length>=this.options.maxQueueSize&&this.processQueuedData()}addToRetryQueue(e){const t={data:e,retryCount:0,nextRetryTime:Date.now()+this.options.retryInterval};this.retryQueue.push(t)}processRetryQueue(){if(0===this.retryQueue.length||this.pendingRequests>3)return;const e=Date.now();this.retryQueue.filter(t=>e>=t.nextRetryTime).forEach(t=>{if(t.retryCount<this.options.retryCount)t.retryCount++,t.nextRetryTime=e+this.options.retryInterval*Math.pow(2,t.retryCount),this.sendBatch(t.data);else{const e=this.retryQueue.indexOf(t);e>-1&&this.retryQueue.splice(e,1)}})}async sendFetch(e){const t=new AbortController,r=setTimeout(()=>t.abort(),this.options.timeout);try{await fetch(this.options.url,{method:"POST",headers:{"Content-Type":"application/json",...this.options.headers},body:e,credentials:this.options.withCredentials?"include":"omit",signal:t.signal})}finally{clearTimeout(r)}}sendXHR(e){const t=new XMLHttpRequest;t.open("POST",this.options.url,!0),t.timeout=this.options.timeout,t.withCredentials=this.options.withCredentials,t.setRequestHeader("Content-Type","application/json"),Object.entries(this.options.headers).forEach(([e,r])=>{t.setRequestHeader(e,r)}),t.onerror=()=>{},t.ontimeout=()=>{};try{t.send(e)}catch(e){}}destroy(){this.isDestroyed=!0,this.reportTimer&&(clearInterval(this.reportTimer),this.reportTimer=null),this.flushAllQueues(),this.retryQueue=[],this.storageManager.clearTimer()}getQueueStatus(){return{queue:this.dataQueue.length,retry:this.retryQueue.length,pending:this.pendingRequests}}flush(){this.processQueuedData()}getStorageManager(){return this.storageManager}getDebugInfo(){return{isDestroyed:this.isDestroyed,queueStatus:this.getQueueStatus(),storageInfo:this.storageManager.getDebugInfo(),options:{...this.options}}}logDebugInfo(){const e=this.getDebugInfo();if(e.storageInfo.lastReportTime>0){new Date(e.storageInfo.lastReportTime),Date.now(),e.storageInfo.lastReportTime}e.storageInfo.hasData}}function o(e){const t=[];let r=e;for(;r&&r.nodeType===Node.ELEMENT_NODE;){let e=r.nodeName.toLowerCase();if(r.id){e+=`#${r.id}`,t.unshift(e);break}{let t=1,o=r.previousElementSibling;for(;o;)o.nodeName.toLowerCase()===e&&t++,o=o.previousElementSibling;t>1&&(e+=`:nth-child(${t})`)}t.unshift(e),r=r.parentElement}return t.join(" > ")}function a(){const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;return e&&(e.effectiveType||e.type)||"unknown"}class n{constructor(e){this.breadcrumbs=[],this.plugins=new Map,this.isDestroyed=!1,this.config=this.mergeConfig(e),this.sessionId=function(){const e=localStorage.getItem("web_monitor_session_id");if(e)return e;const t=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{localStorage.setItem("web_monitor_session_id",t)}catch(e){}return t}(),this._transport=new r({url:this.config.reportUrl,reportInterval:this.config.reportInterval,batchSize:this.config.batchSize,maxQueueSize:this.config.maxQueueSize,enableImmediateReport:this.config.enableImmediateReport}),this.init()}mergeConfig(e){var t,r,o,a,n,i,s,c,l,h,u,d,p,m,g,f,y;return{appId:e.appId,reportUrl:e.reportUrl,sampling:null!==(t=e.sampling)&&void 0!==t?t:1,debug:null!==(r=e.debug)&&void 0!==r&&r,enablePerformance:null===(o=e.enablePerformance)||void 0===o||o,enableError:null===(a=e.enableError)||void 0===a||a,enableBehavior:null===(n=e.enableBehavior)||void 0===n||n,maxBreadcrumbsNum:null!==(i=e.maxBreadcrumbsNum)&&void 0!==i?i:20,beforeSend:null!==(s=e.beforeSend)&&void 0!==s?s:e=>e,reportInterval:null!==(c=e.reportInterval)&&void 0!==c?c:6e4,batchSize:null!==(l=e.batchSize)&&void 0!==l?l:10,maxQueueSize:null!==(h=e.maxQueueSize)&&void 0!==h?h:100,enableImmediateReport:null===(u=e.enableImmediateReport)||void 0===u||u,performance:{enableBatch:null===(p=null===(d=e.performance)||void 0===d?void 0:d.enableBatch)||void 0===p||p,batchInterval:null!==(g=null===(m=e.performance)||void 0===m?void 0:m.batchInterval)&&void 0!==g?g:5e3,batchSize:null!==(y=null===(f=e.performance)||void 0===f?void 0:f.batchSize)&&void 0!==y?y:10}}}init(){this.shouldSample()&&this.setupErrorHandling()}shouldSample(){return Math.random()<this.config.sampling}setupErrorHandling(){const e=console.error;console.error=(...t)=>{try{e.apply(console,t)}catch(e){}},window.addEventListener("error",()=>{this.safeExecute(()=>{})}),window.addEventListener("unhandledrejection",()=>{this.safeExecute(()=>{})})}safeExecute(e){try{this.isDestroyed||e()}catch(e){this.config.debug}}addBreadcrumb(e){this.breadcrumbs.length>=this.config.maxBreadcrumbsNum&&this.breadcrumbs.shift(),this.breadcrumbs.push(e)}report(e){this.safeExecute(()=>{const t={appId:this.config.appId,timestamp:Date.now(),sessionId:this.sessionId,url:window.location.href,userAgent:navigator.userAgent,connectionType:a(),breadcrumbs:[...this.breadcrumbs],...e},r=this.config.beforeSend(t);r&&(this._transport.send(r),this.config.debug)})}use(e){this.plugins.has(e.name)||(this.plugins.set(e.name,e),e.install(this))}unuse(e){const t=this.plugins.get(e);t&&t.uninstall&&t.uninstall(this),this.plugins.delete(e)}destroy(){this.isDestroyed=!0,this._transport.destroy(),this.plugins.forEach(e=>{e.uninstall&&e.uninstall(this)}),this.plugins.clear(),this.breadcrumbs=[]}get isDebug(){return this.config.debug}get appId(){return this.config.appId}get currentSessionId(){return this.sessionId}get transport(){return this._transport}getDebugInfo(){return{config:{...this.config},sessionId:this.sessionId,breadcrumbsCount:this.breadcrumbs.length,pluginCount:this.plugins.size,isDestroyed:this.isDestroyed,transportInfo:this._transport.getDebugInfo()}}logDebugInfo(){this.getDebugInfo();this._transport.logDebugInfo()}}let i=-1;const s=e=>{addEventListener("pageshow",t=>{t.persisted&&(i=t.timeStamp,e(t))},!0)},c=(e,t,r,o)=>{let a,n;return i=>{t.value>=0&&(i||o)&&(n=t.value-(a??0),(n||void 0===a)&&(a=t.value,t.delta=n,t.rating=((e,t)=>e>t[1]?"poor":e>t[0]?"needs-improvement":"good")(t.value,r),e(t)))}},l=e=>{requestAnimationFrame(()=>requestAnimationFrame(()=>e()))},h=()=>{const e=performance.getEntriesByType("navigation")[0];if(e&&e.responseStart>0&&e.responseStart<performance.now())return e},u=()=>{const e=h();return e?.activationStart??0},d=(e,t=-1)=>{const r=h();let o="navigate";return i>=0?o="back-forward-cache":r&&(document.prerendering||u()>0?o="prerender":document.wasDiscarded?o="restore":r.type&&(o=r.type.replace(/_/g,"-"))),{name:e,value:t,rating:"good",delta:0,entries:[],id:`v5-${Date.now()}-${Math.floor(8999999999999*Math.random())+1e12}`,navigationType:o}},p=new WeakMap;function m(e,t){return p.get(e)||p.set(e,new t),p.get(e)}class g{t;i=0;o=[];h(e){if(e.hadRecentInput)return;const t=this.o[0],r=this.o.at(-1);this.i&&t&&r&&e.startTime-r.startTime<1e3&&e.startTime-t.startTime<5e3?(this.i+=e.value,this.o.push(e)):(this.i=e.value,this.o=[e]),this.t?.(e)}}const f=(e,t,r={})=>{try{if(PerformanceObserver.supportedEntryTypes.includes(e)){const o=new PerformanceObserver(e=>{Promise.resolve().then(()=>{t(e.getEntries())})});return o.observe({type:e,buffered:!0,...r}),o}}catch{}},y=e=>{let t=!1;return()=>{t||(e(),t=!0)}};let v=-1;const R=new Set,T=()=>"hidden"!==document.visibilityState||document.prerendering?1/0:0,b=e=>{if("hidden"===document.visibilityState){if("visibilitychange"===e.type)for(const e of R)e();isFinite(v)||(v="visibilitychange"===e.type?e.timeStamp:0,removeEventListener("prerenderingchange",b,!0))}},E=()=>{if(v<0){const e=u(),t=document.prerendering?void 0:globalThis.performance.getEntriesByType("visibility-state").filter(t=>"hidden"===t.name&&t.startTime>e)[0]?.startTime;v=t??T(),addEventListener("visibilitychange",b,!0),addEventListener("prerenderingchange",b,!0),s(()=>{setTimeout(()=>{v=T()})})}return{get firstHiddenTime(){return v},onHidden(e){R.add(e)}}},w=e=>{document.prerendering?addEventListener("prerenderingchange",()=>e(),!0):e()},S=[1800,3e3],I=(e,t={})=>{w(()=>{const r=E();let o,a=d("FCP");const n=f("paint",e=>{for(const t of e)"first-contentful-paint"===t.name&&(n.disconnect(),t.startTime<r.firstHiddenTime&&(a.value=Math.max(t.startTime-u(),0),a.entries.push(t),o(!0)))});n&&(o=c(e,a,S,t.reportAllChanges),s(r=>{a=d("FCP"),o=c(e,a,S,t.reportAllChanges),l(()=>{a.value=performance.now()-r.timeStamp,o(!0)})}))})},D=[.1,.25];let B=0,C=1/0,P=0;const O=e=>{for(const t of e)t.interactionId&&(C=Math.min(C,t.interactionId),P=Math.max(P,t.interactionId),B=P?(P-C)/7+1:0)};let M;const _=()=>M?B:performance.interactionCount??0;let A=0;class L{u=[];l=new Map;m;p;v(){A=_(),this.u.length=0,this.l.clear()}L(){const e=Math.min(this.u.length-1,Math.floor((_()-A)/50));return this.u[e]}h(e){if(this.m?.(e),!e.interactionId&&"first-input"!==e.entryType)return;const t=this.u.at(-1);let r=this.l.get(e.interactionId);if(r||this.u.length<10||e.duration>t.P){if(r?e.duration>r.P?(r.entries=[e],r.P=e.duration):e.duration===r.P&&e.startTime===r.entries[0].startTime&&r.entries.push(e):(r={id:e.interactionId,entries:[e],P:e.duration},this.l.set(r.id,r),this.u.push(r)),this.u.sort((e,t)=>t.P-e.P),this.u.length>10){const e=this.u.splice(10);for(const t of e)this.l.delete(t.id)}this.p?.(r)}}}const k=e=>{const t=globalThis.requestIdleCallback||setTimeout;"hidden"===document.visibilityState?e():(e=y(e),addEventListener("visibilitychange",e,{once:!0,capture:!0}),t(()=>{e(),removeEventListener("visibilitychange",e,{capture:!0})}))},N=[200,500],Q=(e,t={})=>{if(!globalThis.PerformanceEventTiming||!("interactionId"in PerformanceEventTiming.prototype))return;const r=E();w(()=>{"interactionCount"in performance||M||(M=f("event",O,{type:"event",buffered:!0,durationThreshold:0}));let o,a=d("INP");const n=m(t,L),i=e=>{k(()=>{for(const t of e)n.h(t);const t=n.L();t&&t.P!==a.value&&(a.value=t.P,a.entries=t.entries,o())})},l=f("event",i,{durationThreshold:t.durationThreshold??40});o=c(e,a,N,t.reportAllChanges),l&&(l.observe({type:"first-input",buffered:!0}),r.onHidden(()=>{i(l.takeRecords()),o(!0)}),s(()=>{n.v(),a=d("INP"),o=c(e,a,N,t.reportAllChanges)}))})};class H{m;h(e){this.m?.(e)}}const $=[2500,4e3],z=[800,1800],x=e=>{document.prerendering?w(()=>x(e)):"complete"!==document.readyState?addEventListener("load",()=>x(e),!0):setTimeout(e)};var F,U,V,q;e.DataType=void 0,(F=e.DataType||(e.DataType={})).PERFORMANCE="performance",F.ERROR="error",F.BEHAVIOR="behavior",e.PerformanceType=void 0,(U=e.PerformanceType||(e.PerformanceType={})).LCP="LCP",U.INP="INP",U.CLS="CLS",U.FCP="FCP",U.FID="FID",U.TTFB="TTFB",U.NAVIGATION="navigation",U.RESOURCE="resource",U.API="api",U.BATCH="batch",e.ErrorType=void 0,(V=e.ErrorType||(e.ErrorType={})).JS_ERROR="js_error",V.PROMISE_ERROR="promise_error",V.RESOURCE_ERROR="resource_error",V.API_ERROR="api_error",V.CUSTOM_ERROR="custom_error",e.BehaviorType=void 0,(q=e.BehaviorType||(e.BehaviorType={})).CLICK="click",q.INPUT="input",q.SCROLL="scroll",q.ROUTE_CHANGE="route_change",q.PAGE_VIEW="page_view";class X{constructor(e,t){var r,o,a;this.observer=null,this.performanceQueue=[],this.batchTimer=null,this.batchInterval=5e3,this.batchSize=10,this.batchStartTime=Date.now(),this.enableBatch=!0,this.monitor=e,t&&(this.enableBatch=null===(r=t.enableBatch)||void 0===r||r,this.batchInterval=null!==(o=t.batchInterval)&&void 0!==o?o:5e3,this.batchSize=null!==(a=t.batchSize)&&void 0!==a?a:10),this.init(),this.enableBatch&&this.startBatchTimer()}init(){this.collectWebVitals(),this.collectNavigationTiming(),this.collectResourceTiming(),this.collectAPITiming()}collectWebVitals(){((e,t={})=>{w(()=>{const r=E();let o,a=d("LCP");const n=m(t,H),i=e=>{t.reportAllChanges||(e=e.slice(-1));for(const t of e)n.h(t),t.startTime<r.firstHiddenTime&&(a.value=Math.max(t.startTime-u(),0),a.entries=[t],o())},h=f("largest-contentful-paint",i);if(h){o=c(e,a,$,t.reportAllChanges);const r=y(()=>{i(h.takeRecords()),h.disconnect(),o(!0)}),n=e=>{e.isTrusted&&(k(r),removeEventListener(e.type,n,{capture:!0}))};for(const e of["keydown","click","visibilitychange"])addEventListener(e,n,{capture:!0});s(r=>{a=d("LCP"),o=c(e,a,$,t.reportAllChanges),l(()=>{a.value=performance.now()-r.timeStamp,o(!0)})})}})})(t=>{this.reportMetric({type:e.PerformanceType.LCP,name:"LCP",value:t.value,rating:t.rating,delta:t.delta,entries:t.entries})}),Q(t=>{this.reportMetric({type:e.PerformanceType.INP,name:"INP",value:t.value,rating:t.rating,delta:t.delta,entries:t.entries})}),((e,t={})=>{const r=E();I(y(()=>{let o,a=d("CLS",0);const n=m(t,g),i=e=>{for(const t of e)n.h(t);n.i>a.value&&(a.value=n.i,a.entries=n.o,o())},h=f("layout-shift",i);h&&(o=c(e,a,D,t.reportAllChanges),r.onHidden(()=>{i(h.takeRecords()),o(!0)}),s(()=>{n.i=0,a=d("CLS",0),o=c(e,a,D,t.reportAllChanges),l(()=>o())}),setTimeout(o))}))})(t=>{this.reportMetric({type:e.PerformanceType.CLS,name:"CLS",value:t.value,rating:t.rating,delta:t.delta,entries:t.entries})}),I(t=>{this.reportMetric({type:e.PerformanceType.FCP,name:"FCP",value:t.value,rating:t.rating,delta:t.delta,entries:t.entries})}),((e,t={})=>{let r=d("TTFB"),o=c(e,r,z,t.reportAllChanges);x(()=>{const a=h();a&&(r.value=Math.max(a.responseStart-u(),0),r.entries=[a],o(!0),s(()=>{r=d("TTFB",0),o=c(e,r,z,t.reportAllChanges),o(!0)}))})})(t=>{this.reportMetric({type:e.PerformanceType.TTFB,name:"TTFB",value:t.value,rating:t.rating,delta:t.delta,entries:t.entries})})}collectNavigationTiming(){window.addEventListener("load",()=>{setTimeout(()=>{const t=performance.getEntriesByType("navigation")[0];if(!t)return;const r={dnsLookup:t.domainLookupEnd-t.domainLookupStart,tcpConnect:t.connectEnd-t.connectStart,sslConnect:t.secureConnectionStart>0?t.connectEnd-t.secureConnectionStart:0,request:t.responseStart-t.requestStart,response:t.responseEnd-t.responseStart,domParse:t.domInteractive-t.responseEnd,domContentLoaded:t.domContentLoadedEventEnd-t.fetchStart,loadComplete:t.loadEventEnd-t.fetchStart,firstPaint:this.getFirstPaint(),firstContentfulPaint:this.getFirstContentfulPaint()};this.reportMetric({type:e.PerformanceType.NAVIGATION,name:"Navigation Timing",value:r.loadComplete,entries:[t],navigationType:this.getNavigationType("number"==typeof t.type?t.type:0)}),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.PERFORMANCE,category:"navigation",message:"Page loaded",level:"info",data:r})},0)})}collectResourceTiming(){if(PerformanceObserver)try{this.observer=new PerformanceObserver(t=>{t.getEntries().forEach(t=>{if("resource"===t.entryType){const r=t;if(r.name.includes(this.monitor.appId))return;this.reportMetric({type:e.PerformanceType.RESOURCE,name:r.name,value:r.duration,entries:[t]}),r.duration>3e3&&this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.PERFORMANCE,category:"resource",message:`Slow resource: ${r.name}`,level:"warning",data:{duration:r.duration,size:r.transferSize||0}})}})}),this.observer.observe({entryTypes:["resource"]})}catch(e){}}collectAPITiming(){const t=window.fetch;window.fetch=async(...r)=>{const o=performance.now(),a="string"==typeof r[0]?r[0]:r[0].url;try{const n=await t.apply(window,r),i=performance.now()-o;return this.reportMetric({type:e.PerformanceType.API,name:a,value:i,entries:[]}),i>2e3&&this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.PERFORMANCE,category:"api",message:`Slow API: ${a}`,level:"warning",data:{duration:i,status:n.status}}),n}catch(t){const r=performance.now()-o;throw this.reportMetric({type:e.PerformanceType.API,name:a,value:r,entries:[]}),t}};const r=XMLHttpRequest.prototype.open,o=XMLHttpRequest.prototype.send,a=this;XMLHttpRequest.prototype.open=function(e,t,o,a,n){return this._monitor_url=t.toString(),this._monitor_startTime=performance.now(),r.call(this,e,t,null==o||o,a,n)},XMLHttpRequest.prototype.send=function(t){const r=this,n=r._monitor_startTime,i=r._monitor_url;return r.addEventListener("readystatechange",()=>{if(4===r.readyState){const t=performance.now()-n;a&&i&&(a.reportMetric({type:e.PerformanceType.API,name:i,value:t,entries:[]}),t>2e3&&a.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.PERFORMANCE,category:"api",message:`Slow XHR: ${i}`,level:"warning",data:{duration:t,status:r.status}}))}}),o.call(this,t)}}getFirstPaint(){const e=performance.getEntriesByType("paint").find(e=>"first-paint"===e.name);return e?e.startTime:0}getFirstContentfulPaint(){const e=performance.getEntriesByType("paint").find(e=>"first-contentful-paint"===e.name);return e?e.startTime:0}getNavigationType(e){return["navigate","reload","back_forward","prerender"][e]||"unknown"}startBatchTimer(){this.batchTimer=setInterval(()=>{this.flushBatch()},this.batchInterval)}stopBatchTimer(){this.batchTimer&&(clearInterval(this.batchTimer),this.batchTimer=null)}flushBatch(){if(0===this.performanceQueue.length)return;const t=this.createBatchData();this.monitor.report({type:e.DataType.PERFORMANCE,data:t}),this.resetBatch()}createBatchData(){const t=Date.now(),r=[...this.performanceQueue],o=this.generateSummary(r);return{type:e.PerformanceType.BATCH,name:"Performance Metrics Batch",count:r.length,startTime:this.batchStartTime,endTime:t,metrics:r,summary:o}}generateSummary(t){const r={vitals:{},navigation:{},resources:{count:0,slowCount:0,totalSize:0},apis:{count:0,slowCount:0,avgDuration:0}};let o=[];return t.forEach(t=>{switch(t.type){case e.PerformanceType.LCP:r.vitals.lcp=t.value;break;case e.PerformanceType.INP:r.vitals.inp=t.value;break;case e.PerformanceType.CLS:r.vitals.cls=t.value;break;case e.PerformanceType.FCP:r.vitals.fcp=t.value;break;case e.PerformanceType.TTFB:r.vitals.ttfb=t.value;break;case e.PerformanceType.NAVIGATION:if(r.navigation.loadComplete=t.value,t.entries&&t.entries[0]){const e=t.entries[0];r.navigation.domContentLoaded=e.domContentLoadedEventEnd-e.fetchStart}break;case e.PerformanceType.RESOURCE:if(r.resources.count++,t.value>3e3&&r.resources.slowCount++,t.entries&&t.entries[0]){const e=t.entries[0];r.resources.totalSize=(r.resources.totalSize||0)+(e.transferSize||0)}break;case e.PerformanceType.API:r.apis.count++,t.value>2e3&&r.apis.slowCount++,o.push(t.value)}}),o.length>0&&(r.apis.avgDuration=o.reduce((e,t)=>e+t,0)/o.length),r}resetBatch(){this.performanceQueue=[],this.batchStartTime=Date.now()}reportMetric(t){this.enableBatch?(this.performanceQueue.push(t),this.performanceQueue.length>=this.batchSize&&this.flushBatch()):this.monitor.report({type:e.DataType.PERFORMANCE,data:t})}flush(){this.enableBatch&&this.flushBatch()}setBatchOptions(e){const t=this.enableBatch;void 0!==e.enableBatch&&(this.enableBatch=e.enableBatch),void 0!==e.batchInterval&&(this.batchInterval=e.batchInterval),void 0!==e.batchSize&&(this.batchSize=e.batchSize),t!==this.enableBatch?this.enableBatch?(this.performanceQueue.length>0&&this.flushBatch(),this.startBatchTimer()):(this.stopBatchTimer(),this.performanceQueue.length>0&&this.flushBatch()):this.enableBatch&&this.batchTimer&&(this.stopBatchTimer(),this.startBatchTimer())}getBatchStatus(){return{enabled:this.enableBatch,queueLength:this.performanceQueue.length,batchInterval:this.batchInterval,batchSize:this.batchSize,startTime:this.batchStartTime}}destroy(){this.stopBatchTimer(),this.enableBatch&&this.performanceQueue.length>0&&this.flushBatch(),this.observer&&(this.observer.disconnect(),this.observer=null),this.performanceQueue=[]}}class K{constructor(e){this.monitor=e,this.originalFetch=window.fetch,this.originalXHROpen=XMLHttpRequest.prototype.open,this.originalXHRSend=XMLHttpRequest.prototype.send,this.init()}init(){this.handleJSError(),this.handlePromiseError(),this.handleResourceError(),this.handleAPIError()}handleJSError(){window.addEventListener("error",t=>{const{message:r,filename:o,lineno:a,colno:n,error:i}=t,s={type:e.ErrorType.JS_ERROR,message:r||"Unknown error",filename:o,lineno:a,colno:n,stack:null==i?void 0:i.stack};this.reportError(s),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"javascript",message:`JS Error: ${r}`,level:"error",data:{filename:o,lineno:a,colno:n}})},!0)}handlePromiseError(){window.addEventListener("unhandledrejection",t=>{let r="Unhandled Promise Rejection",o="";if(t.reason)if(t.reason instanceof Error)r=t.reason.message,o=t.reason.stack||"";else if("string"==typeof t.reason)r=t.reason;else try{r=JSON.stringify(t.reason)}catch(e){r=String(t.reason)}const a={type:e.ErrorType.PROMISE_ERROR,message:r,stack:o};this.reportError(a),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"promise",message:`Promise Error: ${r}`,level:"error",data:{reason:t.reason}})})}handleResourceError(){window.addEventListener("error",t=>{const r=t.target;if(r&&r!==window&&("IMG"===r.tagName||"SCRIPT"===r.tagName||"LINK"===r.tagName||"AUDIO"===r.tagName||"VIDEO"===r.tagName)){const t={type:e.ErrorType.RESOURCE_ERROR,message:`Resource load error: ${r.tagName}`,resourceUrl:r.src||r.href||"",elementSelector:o(r)};this.reportError(t),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"resource",message:`Resource Error: ${r.tagName}`,level:"error",data:{url:t.resourceUrl,element:r.tagName}})}},!0)}handleAPIError(){window.fetch=async(...t)=>{const r="string"==typeof t[0]?t[0]:t[0].url,o=Date.now();try{const a=await this.originalFetch.apply(window,t);if(!a.ok){const t={type:e.ErrorType.API_ERROR,message:`API Error: ${a.status} ${a.statusText}`,resourceUrl:r,statusCode:a.status};this.reportError(t),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"api",message:`API Error: ${r}`,level:"error",data:{status:a.status,statusText:a.statusText,duration:Date.now()-o}})}return a}catch(t){const a={type:e.ErrorType.API_ERROR,message:`Network Error: ${t instanceof Error?t.message:"Unknown error"}`,resourceUrl:r,stack:t instanceof Error?t.stack:void 0};throw this.reportError(a),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"api",message:`Network Error: ${r}`,level:"error",data:{error:t instanceof Error?t.message:String(t),duration:Date.now()-o}}),t}};const t=this;XMLHttpRequest.prototype.open=function(e,r,o,a,n){return this._monitor_url=r.toString(),this._monitor_method=e,this._monitor_startTime=Date.now(),t.originalXHROpen.call(this,e,r,null==o||o,a,n)},XMLHttpRequest.prototype.send=function(r){const o=this,a=o._monitor_url,n=o._monitor_method,i=o._monitor_startTime;return o.addEventListener("error",()=>{const r={type:e.ErrorType.API_ERROR,message:`XMLHttpRequest Error: ${n} ${a}`,resourceUrl:a,statusCode:o.status};t.reportError(r),t.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"api",message:`XHR Error: ${n} ${a}`,level:"error",data:{method:n,status:o.status,duration:Date.now()-i}})}),o.addEventListener("load",()=>{if(o.status>=400){const r={type:e.ErrorType.API_ERROR,message:`API Error: ${o.status} ${o.statusText}`,resourceUrl:a,statusCode:o.status};t.reportError(r),t.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"api",message:`XHR ${o.status}: ${n} ${a}`,level:"error",data:{method:n,status:o.status,statusText:o.statusText,duration:Date.now()-i}})}}),t.originalXHRSend.call(this,r)}}reportError(t){this.monitor.report({type:e.DataType.ERROR,data:t})}reportCustomError(t,r){const o={type:e.ErrorType.CUSTOM_ERROR,message:t,stack:(new Error).stack,...r};this.reportError(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"custom",message:`Custom Error: ${t}`,level:"error",data:r})}destroy(){window.fetch=this.originalFetch,XMLHttpRequest.prototype.open=this.originalXHROpen,XMLHttpRequest.prototype.send=this.originalXHRSend}}class G{constructor(e){this.monitor=e,this.currentUrl=window.location.href,this.startTime=Date.now(),this.init()}init(){this.trackPageView(),this.trackClicks(),this.trackInputs(),this.trackScrolls(),this.trackRouteChanges()}trackPageView(){const t={type:e.BehaviorType.PAGE_VIEW,url:this.currentUrl};this.reportBehavior(t),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.BEHAVIOR,category:"navigation",message:`Page view: ${this.currentUrl}`,level:"info",data:{url:this.currentUrl,referrer:document.referrer}})}trackClicks(){document.addEventListener("click",t=>{const r=t.target;if(!r)return;const a={type:e.BehaviorType.CLICK,element:r.tagName,selector:o(r),text:(n=r,"INPUT"===n.tagName?n.value||n.placeholder||"":(null===(i=n.textContent)||void 0===i?void 0:i.trim().slice(0,100))||"")};var n,i;this.reportBehavior(a),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.BEHAVIOR,category:"interaction",message:`Click: ${r.tagName}`,level:"info",data:{text:a.text,selector:a.selector}})},!0)}trackInputs(){const t=function(e,t){let r=null;return function(...o){const a=this;r&&clearTimeout(r),r=window.setTimeout(()=>{e.apply(a,o),r=null},t)}}(t=>{const r=t.target;if(!r||"password"===r.type)return;const a={type:e.BehaviorType.INPUT,element:r.tagName,selector:o(r),text:"password"===r.type?"***":r.value.slice(0,100)};this.reportBehavior(a),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.BEHAVIOR,category:"interaction",message:`Input: ${r.tagName}`,level:"info",data:{type:r.type,selector:a.selector}})},500);document.addEventListener("input",t,!0),document.addEventListener("change",t,!0)}trackScrolls(){let t=0;const r=function(e,t){let r=null,o=0;return function(...a){const n=Date.now(),i=this;n-o>t?(e.apply(i,a),o=n):(r&&clearTimeout(r),r=window.setTimeout(()=>{e.apply(i,a),o=Date.now(),r=null},t-(n-o)))}}(()=>{const r=window.pageYOffset||document.documentElement.scrollTop,o=window.innerHeight,a=document.documentElement.scrollHeight,n=Math.round((r+o)/a*100);if(n>t&&(t=n,n>=25&&n%25==0)){const t={type:e.BehaviorType.SCROLL,text:`${n}%`};this.reportBehavior(t),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.BEHAVIOR,category:"interaction",message:`Scroll: ${n}%`,level:"info",data:{depth:n,scrollTop:r,documentHeight:a}})}},1e3);window.addEventListener("scroll",r,{passive:!0})}trackRouteChanges(){const t=history.pushState,r=history.replaceState,o=(t,r)=>{const o=Date.now()-this.startTime,a={type:e.BehaviorType.ROUTE_CHANGE,from:t,to:r,duration:o};this.reportBehavior(a),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.BEHAVIOR,category:"navigation",message:`Route change: ${t} -> ${r}`,level:"info",data:{from:t,to:r,duration:o}}),this.currentUrl=r,this.startTime=Date.now()};history.pushState=function(e,r,a){const n=window.location.href,i=t.apply(this,arguments),s=window.location.href;return n!==s&&o(n,s),i},history.replaceState=function(e,t,a){const n=window.location.href,i=r.apply(this,arguments),s=window.location.href;return n!==s&&o(n,s),i},window.addEventListener("popstate",()=>{const e=window.location.href;o(this.currentUrl,e)}),window.addEventListener("hashchange",()=>{const e=window.location.href;o(this.currentUrl,e)})}reportCustomBehavior(t,r){const o={type:t,...r};this.reportBehavior(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.BEHAVIOR,category:"custom",message:`Custom behavior: ${t}`,level:"info",data:r})}reportBehavior(t){this.monitor.report({type:e.DataType.BEHAVIOR,data:t})}destroy(){}}const J={name:"vue",install(t){if("undefined"!=typeof window&&window.Vue){window.Vue.config.errorHandler=(r,o,a)=>{var n,i;const s={type:e.ErrorType.JS_ERROR,message:r.message,stack:r.stack,source:`Vue ${a}`,filename:(null===(n=null==o?void 0:o.$options)||void 0===n?void 0:n.__file)||"Vue Component"};t.report({type:e.DataType.ERROR,data:s}),t.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"vue",message:`Vue Error: ${r.message}`,level:"error",data:{info:a,component:(null===(i=null==o?void 0:o.$options)||void 0===i?void 0:i.name)||"Anonymous Component"}})}}if("undefined"!=typeof window&&window.Vue&&window.Vue.version&&window.Vue.version.startsWith("3")){window.Vue.createApp({}).config.errorHandler=(r,o,a)=>{var n,i;const s={type:e.ErrorType.JS_ERROR,message:r.message,stack:r.stack,source:`Vue3 ${a}`,filename:(null===(n=null==o?void 0:o.$options)||void 0===n?void 0:n.__file)||"Vue3 Component"};t.report({type:e.DataType.ERROR,data:s}),t.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"vue3",message:`Vue3 Error: ${r.message}`,level:"error",data:{info:a,component:(null===(i=null==o?void 0:o.type)||void 0===i?void 0:i.name)||"Anonymous Component"}})}}}},j={name:"react",install(t){if("undefined"!=typeof window&&window.React){const r=window.React.createElement;window.React.createElement=function(o,a,...n){if("function"==typeof o&&o.prototype&&o.prototype.isReactComponent){const r=o.prototype.componentDidCatch;o.prototype.componentDidCatch=function(a,n){const i={type:e.ErrorType.JS_ERROR,message:a.message,stack:a.stack,source:"React Component",filename:n.componentStack};t.report({type:e.DataType.ERROR,data:i}),t.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"react",message:`React Error: ${a.message}`,level:"error",data:{componentStack:n.componentStack,component:o.name||"Anonymous Component"}}),r&&r.call(this,a,n)}}return r.apply(this,arguments)}}if("undefined"!=typeof window&&window.ReactDOM&&window.ReactDOM.createRoot){const r=window.ReactDOM.createRoot;window.ReactDOM.createRoot=function(o,a={}){const n={...a,onRecoverableError:(r,o)=>{const n={type:e.ErrorType.JS_ERROR,message:r.message,stack:r.stack,source:"React Recoverable Error"};t.report({type:e.DataType.ERROR,data:n}),t.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"react",message:`React Recoverable Error: ${r.message}`,level:"warning",data:o}),a.onRecoverableError&&a.onRecoverableError(r,o)}};return r.call(this,o,n)}}}};class WebMonitorSDK{constructor(e){this.isInitialized=!1,/bot|crawler|spider|crawling/i.test(navigator.userAgent)?this.monitor={}:(this.monitor=new n(e),this.init(),window.__webMonitorSDK=this,this.setupGlobalDebugMethods())}init(){var e,t,r;if(!this.isInitialized)try{if(this.monitor.config.enablePerformance){const o=this.monitor.config.performance;this.performanceMonitor=new X(this.monitor,{enableBatch:null===(e=null==o?void 0:o.enableBatch)||void 0===e||e,batchInterval:null!==(t=null==o?void 0:o.batchInterval)&&void 0!==t?t:5e3,batchSize:null!==(r=null==o?void 0:o.batchSize)&&void 0!==r?r:10})}this.monitor.config.enableError&&(this.errorMonitor=new K(this.monitor)),this.monitor.config.enableBehavior&&(this.behaviorMonitor=new G(this.monitor)),this.isInitialized=!0,this.monitor.isDebug}catch(e){}}reportError(e,t){this.errorMonitor&&this.errorMonitor.reportCustomError(e,t)}reportBehavior(e,t){this.behaviorMonitor&&this.behaviorMonitor.reportCustomBehavior(e,t)}report(e){this.monitor.report(e)}use(e){return this.monitor.use(e),this}unuse(e){return this.monitor.unuse(e),this}setTag(e,t){this.monitor.tags||(this.monitor.tags={}),this.monitor.tags[e]=t}setContext(e,t){this.monitor.contexts||(this.monitor.contexts={}),this.monitor.contexts[e]=t}destroy(){var e,t,r;this.isInitialized&&(null===(e=this.performanceMonitor)||void 0===e||e.destroy(),null===(t=this.errorMonitor)||void 0===t||t.destroy(),null===(r=this.behaviorMonitor)||void 0===r||r.destroy(),this.monitor.destroy(),this.isInitialized=!1,delete window.__webMonitorSDK,this.monitor.isDebug)}getConfig(){return this.monitor.config}getSessionId(){return this.monitor.currentSessionId}flushPerformance(){this.performanceMonitor&&this.performanceMonitor.flush()}setPerformanceBatchOptions(e){this.performanceMonitor&&this.performanceMonitor.setBatchOptions(e)}getPerformanceBatchStatus(){return this.performanceMonitor?this.performanceMonitor.getBatchStatus():null}setupGlobalDebugMethods(){window.WebMonitorSDK={debug:()=>{this.monitor.logDebugInfo()},viewCache:()=>{this.monitor.transport.getStorageManager().logStorageData()},clearCache:()=>{this.monitor.transport.getStorageManager().clear()},flush:()=>{this.monitor.transport.flush()},getStatus:()=>this.monitor.transport.getQueueStatus(),getRawData:()=>{const e=this.monitor.transport.getStorageManager().getRawData();return e?JSON.parse(e):null},getDebugInfo:()=>this.monitor.getDebugInfo(),performance:{flush:()=>{this.flushPerformance()},getStatus:()=>{const e=this.getPerformanceBatchStatus();return e||null},setBatch:e=>{this.setPerformanceBatchOptions(e)},disableBatch:()=>{this.setPerformanceBatchOptions({enableBatch:!1})},enableBatch:()=>{this.setPerformanceBatchOptions({enableBatch:!0})}},help:()=>{}},this.monitor.isDebug}}e.ReactPlugin=j,e.VuePlugin=J,e.WebMonitorSDK=WebMonitorSDK,e.createWebMonitorSDK=function(e){return new WebMonitorSDK(e)},e.default=WebMonitorSDK,Object.defineProperty(e,"__esModule",{value:!0})});
