!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).WebMonitorSDK={})}(this,function(e){"use strict";class t{constructor(){this.STORAGE_KEY="web_monitor_queue",this.TIMER_KEY="web_monitor_timer",this.MAX_STORAGE_SIZE=1048576}save(e){if(!this.isLocalStorageAvailable())return!1;try{const t=JSON.stringify(e);return!(t.length>this.MAX_STORAGE_SIZE)&&(localStorage.setItem(this.STORAGE_KEY,t),!0)}catch(e){return!1}}load(){if(!this.isLocalStorageAvailable())return[];try{const e=localStorage.getItem(this.STORAGE_KEY);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return this.clear(),[]}}clear(){if(this.isLocalStorageAvailable())try{localStorage.removeItem(this.STORAGE_KEY)}catch(e){}}isLocalStorageAvailable(){try{const e="__localStorage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}getStorageSize(){if(!this.isLocalStorageAvailable())return 0;try{const e=localStorage.getItem(this.STORAGE_KEY);return e?e.length:0}catch(e){return 0}}saveLastReportTime(e){if(!this.isLocalStorageAvailable())return!1;try{return localStorage.setItem(this.TIMER_KEY,e.toString()),!0}catch(e){return!1}}getLastReportTime(){if(!this.isLocalStorageAvailable())return 0;try{const e=localStorage.getItem(this.TIMER_KEY);return e?parseInt(e,10):0}catch(e){return 0}}clearTimer(){if(this.isLocalStorageAvailable())try{localStorage.removeItem(this.TIMER_KEY)}catch(e){}}}class r{constructor(e){var r,n,o,i,a,s,c,u,l;this.dataQueue=[],this.reportTimer=null,this.isDestroyed=!1,this.pendingRequests=0,this.retryQueue=[],this.options={url:e.url,timeout:null!==(r=e.timeout)&&void 0!==r?r:5e3,withCredentials:null!==(n=e.withCredentials)&&void 0!==n&&n,headers:null!==(o=e.headers)&&void 0!==o?o:{},reportInterval:null!==(i=e.reportInterval)&&void 0!==i?i:6e4,batchSize:null!==(a=e.batchSize)&&void 0!==a?a:10,maxQueueSize:null!==(s=e.maxQueueSize)&&void 0!==s?s:100,enableImmediateReport:null===(c=e.enableImmediateReport)||void 0===c||c,retryCount:null!==(u=e.retryCount)&&void 0!==u?u:3,retryInterval:null!==(l=e.retryInterval)&&void 0!==l?l:1e3},this.storageManager=new t,this.loadDataFromStorage(),this.startReportTimer(),this.setupBeforeUnload(),this.startRetryTimer()}loadDataFromStorage(){const e=this.storageManager.load();this.dataQueue.push(...e),this.storageManager.clear()}saveDataToStorage(){this.dataQueue.length>0&&this.storageManager.save(this.dataQueue)}startReportTimer(){const e=Date.now(),t=this.storageManager.getLastReportTime();let r=this.options.reportInterval;if(t>0){const n=e-t;r=n<this.options.reportInterval?this.options.reportInterval-n:0}r<=0&&(this.processQueuedData(),r=this.options.reportInterval),this.reportTimer=window.setInterval(()=>{this.processQueuedData()},this.options.reportInterval),r!==this.options.reportInterval&&setTimeout(()=>{this.processQueuedData()},r)}startRetryTimer(){setInterval(()=>{this.processRetryQueue()},this.options.retryInterval)}setupBeforeUnload(){window.addEventListener("beforeunload",()=>{this.saveDataToStorage(),this.flushAllQueues()}),window.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&(this.saveDataToStorage(),this.flushAllQueues())})}flushAllQueues(){this.dataQueue.length>0&&(this.trySendBeacon(this.dataQueue),this.dataQueue=[])}send(e){this.isDestroyed||(this.dataQueue.push(e),this.checkQueueOverflow())}processQueuedData(){if(this.isDestroyed||this.pendingRequests>3)return;const e=this.dataQueue.length>0;if(this.dataQueue.length>0){const e=this.dataQueue.splice(0,this.options.batchSize);this.sendBatch(e),this.storageManager.saveLastReportTime(Date.now())}e&&this.storageManager.clear()}sendBatch(e){if(this.isDestroyed)return;this.pendingRequests++;const t=JSON.stringify(e),r=this.sendFetch(t).catch(()=>this.sendXHR(t));Promise.resolve(r).then(()=>{var e;this.pendingRequests--,null===(e=this.options.headers)||void 0===e||e.debug}).catch(()=>{this.pendingRequests--,this.addToRetryQueue(e)})}trySendBeacon(e){if(!navigator.sendBeacon)return null;try{const t=JSON.stringify(e),r=new Blob([t],{type:"application/json"});return navigator.sendBeacon(this.options.url,r)?Promise.resolve():Promise.reject(new Error("SendBeacon failed"))}catch(e){return Promise.reject(e)}}checkQueueOverflow(){this.dataQueue.length>=this.options.maxQueueSize&&this.processQueuedData()}addToRetryQueue(e){const t={data:e,retryCount:0,nextRetryTime:Date.now()+this.options.retryInterval};this.retryQueue.push(t)}processRetryQueue(){if(0===this.retryQueue.length||this.pendingRequests>3)return;const e=Date.now();this.retryQueue.filter(t=>e>=t.nextRetryTime).forEach(t=>{if(t.retryCount<this.options.retryCount)t.retryCount++,t.nextRetryTime=e+this.options.retryInterval*Math.pow(2,t.retryCount),this.sendBatch(t.data);else{const e=this.retryQueue.indexOf(t);e>-1&&this.retryQueue.splice(e,1)}})}async sendFetch(e){const t=new AbortController,r=setTimeout(()=>t.abort(),this.options.timeout);try{await fetch(this.options.url,{method:"POST",headers:{"Content-Type":"application/json",...this.options.headers},body:e,credentials:this.options.withCredentials?"include":"omit",signal:t.signal})}finally{clearTimeout(r)}}sendXHR(e){const t=new XMLHttpRequest;t.open("POST",this.options.url,!0),t.timeout=this.options.timeout,t.withCredentials=this.options.withCredentials,t.setRequestHeader("Content-Type","application/json"),Object.entries(this.options.headers).forEach(([e,r])=>{t.setRequestHeader(e,r)}),t.onerror=()=>{},t.ontimeout=()=>{};try{t.send(e)}catch(e){}}destroy(){this.isDestroyed=!0,this.reportTimer&&(clearInterval(this.reportTimer),this.reportTimer=null),this.flushAllQueues(),this.retryQueue=[],this.storageManager.clearTimer()}getQueueStatus(){return{queue:this.dataQueue.length,retry:this.retryQueue.length,pending:this.pendingRequests}}flush(){this.processQueuedData()}}function n(e){const t=[];let r=e;for(;r&&r.nodeType===Node.ELEMENT_NODE;){let e=r.nodeName.toLowerCase();if(r.id){e+=`#${r.id}`,t.unshift(e);break}{let t=1,n=r.previousElementSibling;for(;n;)n.nodeName.toLowerCase()===e&&t++,n=n.previousElementSibling;t>1&&(e+=`:nth-child(${t})`)}t.unshift(e),r=r.parentElement}return t.join(" > ")}function o(){const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;return e&&(e.effectiveType||e.type)||"unknown"}class i{constructor(e){this.breadcrumbs=[],this.plugins=new Map,this.isDestroyed=!1,this.config=this.mergeConfig(e),this.sessionId=function(){const e=localStorage.getItem("web_monitor_session_id");if(e)return e;const t=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{localStorage.setItem("web_monitor_session_id",t)}catch(e){}return t}(),this.userId=function(){const e=localStorage.getItem("web_monitor_user_id");if(e)return e;const t=`user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{localStorage.setItem("web_monitor_user_id",t)}catch(e){}return t}(),this.transport=new r({url:this.config.reportUrl,reportInterval:this.config.reportInterval,batchSize:this.config.batchSize,maxQueueSize:this.config.maxQueueSize,enableImmediateReport:this.config.enableImmediateReport}),this.init()}mergeConfig(e){var t,r,n,o,i,a,s,c,u,l,d;return{appId:e.appId,reportUrl:e.reportUrl,sampling:null!==(t=e.sampling)&&void 0!==t?t:1,debug:null!==(r=e.debug)&&void 0!==r&&r,enablePerformance:null===(n=e.enablePerformance)||void 0===n||n,enableError:null===(o=e.enableError)||void 0===o||o,enableBehavior:null===(i=e.enableBehavior)||void 0===i||i,maxBreadcrumbsNum:null!==(a=e.maxBreadcrumbsNum)&&void 0!==a?a:20,beforeSend:null!==(s=e.beforeSend)&&void 0!==s?s:e=>e,reportInterval:null!==(c=e.reportInterval)&&void 0!==c?c:6e4,batchSize:null!==(u=e.batchSize)&&void 0!==u?u:10,maxQueueSize:null!==(l=e.maxQueueSize)&&void 0!==l?l:100,enableImmediateReport:null===(d=e.enableImmediateReport)||void 0===d||d}}init(){this.shouldSample()&&this.setupErrorHandling()}shouldSample(){return Math.random()<this.config.sampling}setupErrorHandling(){const e=console.error;console.error=(...t)=>{try{e.apply(console,t)}catch(e){}},window.addEventListener("error",e=>{this.safeExecute(()=>{})}),window.addEventListener("unhandledrejection",e=>{this.safeExecute(()=>{})})}safeExecute(e){try{this.isDestroyed||e()}catch(e){this.config.debug}}addBreadcrumb(e){this.breadcrumbs.length>=this.config.maxBreadcrumbsNum&&this.breadcrumbs.shift(),this.breadcrumbs.push(e)}report(e){this.safeExecute(()=>{const t={appId:this.config.appId,timestamp:Date.now(),sessionId:this.sessionId,userId:this.userId,url:window.location.href,userAgent:navigator.userAgent,connectionType:o(),breadcrumbs:[...this.breadcrumbs],...e},r=this.config.beforeSend(t);r&&(this.transport.send(r),this.config.debug)})}use(e){this.plugins.has(e.name)||(this.plugins.set(e.name,e),e.install(this))}unuse(e){const t=this.plugins.get(e);t&&t.uninstall&&t.uninstall(this),this.plugins.delete(e)}destroy(){this.isDestroyed=!0,this.transport.destroy(),this.plugins.forEach(e=>{e.uninstall&&e.uninstall(this)}),this.plugins.clear(),this.breadcrumbs=[]}get isDebug(){return this.config.debug}get appId(){return this.config.appId}get currentSessionId(){return this.sessionId}get currentUserId(){return this.userId}}var a,s,c,u,l,d,p,h,m=-1,g=function(e){addEventListener("pageshow",function(t){t.persisted&&(m=t.timeStamp,e(t))},!0)},f=function(){return window.performance&&performance.getEntriesByType&&performance.getEntriesByType("navigation")[0]},y=function(){var e=f();return e&&e.activationStart||0},v=function(e,t){var r=f(),n="navigate";return m>=0?n="back-forward-cache":r&&(document.prerendering||y()>0?n="prerender":document.wasDiscarded?n="restore":r.type&&(n=r.type.replace(/_/g,"-"))),{name:e,value:void 0===t?-1:t,rating:"good",delta:0,entries:[],id:"v3-".concat(Date.now(),"-").concat(Math.floor(8999999999999*Math.random())+1e12),navigationType:n}},R=function(e,t,r){try{if(PerformanceObserver.supportedEntryTypes.includes(e)){var n=new PerformanceObserver(function(e){Promise.resolve().then(function(){t(e.getEntries())})});return n.observe(Object.assign({type:e,buffered:!0},r||{})),n}}catch(e){}},E=function(e,t,r,n){var o,i;return function(a){t.value>=0&&(a||n)&&((i=t.value-(o||0))||void 0===o)&&(o=t.value,t.delta=i,t.rating=function(e,t){return e>t[1]?"poor":e>t[0]?"needs-improvement":"good"}(t.value,r),e(t))}},w=function(e){requestAnimationFrame(function(){return requestAnimationFrame(function(){return e()})})},T=function(e){var t=function(t){"pagehide"!==t.type&&"hidden"!==document.visibilityState||e(t)};addEventListener("visibilitychange",t,!0),addEventListener("pagehide",t,!0)},S=function(e){var t=!1;return function(r){t||(e(r),t=!0)}},b=-1,I=function(){return"hidden"!==document.visibilityState||document.prerendering?1/0:0},D=function(e){"hidden"===document.visibilityState&&b>-1&&(b="visibilitychange"===e.type?e.timeStamp:0,_())},C=function(){addEventListener("visibilitychange",D,!0),addEventListener("prerenderingchange",D,!0)},_=function(){removeEventListener("visibilitychange",D,!0),removeEventListener("prerenderingchange",D,!0)},O=function(){return b<0&&(b=I(),C(),g(function(){setTimeout(function(){b=I(),C()},0)})),{get firstHiddenTime(){return b}}},P=function(e){document.prerendering?addEventListener("prerenderingchange",function(){return e()},!0):e()},L=[1800,3e3],A=function(e,t){t=t||{},P(function(){var r,n=O(),o=v("FCP"),i=R("paint",function(e){e.forEach(function(e){"first-contentful-paint"===e.name&&(i.disconnect(),e.startTime<n.firstHiddenTime&&(o.value=Math.max(e.startTime-y(),0),o.entries.push(e),r(!0)))})});i&&(r=E(e,o,L,t.reportAllChanges),g(function(n){o=v("FCP"),r=E(e,o,L,t.reportAllChanges),w(function(){o.value=performance.now()-n.timeStamp,r(!0)})}))})},M=[.1,.25],B={passive:!0,capture:!0},k=new Date,N=function(e,t){a||(a=t,s=e,c=new Date,Q(removeEventListener),H())},H=function(){if(s>=0&&s<c-k){var e={entryType:"first-input",name:a.type,target:a.target,cancelable:a.cancelable,startTime:a.timeStamp,processingStart:a.timeStamp+s};u.forEach(function(t){t(e)}),u=[]}},$=function(e){if(e.cancelable){var t=(e.timeStamp>1e12?new Date:performance.now())-e.timeStamp;"pointerdown"==e.type?function(e,t){var r=function(){N(e,t),o()},n=function(){o()},o=function(){removeEventListener("pointerup",r,B),removeEventListener("pointercancel",n,B)};addEventListener("pointerup",r,B),addEventListener("pointercancel",n,B)}(t,e):N(t,e)}},Q=function(e){["mousedown","keydown","touchstart","pointerdown"].forEach(function(t){return e(t,$,B)})},x=[100,300],U=[2500,4e3],F={},V=[800,1800],q=function e(t){document.prerendering?P(function(){return e(t)}):"complete"!==document.readyState?addEventListener("load",function(){return e(t)},!0):setTimeout(t,0)},X=function(e,t){t=t||{};var r=v("TTFB"),n=E(e,r,V,t.reportAllChanges);q(function(){var o=f();if(o){var i=o.responseStart;if(i<=0||i>performance.now())return;r.value=Math.max(i-y(),0),r.entries=[o],n(!0),g(function(){r=v("TTFB",0),(n=E(e,r,V,t.reportAllChanges))(!0)})}})};e.DataType=void 0,(l=e.DataType||(e.DataType={})).PERFORMANCE="performance",l.ERROR="error",l.BEHAVIOR="behavior",e.PerformanceType=void 0,(d=e.PerformanceType||(e.PerformanceType={})).LCP="LCP",d.INP="INP",d.CLS="CLS",d.FCP="FCP",d.FID="FID",d.TTFB="TTFB",d.NAVIGATION="navigation",d.RESOURCE="resource",d.API="api",e.ErrorType=void 0,(p=e.ErrorType||(e.ErrorType={})).JS_ERROR="js_error",p.PROMISE_ERROR="promise_error",p.RESOURCE_ERROR="resource_error",p.API_ERROR="api_error",p.CUSTOM_ERROR="custom_error",e.BehaviorType=void 0,(h=e.BehaviorType||(e.BehaviorType={})).CLICK="click",h.INPUT="input",h.SCROLL="scroll",h.ROUTE_CHANGE="route_change",h.PAGE_VIEW="page_view";class z{constructor(e){this.observer=null,this.monitor=e,this.init()}init(){this.collectWebVitals(),this.collectNavigationTiming(),this.collectResourceTiming(),this.collectAPITiming()}collectWebVitals(){!function(e,t){t=t||{},P(function(){var r,n=O(),o=v("LCP"),i=function(e){var t=e[e.length-1];t&&t.startTime<n.firstHiddenTime&&(o.value=Math.max(t.startTime-y(),0),o.entries=[t],r())},a=R("largest-contentful-paint",i);if(a){r=E(e,o,U,t.reportAllChanges);var s=S(function(){F[o.id]||(i(a.takeRecords()),a.disconnect(),F[o.id]=!0,r(!0))});["keydown","click"].forEach(function(e){addEventListener(e,function(){return setTimeout(s,0)},!0)}),T(s),g(function(n){o=v("LCP"),r=E(e,o,U,t.reportAllChanges),w(function(){o.value=performance.now()-n.timeStamp,F[o.id]=!0,r(!0)})})}})}(t=>{this.reportMetric({type:e.PerformanceType.LCP,name:"LCP",value:t.value,rating:t.rating,delta:t.delta,entries:t.entries})}),function(e,t){t=t||{},P(function(){var r,n=O(),o=v("FID"),i=function(e){e.startTime<n.firstHiddenTime&&(o.value=e.processingStart-e.startTime,o.entries.push(e),r(!0))},c=function(e){e.forEach(i)},l=R("first-input",c);r=E(e,o,x,t.reportAllChanges),l&&T(S(function(){c(l.takeRecords()),l.disconnect()})),l&&g(function(){var n;o=v("FID"),r=E(e,o,x,t.reportAllChanges),u=[],s=-1,a=null,Q(addEventListener),n=i,u.push(n),H()})})}(t=>{this.reportMetric({type:e.PerformanceType.FID,name:"FID",value:t.value,rating:t.rating,delta:t.delta,entries:t.entries})}),function(e,t){t=t||{},A(S(function(){var r,n=v("CLS",0),o=0,i=[],a=function(e){e.forEach(function(e){if(!e.hadRecentInput){var t=i[0],r=i[i.length-1];o&&e.startTime-r.startTime<1e3&&e.startTime-t.startTime<5e3?(o+=e.value,i.push(e)):(o=e.value,i=[e])}}),o>n.value&&(n.value=o,n.entries=i,r())},s=R("layout-shift",a);s&&(r=E(e,n,M,t.reportAllChanges),T(function(){a(s.takeRecords()),r(!0)}),g(function(){o=0,n=v("CLS",0),r=E(e,n,M,t.reportAllChanges),w(function(){return r()})}),setTimeout(r,0))}))}(t=>{this.reportMetric({type:e.PerformanceType.CLS,name:"CLS",value:t.value,rating:t.rating,delta:t.delta,entries:t.entries})}),A(t=>{this.reportMetric({type:e.PerformanceType.FCP,name:"FCP",value:t.value,rating:t.rating,delta:t.delta,entries:t.entries})}),X(t=>{this.reportMetric({type:e.PerformanceType.TTFB,name:"TTFB",value:t.value,rating:t.rating,delta:t.delta,entries:t.entries})})}collectNavigationTiming(){window.addEventListener("load",()=>{setTimeout(()=>{const t=performance.getEntriesByType("navigation")[0];if(!t)return;const r={dnsLookup:t.domainLookupEnd-t.domainLookupStart,tcpConnect:t.connectEnd-t.connectStart,sslConnect:t.secureConnectionStart>0?t.connectEnd-t.secureConnectionStart:0,request:t.responseStart-t.requestStart,response:t.responseEnd-t.responseStart,domParse:t.domInteractive-t.responseEnd,domContentLoaded:t.domContentLoadedEventEnd-t.fetchStart,loadComplete:t.loadEventEnd-t.fetchStart,firstPaint:this.getFirstPaint(),firstContentfulPaint:this.getFirstContentfulPaint()};this.reportMetric({type:e.PerformanceType.NAVIGATION,name:"Navigation Timing",value:r.loadComplete,entries:[t],navigationType:this.getNavigationType("number"==typeof t.type?t.type:0)}),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.PERFORMANCE,category:"navigation",message:"Page loaded",level:"info",data:r})},0)})}collectResourceTiming(){if(PerformanceObserver)try{this.observer=new PerformanceObserver(t=>{t.getEntries().forEach(t=>{if("resource"===t.entryType){const r=t;if(r.name.includes(this.monitor.appId))return;this.reportMetric({type:e.PerformanceType.RESOURCE,name:r.name,value:r.duration,entries:[t]}),r.duration>3e3&&this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.PERFORMANCE,category:"resource",message:`Slow resource: ${r.name}`,level:"warning",data:{duration:r.duration,size:r.transferSize||0}})}})}),this.observer.observe({entryTypes:["resource"]})}catch(e){}}collectAPITiming(){const t=window.fetch;window.fetch=async(...r)=>{const n=performance.now(),o="string"==typeof r[0]?r[0]:r[0].url;try{const i=await t.apply(window,r),a=performance.now()-n;return this.reportMetric({type:e.PerformanceType.API,name:o,value:a,entries:[]}),a>2e3&&this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.PERFORMANCE,category:"api",message:`Slow API: ${o}`,level:"warning",data:{duration:a,status:i.status}}),i}catch(t){const r=performance.now()-n;throw this.reportMetric({type:e.PerformanceType.API,name:o,value:r,entries:[]}),t}};const r=XMLHttpRequest.prototype.open,n=XMLHttpRequest.prototype.send,o=this;XMLHttpRequest.prototype.open=function(e,t,n,o,i){return this._monitor_url=t.toString(),this._monitor_startTime=performance.now(),r.call(this,e,t,null==n||n,o,i)},XMLHttpRequest.prototype.send=function(t){const r=this,i=r._monitor_startTime,a=r._monitor_url;return r.addEventListener("readystatechange",()=>{if(4===r.readyState){const t=performance.now()-i;o&&a&&(o.reportMetric({type:e.PerformanceType.API,name:a,value:t,entries:[]}),t>2e3&&o.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.PERFORMANCE,category:"api",message:`Slow XHR: ${a}`,level:"warning",data:{duration:t,status:r.status}}))}}),n.call(this,t)}}getFirstPaint(){const e=performance.getEntriesByType("paint").find(e=>"first-paint"===e.name);return e?e.startTime:0}getFirstContentfulPaint(){const e=performance.getEntriesByType("paint").find(e=>"first-contentful-paint"===e.name);return e?e.startTime:0}getNavigationType(e){return["navigate","reload","back_forward","prerender"][e]||"unknown"}reportMetric(t){this.monitor.report({type:e.DataType.PERFORMANCE,data:t})}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null)}}class K{constructor(e){this.monitor=e,this.originalFetch=window.fetch,this.originalXHROpen=XMLHttpRequest.prototype.open,this.originalXHRSend=XMLHttpRequest.prototype.send,this.init()}init(){this.handleJSError(),this.handlePromiseError(),this.handleResourceError(),this.handleAPIError()}handleJSError(){window.addEventListener("error",t=>{const{message:r,filename:n,lineno:o,colno:i,error:a}=t,s={type:e.ErrorType.JS_ERROR,message:r||"Unknown error",filename:n,lineno:o,colno:i,stack:null==a?void 0:a.stack};this.reportError(s),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"javascript",message:`JS Error: ${r}`,level:"error",data:{filename:n,lineno:o,colno:i}})},!0)}handlePromiseError(){window.addEventListener("unhandledrejection",t=>{let r="Unhandled Promise Rejection",n="";if(t.reason)if(t.reason instanceof Error)r=t.reason.message,n=t.reason.stack||"";else if("string"==typeof t.reason)r=t.reason;else try{r=JSON.stringify(t.reason)}catch(e){r=String(t.reason)}const o={type:e.ErrorType.PROMISE_ERROR,message:r,stack:n};this.reportError(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"promise",message:`Promise Error: ${r}`,level:"error",data:{reason:t.reason}})})}handleResourceError(){window.addEventListener("error",t=>{const r=t.target;if(r&&r!==window&&("IMG"===r.tagName||"SCRIPT"===r.tagName||"LINK"===r.tagName||"AUDIO"===r.tagName||"VIDEO"===r.tagName)){const t={type:e.ErrorType.RESOURCE_ERROR,message:`Resource load error: ${r.tagName}`,resourceUrl:r.src||r.href||"",elementSelector:n(r)};this.reportError(t),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"resource",message:`Resource Error: ${r.tagName}`,level:"error",data:{url:t.resourceUrl,element:r.tagName}})}},!0)}handleAPIError(){window.fetch=async(...t)=>{const r="string"==typeof t[0]?t[0]:t[0].url,n=Date.now();try{const o=await this.originalFetch.apply(window,t);if(!o.ok){const t={type:e.ErrorType.API_ERROR,message:`API Error: ${o.status} ${o.statusText}`,resourceUrl:r,statusCode:o.status};this.reportError(t),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"api",message:`API Error: ${r}`,level:"error",data:{status:o.status,statusText:o.statusText,duration:Date.now()-n}})}return o}catch(t){const o={type:e.ErrorType.API_ERROR,message:`Network Error: ${t instanceof Error?t.message:"Unknown error"}`,resourceUrl:r,stack:t instanceof Error?t.stack:void 0};throw this.reportError(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"api",message:`Network Error: ${r}`,level:"error",data:{error:t instanceof Error?t.message:String(t),duration:Date.now()-n}}),t}};const t=this;XMLHttpRequest.prototype.open=function(e,r,n,o,i){return this._monitor_url=r.toString(),this._monitor_method=e,this._monitor_startTime=Date.now(),t.originalXHROpen.call(this,e,r,null==n||n,o,i)},XMLHttpRequest.prototype.send=function(r){const n=this,o=n._monitor_url,i=n._monitor_method,a=n._monitor_startTime;return n.addEventListener("error",()=>{const r={type:e.ErrorType.API_ERROR,message:`XMLHttpRequest Error: ${i} ${o}`,resourceUrl:o,statusCode:n.status};t.reportError(r),t.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"api",message:`XHR Error: ${i} ${o}`,level:"error",data:{method:i,status:n.status,duration:Date.now()-a}})}),n.addEventListener("load",()=>{if(n.status>=400){const r={type:e.ErrorType.API_ERROR,message:`API Error: ${n.status} ${n.statusText}`,resourceUrl:o,statusCode:n.status};t.reportError(r),t.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"api",message:`XHR ${n.status}: ${i} ${o}`,level:"error",data:{method:i,status:n.status,statusText:n.statusText,duration:Date.now()-a}})}}),t.originalXHRSend.call(this,r)}}reportError(t){this.monitor.report({type:e.DataType.ERROR,data:t})}reportCustomError(t,r){const n={type:e.ErrorType.CUSTOM_ERROR,message:t,stack:(new Error).stack,...r};this.reportError(n),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"custom",message:`Custom Error: ${t}`,level:"error",data:r})}destroy(){window.fetch=this.originalFetch,XMLHttpRequest.prototype.open=this.originalXHROpen,XMLHttpRequest.prototype.send=this.originalXHRSend}}class j{constructor(e){this.monitor=e,this.currentUrl=window.location.href,this.startTime=Date.now(),this.init()}init(){this.trackPageView(),this.trackClicks(),this.trackInputs(),this.trackScrolls(),this.trackRouteChanges()}trackPageView(){const t={type:e.BehaviorType.PAGE_VIEW,url:this.currentUrl};this.reportBehavior(t),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.BEHAVIOR,category:"navigation",message:`Page view: ${this.currentUrl}`,level:"info",data:{url:this.currentUrl,referrer:document.referrer}})}trackClicks(){document.addEventListener("click",t=>{const r=t.target;if(!r)return;const o={type:e.BehaviorType.CLICK,element:r.tagName,selector:n(r),text:(i=r,"INPUT"===i.tagName?i.value||i.placeholder||"":(null===(a=i.textContent)||void 0===a?void 0:a.trim().slice(0,100))||"")};var i,a;this.reportBehavior(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.BEHAVIOR,category:"interaction",message:`Click: ${r.tagName}`,level:"info",data:{text:o.text,selector:o.selector}})},!0)}trackInputs(){const t=function(e,t){let r=null;return function(...n){const o=this;r&&clearTimeout(r),r=window.setTimeout(()=>{e.apply(o,n),r=null},t)}}(t=>{const r=t.target;if(!r||"password"===r.type)return;const o={type:e.BehaviorType.INPUT,element:r.tagName,selector:n(r),text:"password"===r.type?"***":r.value.slice(0,100)};this.reportBehavior(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.BEHAVIOR,category:"interaction",message:`Input: ${r.tagName}`,level:"info",data:{type:r.type,selector:o.selector}})},500);document.addEventListener("input",t,!0),document.addEventListener("change",t,!0)}trackScrolls(){let t=0;const r=function(e,t){let r=null,n=0;return function(...o){const i=Date.now(),a=this;i-n>t?(e.apply(a,o),n=i):(r&&clearTimeout(r),r=window.setTimeout(()=>{e.apply(a,o),n=Date.now(),r=null},t-(i-n)))}}(()=>{const r=window.pageYOffset||document.documentElement.scrollTop,n=window.innerHeight,o=document.documentElement.scrollHeight,i=Math.round((r+n)/o*100);if(i>t&&(t=i,i>=25&&i%25==0)){const t={type:e.BehaviorType.SCROLL,text:`${i}%`};this.reportBehavior(t),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.BEHAVIOR,category:"interaction",message:`Scroll: ${i}%`,level:"info",data:{depth:i,scrollTop:r,documentHeight:o}})}},1e3);window.addEventListener("scroll",r,{passive:!0})}trackRouteChanges(){const t=history.pushState,r=history.replaceState,n=(t,r)=>{const n=Date.now()-this.startTime,o={type:e.BehaviorType.ROUTE_CHANGE,from:t,to:r,duration:n};this.reportBehavior(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.BEHAVIOR,category:"navigation",message:`Route change: ${t} -> ${r}`,level:"info",data:{from:t,to:r,duration:n}}),this.currentUrl=r,this.startTime=Date.now()};history.pushState=function(e,r,o){const i=window.location.href,a=t.apply(this,arguments),s=window.location.href;return i!==s&&n(i,s),a},history.replaceState=function(e,t,o){const i=window.location.href,a=r.apply(this,arguments),s=window.location.href;return i!==s&&n(i,s),a},window.addEventListener("popstate",()=>{const e=window.location.href;n(this.currentUrl,e)}),window.addEventListener("hashchange",()=>{const e=window.location.href;n(this.currentUrl,e)})}reportCustomBehavior(t,r){const n={type:t,...r};this.reportBehavior(n),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.DataType.BEHAVIOR,category:"custom",message:`Custom behavior: ${t}`,level:"info",data:r})}reportBehavior(t){this.monitor.report({type:e.DataType.BEHAVIOR,data:t})}destroy(){}}const G={name:"vue",install(t){if("undefined"!=typeof window&&window.Vue){window.Vue.config.errorHandler=(r,n,o)=>{var i,a;const s={type:e.ErrorType.JS_ERROR,message:r.message,stack:r.stack,source:`Vue ${o}`,filename:(null===(i=null==n?void 0:n.$options)||void 0===i?void 0:i.__file)||"Vue Component"};t.report({type:e.DataType.ERROR,data:s}),t.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"vue",message:`Vue Error: ${r.message}`,level:"error",data:{info:o,component:(null===(a=null==n?void 0:n.$options)||void 0===a?void 0:a.name)||"Anonymous Component"}})}}if("undefined"!=typeof window&&window.Vue&&window.Vue.version&&window.Vue.version.startsWith("3")){window.Vue.createApp({}).config.errorHandler=(r,n,o)=>{var i,a;const s={type:e.ErrorType.JS_ERROR,message:r.message,stack:r.stack,source:`Vue3 ${o}`,filename:(null===(i=null==n?void 0:n.$options)||void 0===i?void 0:i.__file)||"Vue3 Component"};t.report({type:e.DataType.ERROR,data:s}),t.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"vue3",message:`Vue3 Error: ${r.message}`,level:"error",data:{info:o,component:(null===(a=null==n?void 0:n.type)||void 0===a?void 0:a.name)||"Anonymous Component"}})}}}},J={name:"react",install(t){if("undefined"!=typeof window&&window.React){const r=window.React.createElement;window.React.createElement=function(n,o,...i){if("function"==typeof n&&n.prototype&&n.prototype.isReactComponent){const r=n.prototype.componentDidCatch;n.prototype.componentDidCatch=function(o,i){const a={type:e.ErrorType.JS_ERROR,message:o.message,stack:o.stack,source:"React Component",filename:i.componentStack};t.report({type:e.DataType.ERROR,data:a}),t.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"react",message:`React Error: ${o.message}`,level:"error",data:{componentStack:i.componentStack,component:n.name||"Anonymous Component"}}),r&&r.call(this,o,i)}}return r.apply(this,arguments)}}if("undefined"!=typeof window&&window.ReactDOM&&window.ReactDOM.createRoot){const r=window.ReactDOM.createRoot;window.ReactDOM.createRoot=function(n,o={}){const i={...o,onRecoverableError:(r,n)=>{const i={type:e.ErrorType.JS_ERROR,message:r.message,stack:r.stack,source:"React Recoverable Error"};t.report({type:e.DataType.ERROR,data:i}),t.addBreadcrumb({timestamp:Date.now(),type:e.DataType.ERROR,category:"react",message:`React Recoverable Error: ${r.message}`,level:"warning",data:n}),o.onRecoverableError&&o.onRecoverableError(r,n)}};return r.call(this,n,i)}}}};class WebMonitorSDK{constructor(e){this.isInitialized=!1,/bot|crawler|spider|crawling/i.test(navigator.userAgent)?this.monitor={}:(this.monitor=new i(e),this.init(),window.__webMonitorSDK=this)}init(){if(!this.isInitialized)try{this.monitor.config.enablePerformance&&(this.performanceMonitor=new z(this.monitor)),this.monitor.config.enableError&&(this.errorMonitor=new K(this.monitor)),this.monitor.config.enableBehavior&&(this.behaviorMonitor=new j(this.monitor)),this.isInitialized=!0,this.monitor.isDebug}catch(e){}}reportError(e,t){this.errorMonitor&&this.errorMonitor.reportCustomError(e,t)}reportBehavior(e,t){this.behaviorMonitor&&this.behaviorMonitor.reportCustomBehavior(e,t)}report(e){this.monitor.report(e)}use(e){return this.monitor.use(e),this}unuse(e){return this.monitor.unuse(e),this}setUser(e,t){this.monitor.userId=e,this.monitor.addBreadcrumb({timestamp:Date.now(),type:"behavior",category:"user",message:`User set: ${e}`,level:"info",data:t})}setTag(e,t){this.monitor.tags||(this.monitor.tags={}),this.monitor.tags[e]=t}setContext(e,t){this.monitor.contexts||(this.monitor.contexts={}),this.monitor.contexts[e]=t}destroy(){var e,t,r;this.isInitialized&&(null===(e=this.performanceMonitor)||void 0===e||e.destroy(),null===(t=this.errorMonitor)||void 0===t||t.destroy(),null===(r=this.behaviorMonitor)||void 0===r||r.destroy(),this.monitor.destroy(),this.isInitialized=!1,delete window.__webMonitorSDK,this.monitor.isDebug)}getConfig(){return this.monitor.config}getSessionId(){return this.monitor.currentSessionId}getUserId(){return this.monitor.currentUserId}}e.ReactPlugin=J,e.VuePlugin=G,e.WebMonitorSDK=WebMonitorSDK,e.createWebMonitorSDK=function(e){return new WebMonitorSDK(e)},e.default=WebMonitorSDK,Object.defineProperty(e,"__esModule",{value:!0})});
