var e,t,r,o,n;!function(e){e.PERFORMANCE="performance",e.ERROR="error",e.BEHAVIOR="behavior"}(e||(e={})),function(e){e.LCP="LCP",e.INP="INP",e.CLS="CLS",e.FCP="FCP",e.FID="FID",e.TTFB="TTFB",e.NAVIGATION="navigation",e.RESOURCE="resource",e.API="api"}(t||(t={})),function(e){e.JS_ERROR="js_error",e.PROMISE_ERROR="promise_error",e.RESOURCE_ERROR="resource_error",e.API_ERROR="api_error",e.CUSTOM_ERROR="custom_error"}(r||(r={})),function(e){e.CLICK="click",e.INPUT="input",e.SCROLL="scroll",e.ROUTE_CHANGE="route_change",e.PAGE_VIEW="page_view"}(o||(o={})),function(e){e.LOW="low",e.MEDIUM="medium",e.HIGH="high"}(n||(n={}));class i{constructor(){this.STORAGE_KEY="web_monitor_queue",this.MAX_STORAGE_SIZE=1048576}save(e){if(!this.isLocalStorageAvailable())return!1;try{const t=JSON.stringify(e);return t.length>this.MAX_STORAGE_SIZE?(console.warn("WebMonitorSDK: Data too large for localStorage"),!1):(localStorage.setItem(this.STORAGE_KEY,t),!0)}catch(e){return console.warn("WebMonitorSDK: Failed to save to localStorage:",e),!1}}load(){if(!this.isLocalStorageAvailable())return[];try{const e=localStorage.getItem(this.STORAGE_KEY);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return console.warn("WebMonitorSDK: Failed to load from localStorage:",e),this.clear(),[]}}clear(){if(this.isLocalStorageAvailable())try{localStorage.removeItem(this.STORAGE_KEY)}catch(e){console.warn("WebMonitorSDK: Failed to clear localStorage:",e)}}isLocalStorageAvailable(){try{const e="__localStorage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}getStorageSize(){if(!this.isLocalStorageAvailable())return 0;try{const e=localStorage.getItem(this.STORAGE_KEY);return e?e.length:0}catch(e){return 0}}}class s{constructor(e){var t,r,o,n,s,a,c,u,l;this.highPriorityQueue=[],this.mediumPriorityQueue=[],this.lowPriorityQueue=[],this.reportTimer=null,this.isDestroyed=!1,this.pendingRequests=0,this.retryQueue=[],this.options={url:e.url,timeout:null!==(t=e.timeout)&&void 0!==t?t:5e3,withCredentials:null!==(r=e.withCredentials)&&void 0!==r&&r,headers:null!==(o=e.headers)&&void 0!==o?o:{},reportInterval:null!==(n=e.reportInterval)&&void 0!==n?n:6e4,batchSize:null!==(s=e.batchSize)&&void 0!==s?s:10,maxQueueSize:null!==(a=e.maxQueueSize)&&void 0!==a?a:100,enableImmediateReport:null===(c=e.enableImmediateReport)||void 0===c||c,retryCount:null!==(u=e.retryCount)&&void 0!==u?u:3,retryInterval:null!==(l=e.retryInterval)&&void 0!==l?l:1e3},this.storageManager=new i,this.loadDataFromStorage(),this.startReportTimer(),this.setupBeforeUnload(),this.startRetryTimer()}loadDataFromStorage(){this.storageManager.load().forEach(e=>{const t=e.priority||this.getDefaultPriority(e.type);this.addToQueue(e,t)}),this.storageManager.clear()}saveDataToStorage(){const e=[...this.highPriorityQueue,...this.mediumPriorityQueue,...this.lowPriorityQueue];e.length>0&&this.storageManager.save(e)}startReportTimer(){this.reportTimer=window.setInterval(()=>{this.processQueuedData()},this.options.reportInterval)}startRetryTimer(){setInterval(()=>{this.processRetryQueue()},this.options.retryInterval)}setupBeforeUnload(){window.addEventListener("beforeunload",()=>{this.saveDataToStorage(),this.flushAllQueues()}),window.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&(this.saveDataToStorage(),this.flushAllQueues())})}flushAllQueues(){const e=[...this.highPriorityQueue,...this.mediumPriorityQueue,...this.lowPriorityQueue];e.length>0&&(this.trySendBeacon(e),this.highPriorityQueue=[],this.mediumPriorityQueue=[],this.lowPriorityQueue=[])}send(e){if(this.isDestroyed)return;const t=e.priority||this.getDefaultPriority(e.type);t===n.HIGH&&this.options.enableImmediateReport?this.sendImmediately([e]):(this.addToQueue(e,t),this.checkQueueOverflow())}processQueuedData(){if(this.isDestroyed||this.pendingRequests>3)return;const e=this.highPriorityQueue.length>0||this.mediumPriorityQueue.length>0||this.lowPriorityQueue.length>0;if(this.mediumPriorityQueue.length>0){const e=this.mediumPriorityQueue.splice(0,this.options.batchSize);this.sendBatch(e,n.MEDIUM)}if(this.lowPriorityQueue.length>0){const e=this.lowPriorityQueue.splice(0,this.options.batchSize);this.sendBatch(e,n.LOW)}e&&this.storageManager.clear()}sendBatch(e,t){if(this.isDestroyed)return;this.pendingRequests++;const r=JSON.stringify(e),o=t===n.HIGH?this.trySendBeacon(e)||this.sendFetch(r):this.sendFetch(r).catch(()=>this.sendXHR(r));Promise.resolve(o).then(()=>{var r;this.pendingRequests--,(null===(r=this.options.headers)||void 0===r?void 0:r.debug)&&console.log(`数据上报成功: ${e.length} 条数据, 优先级: ${t}`)}).catch(()=>{this.pendingRequests--,this.addToRetryQueue(e)})}sendImmediately(e){this.sendBatch(e,n.HIGH)}trySendBeacon(e){if(!navigator.sendBeacon)return null;try{const t=JSON.stringify(e),r=new Blob([t],{type:"application/json"});return navigator.sendBeacon(this.options.url,r)?Promise.resolve():Promise.reject(new Error("SendBeacon failed"))}catch(e){return Promise.reject(e)}}getDefaultPriority(e){switch(e){case"error":return n.HIGH;case"performance":default:return n.MEDIUM;case"behavior":return n.LOW}}addToQueue(e,t){switch(t){case n.HIGH:this.highPriorityQueue.push(e);break;case n.MEDIUM:this.mediumPriorityQueue.push(e);break;case n.LOW:this.lowPriorityQueue.push(e)}}checkQueueOverflow(){this.highPriorityQueue.length+this.mediumPriorityQueue.length+this.lowPriorityQueue.length>=this.options.maxQueueSize&&this.processQueuedData()}addToRetryQueue(e){const t={data:e,retryCount:0,nextRetryTime:Date.now()+this.options.retryInterval};this.retryQueue.push(t)}processRetryQueue(){if(0===this.retryQueue.length||this.pendingRequests>3)return;const e=Date.now();this.retryQueue.filter(t=>e>=t.nextRetryTime).forEach(t=>{if(t.retryCount<this.options.retryCount)t.retryCount++,t.nextRetryTime=e+this.options.retryInterval*Math.pow(2,t.retryCount),this.sendBatch(t.data,n.MEDIUM);else{const e=this.retryQueue.indexOf(t);e>-1&&this.retryQueue.splice(e,1)}})}async sendFetch(e){const t=new AbortController,r=setTimeout(()=>t.abort(),this.options.timeout);try{await fetch(this.options.url,{method:"POST",headers:{"Content-Type":"application/json",...this.options.headers},body:e,credentials:this.options.withCredentials?"include":"omit",signal:t.signal})}finally{clearTimeout(r)}}sendXHR(e){const t=new XMLHttpRequest;t.open("POST",this.options.url,!0),t.timeout=this.options.timeout,t.withCredentials=this.options.withCredentials,t.setRequestHeader("Content-Type","application/json"),Object.entries(this.options.headers).forEach(([e,r])=>{t.setRequestHeader(e,r)}),t.onerror=()=>{},t.ontimeout=()=>{};try{t.send(e)}catch(e){}}destroy(){this.isDestroyed=!0,this.reportTimer&&(clearInterval(this.reportTimer),this.reportTimer=null),this.flushAllQueues(),this.retryQueue=[]}getQueueStatus(){return{high:this.highPriorityQueue.length,medium:this.mediumPriorityQueue.length,low:this.lowPriorityQueue.length,retry:this.retryQueue.length,pending:this.pendingRequests}}flush(){this.processQueuedData()}}function a(e){const t=[];let r=e;for(;r&&r.nodeType===Node.ELEMENT_NODE;){let e=r.nodeName.toLowerCase();if(r.id){e+=`#${r.id}`,t.unshift(e);break}{let t=1,o=r.previousElementSibling;for(;o;)o.nodeName.toLowerCase()===e&&t++,o=o.previousElementSibling;t>1&&(e+=`:nth-child(${t})`)}t.unshift(e),r=r.parentElement}return t.join(" > ")}class c{constructor(e){this.breadcrumbs=[],this.plugins=new Map,this.isDestroyed=!1,this.config=this.mergeConfig(e),this.sessionId=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,this.userId=function(){const e=localStorage.getItem("web_monitor_user_id");if(e)return e;const t=`user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{localStorage.setItem("web_monitor_user_id",t)}catch(e){}return t}(),this.transport=new s({url:this.config.reportUrl,reportInterval:this.config.reportInterval,batchSize:this.config.batchSize,maxQueueSize:this.config.maxQueueSize,enableImmediateReport:this.config.enableImmediateReport}),this.init()}mergeConfig(e){var t,r,o,n,i,s,a,c,u,l,d;return{appId:e.appId,reportUrl:e.reportUrl,sampling:null!==(t=e.sampling)&&void 0!==t?t:1,debug:null!==(r=e.debug)&&void 0!==r&&r,enablePerformance:null===(o=e.enablePerformance)||void 0===o||o,enableError:null===(n=e.enableError)||void 0===n||n,enableBehavior:null===(i=e.enableBehavior)||void 0===i||i,maxBreadcrumbsNum:null!==(s=e.maxBreadcrumbsNum)&&void 0!==s?s:20,beforeSend:null!==(a=e.beforeSend)&&void 0!==a?a:e=>e,reportInterval:null!==(c=e.reportInterval)&&void 0!==c?c:6e4,batchSize:null!==(u=e.batchSize)&&void 0!==u?u:10,maxQueueSize:null!==(l=e.maxQueueSize)&&void 0!==l?l:100,enableImmediateReport:null===(d=e.enableImmediateReport)||void 0===d||d}}init(){this.shouldSample()&&this.setupErrorHandling()}shouldSample(){return Math.random()<this.config.sampling}setupErrorHandling(){const e=console.error;console.error=(...t)=>{try{e.apply(console,t)}catch(e){}},window.addEventListener("error",e=>{this.safeExecute(()=>{})}),window.addEventListener("unhandledrejection",e=>{this.safeExecute(()=>{})})}safeExecute(e){try{this.isDestroyed||e()}catch(e){this.config.debug&&console.warn("WebMonitorSDK internal error:",e)}}addBreadcrumb(e){this.breadcrumbs.length>=this.config.maxBreadcrumbsNum&&this.breadcrumbs.shift(),this.breadcrumbs.push(e)}report(e){this.safeExecute(()=>{const t={appId:this.config.appId,timestamp:Date.now(),sessionId:this.sessionId,userId:this.userId,url:window.location.href,userAgent:navigator.userAgent,breadcrumbs:[...this.breadcrumbs],...e},r=this.config.beforeSend(t);r&&(this.transport.send(r),this.config.debug&&console.log("WebMonitorSDK Report:",r))})}use(e){this.plugins.has(e.name)?console.warn(`Plugin ${e.name} already installed`):(this.plugins.set(e.name,e),e.install(this))}unuse(e){const t=this.plugins.get(e);t&&t.uninstall&&t.uninstall(this),this.plugins.delete(e)}destroy(){this.isDestroyed=!0,this.transport.destroy(),this.plugins.forEach(e=>{e.uninstall&&e.uninstall(this)}),this.plugins.clear(),this.breadcrumbs=[]}get isDebug(){return this.config.debug}get appId(){return this.config.appId}get currentSessionId(){return this.sessionId}get currentUserId(){return this.userId}}var u,l,d,h,m=-1,p=function(e){addEventListener("pageshow",function(t){t.persisted&&(m=t.timeStamp,e(t))},!0)},g=function(){return window.performance&&performance.getEntriesByType&&performance.getEntriesByType("navigation")[0]},f=function(){var e=g();return e&&e.activationStart||0},y=function(e,t){var r=g(),o="navigate";return m>=0?o="back-forward-cache":r&&(document.prerendering||f()>0?o="prerender":document.wasDiscarded?o="restore":r.type&&(o=r.type.replace(/_/g,"-"))),{name:e,value:void 0===t?-1:t,rating:"good",delta:0,entries:[],id:"v3-".concat(Date.now(),"-").concat(Math.floor(8999999999999*Math.random())+1e12),navigationType:o}},v=function(e,t,r){try{if(PerformanceObserver.supportedEntryTypes.includes(e)){var o=new PerformanceObserver(function(e){Promise.resolve().then(function(){t(e.getEntries())})});return o.observe(Object.assign({type:e,buffered:!0},r||{})),o}}catch(e){}},w=function(e,t,r,o){var n,i;return function(s){t.value>=0&&(s||o)&&((i=t.value-(n||0))||void 0===n)&&(n=t.value,t.delta=i,t.rating=function(e,t){return e>t[1]?"poor":e>t[0]?"needs-improvement":"good"}(t.value,r),e(t))}},R=function(e){requestAnimationFrame(function(){return requestAnimationFrame(function(){return e()})})},E=function(e){var t=function(t){"pagehide"!==t.type&&"hidden"!==document.visibilityState||e(t)};addEventListener("visibilitychange",t,!0),addEventListener("pagehide",t,!0)},S=function(e){var t=!1;return function(r){t||(e(r),t=!0)}},b=-1,I=function(){return"hidden"!==document.visibilityState||document.prerendering?1/0:0},T=function(e){"hidden"===document.visibilityState&&b>-1&&(b="visibilitychange"===e.type?e.timeStamp:0,C())},P=function(){addEventListener("visibilitychange",T,!0),addEventListener("prerenderingchange",T,!0)},C=function(){removeEventListener("visibilitychange",T,!0),removeEventListener("prerenderingchange",T,!0)},O=function(){return b<0&&(b=I(),P(),p(function(){setTimeout(function(){b=I(),P()},0)})),{get firstHiddenTime(){return b}}},D=function(e){document.prerendering?addEventListener("prerenderingchange",function(){return e()},!0):e()},M=[1800,3e3],_=function(e,t){t=t||{},D(function(){var r,o=O(),n=y("FCP"),i=v("paint",function(e){e.forEach(function(e){"first-contentful-paint"===e.name&&(i.disconnect(),e.startTime<o.firstHiddenTime&&(n.value=Math.max(e.startTime-f(),0),n.entries.push(e),r(!0)))})});i&&(r=w(e,n,M,t.reportAllChanges),p(function(o){n=y("FCP"),r=w(e,n,M,t.reportAllChanges),R(function(){n.value=performance.now()-o.timeStamp,r(!0)})}))})},L=[.1,.25],A={passive:!0,capture:!0},B=new Date,Q=function(e,t){u||(u=t,l=e,d=new Date,N(removeEventListener),H())},H=function(){if(l>=0&&l<d-B){var e={entryType:"first-input",name:u.type,target:u.target,cancelable:u.cancelable,startTime:u.timeStamp,processingStart:u.timeStamp+l};h.forEach(function(t){t(e)}),h=[]}},k=function(e){if(e.cancelable){var t=(e.timeStamp>1e12?new Date:performance.now())-e.timeStamp;"pointerdown"==e.type?function(e,t){var r=function(){Q(e,t),n()},o=function(){n()},n=function(){removeEventListener("pointerup",r,A),removeEventListener("pointercancel",o,A)};addEventListener("pointerup",r,A),addEventListener("pointercancel",o,A)}(t,e):Q(t,e)}},N=function(e){["mousedown","keydown","touchstart","pointerdown"].forEach(function(t){return e(t,k,A)})},$=[100,300],U=[2500,4e3],F={},x=[800,1800],V=function e(t){document.prerendering?D(function(){return e(t)}):"complete"!==document.readyState?addEventListener("load",function(){return e(t)},!0):setTimeout(t,0)},q=function(e,t){t=t||{};var r=y("TTFB"),o=w(e,r,x,t.reportAllChanges);V(function(){var n=g();if(n){var i=n.responseStart;if(i<=0||i>performance.now())return;r.value=Math.max(i-f(),0),r.entries=[n],o(!0),p(function(){r=y("TTFB",0),(o=w(e,r,x,t.reportAllChanges))(!0)})}})};class z{constructor(e){this.observer=null,this.monitor=e,this.init()}init(){this.collectWebVitals(),this.collectNavigationTiming(),this.collectResourceTiming(),this.collectAPITiming()}collectWebVitals(){!function(e,t){t=t||{},D(function(){var r,o=O(),n=y("LCP"),i=function(e){var t=e[e.length-1];t&&t.startTime<o.firstHiddenTime&&(n.value=Math.max(t.startTime-f(),0),n.entries=[t],r())},s=v("largest-contentful-paint",i);if(s){r=w(e,n,U,t.reportAllChanges);var a=S(function(){F[n.id]||(i(s.takeRecords()),s.disconnect(),F[n.id]=!0,r(!0))});["keydown","click"].forEach(function(e){addEventListener(e,function(){return setTimeout(a,0)},!0)}),E(a),p(function(o){n=y("LCP"),r=w(e,n,U,t.reportAllChanges),R(function(){n.value=performance.now()-o.timeStamp,F[n.id]=!0,r(!0)})})}})}(e=>{this.reportMetric({type:t.LCP,name:"LCP",value:e.value,rating:e.rating,delta:e.delta,entries:e.entries})}),function(e,t){t=t||{},D(function(){var r,o=O(),n=y("FID"),i=function(e){e.startTime<o.firstHiddenTime&&(n.value=e.processingStart-e.startTime,n.entries.push(e),r(!0))},s=function(e){e.forEach(i)},a=v("first-input",s);r=w(e,n,$,t.reportAllChanges),a&&E(S(function(){s(a.takeRecords()),a.disconnect()})),a&&p(function(){var o;n=y("FID"),r=w(e,n,$,t.reportAllChanges),h=[],l=-1,u=null,N(addEventListener),o=i,h.push(o),H()})})}(e=>{this.reportMetric({type:t.FID,name:"FID",value:e.value,rating:e.rating,delta:e.delta,entries:e.entries})}),function(e,t){t=t||{},_(S(function(){var r,o=y("CLS",0),n=0,i=[],s=function(e){e.forEach(function(e){if(!e.hadRecentInput){var t=i[0],r=i[i.length-1];n&&e.startTime-r.startTime<1e3&&e.startTime-t.startTime<5e3?(n+=e.value,i.push(e)):(n=e.value,i=[e])}}),n>o.value&&(o.value=n,o.entries=i,r())},a=v("layout-shift",s);a&&(r=w(e,o,L,t.reportAllChanges),E(function(){s(a.takeRecords()),r(!0)}),p(function(){n=0,o=y("CLS",0),r=w(e,o,L,t.reportAllChanges),R(function(){return r()})}),setTimeout(r,0))}))}(e=>{this.reportMetric({type:t.CLS,name:"CLS",value:e.value,rating:e.rating,delta:e.delta,entries:e.entries})}),_(e=>{this.reportMetric({type:t.FCP,name:"FCP",value:e.value,rating:e.rating,delta:e.delta,entries:e.entries})}),q(e=>{this.reportMetric({type:t.TTFB,name:"TTFB",value:e.value,rating:e.rating,delta:e.delta,entries:e.entries})})}collectNavigationTiming(){window.addEventListener("load",()=>{setTimeout(()=>{const r=performance.getEntriesByType("navigation")[0];if(!r)return;const o={dnsLookup:r.domainLookupEnd-r.domainLookupStart,tcpConnect:r.connectEnd-r.connectStart,sslConnect:r.secureConnectionStart>0?r.connectEnd-r.secureConnectionStart:0,request:r.responseStart-r.requestStart,response:r.responseEnd-r.responseStart,domParse:r.domInteractive-r.responseEnd,domContentLoaded:r.domContentLoadedEventEnd-r.fetchStart,loadComplete:r.loadEventEnd-r.fetchStart,firstPaint:this.getFirstPaint(),firstContentfulPaint:this.getFirstContentfulPaint()};this.reportMetric({type:t.NAVIGATION,name:"Navigation Timing",value:o.loadComplete,entries:[r],navigationType:this.getNavigationType("number"==typeof r.type?r.type:0)}),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.PERFORMANCE,category:"navigation",message:"Page loaded",level:"info",data:o})},0)})}collectResourceTiming(){if(PerformanceObserver)try{this.observer=new PerformanceObserver(r=>{r.getEntries().forEach(r=>{if("resource"===r.entryType){const o=r;if(o.name.includes(this.monitor.appId))return;this.reportMetric({type:t.RESOURCE,name:o.name,value:o.duration,entries:[r]}),o.duration>3e3&&this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.PERFORMANCE,category:"resource",message:`Slow resource: ${o.name}`,level:"warning",data:{duration:o.duration,size:o.transferSize||0}})}})}),this.observer.observe({entryTypes:["resource"]})}catch(e){}}collectAPITiming(){const r=window.fetch;window.fetch=async(...o)=>{const n=performance.now(),i="string"==typeof o[0]?o[0]:o[0].url;try{const s=await r.apply(window,o),a=performance.now()-n;return this.reportMetric({type:t.API,name:i,value:a,entries:[]}),a>2e3&&this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.PERFORMANCE,category:"api",message:`Slow API: ${i}`,level:"warning",data:{duration:a,status:s.status}}),s}catch(e){const r=performance.now()-n;throw this.reportMetric({type:t.API,name:i,value:r,entries:[]}),e}};const o=XMLHttpRequest.prototype.open,n=XMLHttpRequest.prototype.send,i=this;XMLHttpRequest.prototype.open=function(e,t,r,n,i){return this._monitor_url=t.toString(),this._monitor_startTime=performance.now(),o.call(this,e,t,null==r||r,n,i)},XMLHttpRequest.prototype.send=function(r){const o=this,s=o._monitor_startTime,a=o._monitor_url;return o.addEventListener("readystatechange",()=>{if(4===o.readyState){const r=performance.now()-s;i&&a&&(i.reportMetric({type:t.API,name:a,value:r,entries:[]}),r>2e3&&i.monitor.addBreadcrumb({timestamp:Date.now(),type:e.PERFORMANCE,category:"api",message:`Slow XHR: ${a}`,level:"warning",data:{duration:r,status:o.status}}))}}),n.call(this,r)}}getFirstPaint(){const e=performance.getEntriesByType("paint").find(e=>"first-paint"===e.name);return e?e.startTime:0}getFirstContentfulPaint(){const e=performance.getEntriesByType("paint").find(e=>"first-contentful-paint"===e.name);return e?e.startTime:0}getNavigationType(e){return["navigate","reload","back_forward","prerender"][e]||"unknown"}reportMetric(t){this.monitor.report({type:e.PERFORMANCE,data:t})}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null)}}class X{constructor(e){this.monitor=e,this.originalFetch=window.fetch,this.originalXHROpen=XMLHttpRequest.prototype.open,this.originalXHRSend=XMLHttpRequest.prototype.send,this.init()}init(){this.handleJSError(),this.handlePromiseError(),this.handleResourceError(),this.handleAPIError()}handleJSError(){window.addEventListener("error",t=>{const{message:o,filename:n,lineno:i,colno:s,error:a}=t,c={type:r.JS_ERROR,message:o||"Unknown error",filename:n,lineno:i,colno:s,stack:null==a?void 0:a.stack};this.reportError(c),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.ERROR,category:"javascript",message:`JS Error: ${o}`,level:"error",data:{filename:n,lineno:i,colno:s}})},!0)}handlePromiseError(){window.addEventListener("unhandledrejection",t=>{let o="Unhandled Promise Rejection",n="";if(t.reason)if(t.reason instanceof Error)o=t.reason.message,n=t.reason.stack||"";else if("string"==typeof t.reason)o=t.reason;else try{o=JSON.stringify(t.reason)}catch(e){o=String(t.reason)}const i={type:r.PROMISE_ERROR,message:o,stack:n};this.reportError(i),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.ERROR,category:"promise",message:`Promise Error: ${o}`,level:"error",data:{reason:t.reason}})})}handleResourceError(){window.addEventListener("error",t=>{const o=t.target;if(o&&o!==window&&("IMG"===o.tagName||"SCRIPT"===o.tagName||"LINK"===o.tagName||"AUDIO"===o.tagName||"VIDEO"===o.tagName)){const t={type:r.RESOURCE_ERROR,message:`Resource load error: ${o.tagName}`,resourceUrl:o.src||o.href||"",elementSelector:a(o)};this.reportError(t),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.ERROR,category:"resource",message:`Resource Error: ${o.tagName}`,level:"error",data:{url:t.resourceUrl,element:o.tagName}})}},!0)}handleAPIError(){window.fetch=async(...t)=>{const o="string"==typeof t[0]?t[0]:t[0].url,n=Date.now();try{const i=await this.originalFetch.apply(window,t);if(!i.ok){const t={type:r.API_ERROR,message:`API Error: ${i.status} ${i.statusText}`,resourceUrl:o,statusCode:i.status};this.reportError(t),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.ERROR,category:"api",message:`API Error: ${o}`,level:"error",data:{status:i.status,statusText:i.statusText,duration:Date.now()-n}})}return i}catch(t){const i={type:r.API_ERROR,message:`Network Error: ${t instanceof Error?t.message:"Unknown error"}`,resourceUrl:o,stack:t instanceof Error?t.stack:void 0};throw this.reportError(i),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.ERROR,category:"api",message:`Network Error: ${o}`,level:"error",data:{error:t instanceof Error?t.message:String(t),duration:Date.now()-n}}),t}};const t=this;XMLHttpRequest.prototype.open=function(e,r,o,n,i){return this._monitor_url=r.toString(),this._monitor_method=e,this._monitor_startTime=Date.now(),t.originalXHROpen.call(this,e,r,null==o||o,n,i)},XMLHttpRequest.prototype.send=function(o){const n=this,i=n._monitor_url,s=n._monitor_method,a=n._monitor_startTime;return n.addEventListener("error",()=>{const o={type:r.API_ERROR,message:`XMLHttpRequest Error: ${s} ${i}`,resourceUrl:i,statusCode:n.status};t.reportError(o),t.monitor.addBreadcrumb({timestamp:Date.now(),type:e.ERROR,category:"api",message:`XHR Error: ${s} ${i}`,level:"error",data:{method:s,status:n.status,duration:Date.now()-a}})}),n.addEventListener("load",()=>{if(n.status>=400){const o={type:r.API_ERROR,message:`API Error: ${n.status} ${n.statusText}`,resourceUrl:i,statusCode:n.status};t.reportError(o),t.monitor.addBreadcrumb({timestamp:Date.now(),type:e.ERROR,category:"api",message:`XHR ${n.status}: ${s} ${i}`,level:"error",data:{method:s,status:n.status,statusText:n.statusText,duration:Date.now()-a}})}}),t.originalXHRSend.call(this,o)}}reportError(t){this.monitor.report({type:e.ERROR,data:t})}reportCustomError(t,o){const n={type:r.CUSTOM_ERROR,message:t,stack:(new Error).stack,...o};this.reportError(n),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.ERROR,category:"custom",message:`Custom Error: ${t}`,level:"error",data:o})}destroy(){window.fetch=this.originalFetch,XMLHttpRequest.prototype.open=this.originalXHROpen,XMLHttpRequest.prototype.send=this.originalXHRSend}}class G{constructor(e){this.monitor=e,this.currentUrl=window.location.href,this.startTime=Date.now(),this.init()}init(){this.trackPageView(),this.trackClicks(),this.trackInputs(),this.trackScrolls(),this.trackRouteChanges()}trackPageView(){const t={type:o.PAGE_VIEW,url:this.currentUrl};this.reportBehavior(t),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.BEHAVIOR,category:"navigation",message:`Page view: ${this.currentUrl}`,level:"info",data:{url:this.currentUrl,referrer:document.referrer}})}trackClicks(){document.addEventListener("click",t=>{const r=t.target;if(!r)return;const n={type:o.CLICK,element:r.tagName,selector:a(r),text:(i=r,"INPUT"===i.tagName?i.value||i.placeholder||"":(null===(s=i.textContent)||void 0===s?void 0:s.trim().slice(0,100))||"")};var i,s;this.reportBehavior(n),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.BEHAVIOR,category:"interaction",message:`Click: ${r.tagName}`,level:"info",data:{text:n.text,selector:n.selector}})},!0)}trackInputs(){const t=function(e,t){let r=null;return function(...o){const n=this;r&&clearTimeout(r),r=window.setTimeout(()=>{e.apply(n,o),r=null},t)}}(t=>{const r=t.target;if(!r||"password"===r.type)return;const n={type:o.INPUT,element:r.tagName,selector:a(r),text:"password"===r.type?"***":r.value.slice(0,100)};this.reportBehavior(n),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.BEHAVIOR,category:"interaction",message:`Input: ${r.tagName}`,level:"info",data:{type:r.type,selector:n.selector}})},500);document.addEventListener("input",t,!0),document.addEventListener("change",t,!0)}trackScrolls(){let t=0;const r=function(e,t){let r=null,o=0;return function(...n){const i=Date.now(),s=this;i-o>t?(e.apply(s,n),o=i):(r&&clearTimeout(r),r=window.setTimeout(()=>{e.apply(s,n),o=Date.now(),r=null},t-(i-o)))}}(()=>{const r=window.pageYOffset||document.documentElement.scrollTop,n=window.innerHeight,i=document.documentElement.scrollHeight,s=Math.round((r+n)/i*100);if(s>t&&(t=s,s>=25&&s%25==0)){const t={type:o.SCROLL,text:`${s}%`};this.reportBehavior(t),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.BEHAVIOR,category:"interaction",message:`Scroll: ${s}%`,level:"info",data:{depth:s,scrollTop:r,documentHeight:i}})}},1e3);window.addEventListener("scroll",r,{passive:!0})}trackRouteChanges(){const t=history.pushState,r=history.replaceState,n=(t,r)=>{const n=Date.now()-this.startTime,i={type:o.ROUTE_CHANGE,from:t,to:r,duration:n};this.reportBehavior(i),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.BEHAVIOR,category:"navigation",message:`Route change: ${t} -> ${r}`,level:"info",data:{from:t,to:r,duration:n}}),this.currentUrl=r,this.startTime=Date.now()};history.pushState=function(e,r,o){const i=window.location.href,s=t.apply(this,arguments),a=window.location.href;return i!==a&&n(i,a),s},history.replaceState=function(e,t,o){const i=window.location.href,s=r.apply(this,arguments),a=window.location.href;return i!==a&&n(i,a),s},window.addEventListener("popstate",()=>{const e=window.location.href;n(this.currentUrl,e)}),window.addEventListener("hashchange",()=>{const e=window.location.href;n(this.currentUrl,e)})}reportCustomBehavior(t,r){const o={type:t,...r};this.reportBehavior(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:e.BEHAVIOR,category:"custom",message:`Custom behavior: ${t}`,level:"info",data:r})}reportBehavior(t){this.monitor.report({type:e.BEHAVIOR,data:t})}destroy(){}}const K={name:"vue",install(t){if("undefined"!=typeof window&&window.Vue){window.Vue.config.errorHandler=(o,n,i)=>{var s,a;const c={type:r.JS_ERROR,message:o.message,stack:o.stack,source:`Vue ${i}`,filename:(null===(s=null==n?void 0:n.$options)||void 0===s?void 0:s.__file)||"Vue Component"};t.report({type:e.ERROR,data:c}),t.addBreadcrumb({timestamp:Date.now(),type:e.ERROR,category:"vue",message:`Vue Error: ${o.message}`,level:"error",data:{info:i,component:(null===(a=null==n?void 0:n.$options)||void 0===a?void 0:a.name)||"Anonymous Component"}})}}if("undefined"!=typeof window&&window.Vue&&window.Vue.version&&window.Vue.version.startsWith("3")){window.Vue.createApp({}).config.errorHandler=(o,n,i)=>{var s,a;const c={type:r.JS_ERROR,message:o.message,stack:o.stack,source:`Vue3 ${i}`,filename:(null===(s=null==n?void 0:n.$options)||void 0===s?void 0:s.__file)||"Vue3 Component"};t.report({type:e.ERROR,data:c}),t.addBreadcrumb({timestamp:Date.now(),type:e.ERROR,category:"vue3",message:`Vue3 Error: ${o.message}`,level:"error",data:{info:i,component:(null===(a=null==n?void 0:n.type)||void 0===a?void 0:a.name)||"Anonymous Component"}})}}}},W={name:"react",install(t){if("undefined"!=typeof window&&window.React){const o=window.React.createElement;window.React.createElement=function(n,i,...s){if("function"==typeof n&&n.prototype&&n.prototype.isReactComponent){const o=n.prototype.componentDidCatch;n.prototype.componentDidCatch=function(i,s){const a={type:r.JS_ERROR,message:i.message,stack:i.stack,source:"React Component",filename:s.componentStack};t.report({type:e.ERROR,data:a}),t.addBreadcrumb({timestamp:Date.now(),type:e.ERROR,category:"react",message:`React Error: ${i.message}`,level:"error",data:{componentStack:s.componentStack,component:n.name||"Anonymous Component"}}),o&&o.call(this,i,s)}}return o.apply(this,arguments)}}if("undefined"!=typeof window&&window.ReactDOM&&window.ReactDOM.createRoot){const o=window.ReactDOM.createRoot;window.ReactDOM.createRoot=function(n,i={}){const s={...i,onRecoverableError:(o,n)=>{const s={type:r.JS_ERROR,message:o.message,stack:o.stack,source:"React Recoverable Error"};t.report({type:e.ERROR,data:s}),t.addBreadcrumb({timestamp:Date.now(),type:e.ERROR,category:"react",message:`React Recoverable Error: ${o.message}`,level:"warning",data:n}),i.onRecoverableError&&i.onRecoverableError(o,n)}};return o.call(this,n,s)}}}};class J{constructor(e){this.isInitialized=!1,/bot|crawler|spider|crawling/i.test(navigator.userAgent)?this.monitor={}:(this.monitor=new c(e),this.init(),window.__webMonitorSDK=this)}init(){if(this.isInitialized)console.warn("WebMonitorSDK already initialized");else try{this.monitor.config.enablePerformance&&(this.performanceMonitor=new z(this.monitor)),this.monitor.config.enableError&&(this.errorMonitor=new X(this.monitor)),this.monitor.config.enableBehavior&&(this.behaviorMonitor=new G(this.monitor)),this.isInitialized=!0,this.monitor.isDebug&&console.log("WebMonitorSDK initialized successfully")}catch(e){console.error("Failed to initialize WebMonitorSDK:",e)}}reportError(e,t){this.errorMonitor&&this.errorMonitor.reportCustomError(e,t)}reportBehavior(e,t){this.behaviorMonitor&&this.behaviorMonitor.reportCustomBehavior(e,t)}report(e){this.monitor.report(e)}use(e){return this.monitor.use(e),this}unuse(e){return this.monitor.unuse(e),this}setUser(e,t){this.monitor.userId=e,this.monitor.addBreadcrumb({timestamp:Date.now(),type:"behavior",category:"user",message:`User set: ${e}`,level:"info",data:t})}setTag(e,t){this.monitor.tags||(this.monitor.tags={}),this.monitor.tags[e]=t}setContext(e,t){this.monitor.contexts||(this.monitor.contexts={}),this.monitor.contexts[e]=t}destroy(){var e,t,r;this.isInitialized&&(null===(e=this.performanceMonitor)||void 0===e||e.destroy(),null===(t=this.errorMonitor)||void 0===t||t.destroy(),null===(r=this.behaviorMonitor)||void 0===r||r.destroy(),this.monitor.destroy(),this.isInitialized=!1,delete window.__webMonitorSDK,this.monitor.isDebug&&console.log("WebMonitorSDK destroyed"))}getConfig(){return this.monitor.config}getSessionId(){return this.monitor.currentSessionId}getUserId(){return this.monitor.currentUserId}}function j(e){return new J(e)}export{o as BehaviorType,e as DataType,r as ErrorType,t as PerformanceType,W as ReactPlugin,n as ReportPriority,K as VuePlugin,J as WebMonitorSDK,j as createWebMonitorSDK,J as default};
