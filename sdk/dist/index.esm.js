class e{constructor(){this.STORAGE_KEY="web_monitor_queue",this.TIMER_KEY="web_monitor_timer",this.MAX_STORAGE_SIZE=1048576}save(e){if(!this.isLocalStorageAvailable())return!1;try{const t=JSON.stringify(e);return t.length>this.MAX_STORAGE_SIZE?(console.warn("WebMonitorSDK: Data too large for localStorage"),!1):(localStorage.setItem(this.STORAGE_KEY,t),!0)}catch(e){return console.warn("WebMonitorSDK: Failed to save to localStorage:",e),!1}}load(){if(!this.isLocalStorageAvailable())return[];try{const e=localStorage.getItem(this.STORAGE_KEY);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return console.warn("WebMonitorSDK: Failed to load from localStorage:",e),this.clear(),[]}}clear(){if(this.isLocalStorageAvailable())try{localStorage.removeItem(this.STORAGE_KEY)}catch(e){console.warn("WebMonitorSDK: Failed to clear localStorage:",e)}}isLocalStorageAvailable(){try{const e="__localStorage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}getStorageSize(){if(!this.isLocalStorageAvailable())return 0;try{const e=localStorage.getItem(this.STORAGE_KEY);return e?e.length:0}catch(e){return 0}}saveLastReportTime(e){if(!this.isLocalStorageAvailable())return!1;try{return localStorage.setItem(this.TIMER_KEY,e.toString()),!0}catch(e){return console.warn("WebMonitorSDK: Failed to save timer to localStorage:",e),!1}}getLastReportTime(){if(!this.isLocalStorageAvailable())return 0;try{const e=localStorage.getItem(this.TIMER_KEY);return e?parseInt(e,10):0}catch(e){return console.warn("WebMonitorSDK: Failed to load timer from localStorage:",e),0}}clearTimer(){if(this.isLocalStorageAvailable())try{localStorage.removeItem(this.TIMER_KEY)}catch(e){console.warn("WebMonitorSDK: Failed to clear timer from localStorage:",e)}}}class t{constructor(t){var r,o,n,i,a,s,c,u,l;this.dataQueue=[],this.reportTimer=null,this.isDestroyed=!1,this.pendingRequests=0,this.retryQueue=[],this.options={url:t.url,timeout:null!==(r=t.timeout)&&void 0!==r?r:5e3,withCredentials:null!==(o=t.withCredentials)&&void 0!==o&&o,headers:null!==(n=t.headers)&&void 0!==n?n:{},reportInterval:null!==(i=t.reportInterval)&&void 0!==i?i:6e4,batchSize:null!==(a=t.batchSize)&&void 0!==a?a:10,maxQueueSize:null!==(s=t.maxQueueSize)&&void 0!==s?s:100,enableImmediateReport:null===(c=t.enableImmediateReport)||void 0===c||c,retryCount:null!==(u=t.retryCount)&&void 0!==u?u:3,retryInterval:null!==(l=t.retryInterval)&&void 0!==l?l:1e3},this.storageManager=new e,this.loadDataFromStorage(),this.startReportTimer(),this.setupBeforeUnload(),this.startRetryTimer()}loadDataFromStorage(){const e=this.storageManager.load();this.dataQueue.push(...e),this.storageManager.clear()}saveDataToStorage(){this.dataQueue.length>0&&this.storageManager.save(this.dataQueue)}startReportTimer(){const e=Date.now(),t=this.storageManager.getLastReportTime();let r=this.options.reportInterval;if(t>0){const o=e-t;r=o<this.options.reportInterval?this.options.reportInterval-o:0}r<=0&&(this.processQueuedData(),r=this.options.reportInterval),this.reportTimer=window.setInterval(()=>{this.processQueuedData()},this.options.reportInterval),r!==this.options.reportInterval&&setTimeout(()=>{this.processQueuedData()},r)}startRetryTimer(){setInterval(()=>{this.processRetryQueue()},this.options.retryInterval)}setupBeforeUnload(){window.addEventListener("beforeunload",()=>{this.saveDataToStorage(),this.flushAllQueues()}),window.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&(this.saveDataToStorage(),this.flushAllQueues())})}flushAllQueues(){this.dataQueue.length>0&&(this.trySendBeacon(this.dataQueue),this.dataQueue=[])}send(e){this.isDestroyed||(this.dataQueue.push(e),this.checkQueueOverflow())}processQueuedData(){if(this.isDestroyed||this.pendingRequests>3)return;const e=this.dataQueue.length>0;if(this.dataQueue.length>0){const e=this.dataQueue.splice(0,this.options.batchSize);this.sendBatch(e),this.storageManager.saveLastReportTime(Date.now())}e&&this.storageManager.clear()}sendBatch(e){if(this.isDestroyed)return;this.pendingRequests++;const t=JSON.stringify(e),r=this.sendFetch(t).catch(()=>this.sendXHR(t));Promise.resolve(r).then(()=>{var t;this.pendingRequests--,(null===(t=this.options.headers)||void 0===t?void 0:t.debug)&&console.log(`数据上报成功: ${e.length} 条数据`)}).catch(()=>{this.pendingRequests--,this.addToRetryQueue(e)})}trySendBeacon(e){if(!navigator.sendBeacon)return null;try{const t=JSON.stringify(e),r=new Blob([t],{type:"application/json"});return navigator.sendBeacon(this.options.url,r)?Promise.resolve():Promise.reject(new Error("SendBeacon failed"))}catch(e){return Promise.reject(e)}}checkQueueOverflow(){this.dataQueue.length>=this.options.maxQueueSize&&this.processQueuedData()}addToRetryQueue(e){const t={data:e,retryCount:0,nextRetryTime:Date.now()+this.options.retryInterval};this.retryQueue.push(t)}processRetryQueue(){if(0===this.retryQueue.length||this.pendingRequests>3)return;const e=Date.now();this.retryQueue.filter(t=>e>=t.nextRetryTime).forEach(t=>{if(t.retryCount<this.options.retryCount)t.retryCount++,t.nextRetryTime=e+this.options.retryInterval*Math.pow(2,t.retryCount),this.sendBatch(t.data);else{const e=this.retryQueue.indexOf(t);e>-1&&this.retryQueue.splice(e,1)}})}async sendFetch(e){const t=new AbortController,r=setTimeout(()=>t.abort(),this.options.timeout);try{await fetch(this.options.url,{method:"POST",headers:{"Content-Type":"application/json",...this.options.headers},body:e,credentials:this.options.withCredentials?"include":"omit",signal:t.signal})}finally{clearTimeout(r)}}sendXHR(e){const t=new XMLHttpRequest;t.open("POST",this.options.url,!0),t.timeout=this.options.timeout,t.withCredentials=this.options.withCredentials,t.setRequestHeader("Content-Type","application/json"),Object.entries(this.options.headers).forEach(([e,r])=>{t.setRequestHeader(e,r)}),t.onerror=()=>{},t.ontimeout=()=>{};try{t.send(e)}catch(e){}}destroy(){this.isDestroyed=!0,this.reportTimer&&(clearInterval(this.reportTimer),this.reportTimer=null),this.flushAllQueues(),this.retryQueue=[],this.storageManager.clearTimer()}getQueueStatus(){return{queue:this.dataQueue.length,retry:this.retryQueue.length,pending:this.pendingRequests}}flush(){this.processQueuedData()}}function r(e){const t=[];let r=e;for(;r&&r.nodeType===Node.ELEMENT_NODE;){let e=r.nodeName.toLowerCase();if(r.id){e+=`#${r.id}`,t.unshift(e);break}{let t=1,o=r.previousElementSibling;for(;o;)o.nodeName.toLowerCase()===e&&t++,o=o.previousElementSibling;t>1&&(e+=`:nth-child(${t})`)}t.unshift(e),r=r.parentElement}return t.join(" > ")}function o(){const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;return e&&(e.effectiveType||e.type)||"unknown"}class n{constructor(e){this.breadcrumbs=[],this.plugins=new Map,this.isDestroyed=!1,this.config=this.mergeConfig(e),this.sessionId=function(){const e=localStorage.getItem("web_monitor_session_id");if(e)return e;const t=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{localStorage.setItem("web_monitor_session_id",t)}catch(e){}return t}(),this.userId=function(){const e=localStorage.getItem("web_monitor_user_id");if(e)return e;const t=`user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{localStorage.setItem("web_monitor_user_id",t)}catch(e){}return t}(),this.transport=new t({url:this.config.reportUrl,reportInterval:this.config.reportInterval,batchSize:this.config.batchSize,maxQueueSize:this.config.maxQueueSize,enableImmediateReport:this.config.enableImmediateReport}),this.init()}mergeConfig(e){var t,r,o,n,i,a,s,c,u,l,d;return{appId:e.appId,reportUrl:e.reportUrl,sampling:null!==(t=e.sampling)&&void 0!==t?t:1,debug:null!==(r=e.debug)&&void 0!==r&&r,enablePerformance:null===(o=e.enablePerformance)||void 0===o||o,enableError:null===(n=e.enableError)||void 0===n||n,enableBehavior:null===(i=e.enableBehavior)||void 0===i||i,maxBreadcrumbsNum:null!==(a=e.maxBreadcrumbsNum)&&void 0!==a?a:20,beforeSend:null!==(s=e.beforeSend)&&void 0!==s?s:e=>e,reportInterval:null!==(c=e.reportInterval)&&void 0!==c?c:6e4,batchSize:null!==(u=e.batchSize)&&void 0!==u?u:10,maxQueueSize:null!==(l=e.maxQueueSize)&&void 0!==l?l:100,enableImmediateReport:null===(d=e.enableImmediateReport)||void 0===d||d}}init(){this.shouldSample()&&this.setupErrorHandling()}shouldSample(){return Math.random()<this.config.sampling}setupErrorHandling(){const e=console.error;console.error=(...t)=>{try{e.apply(console,t)}catch(e){}},window.addEventListener("error",e=>{this.safeExecute(()=>{})}),window.addEventListener("unhandledrejection",e=>{this.safeExecute(()=>{})})}safeExecute(e){try{this.isDestroyed||e()}catch(e){this.config.debug&&console.warn("WebMonitorSDK internal error:",e)}}addBreadcrumb(e){this.breadcrumbs.length>=this.config.maxBreadcrumbsNum&&this.breadcrumbs.shift(),this.breadcrumbs.push(e)}report(e){this.safeExecute(()=>{const t={appId:this.config.appId,timestamp:Date.now(),sessionId:this.sessionId,userId:this.userId,url:window.location.href,userAgent:navigator.userAgent,connectionType:o(),breadcrumbs:[...this.breadcrumbs],...e},r=this.config.beforeSend(t);r&&(this.transport.send(r),this.config.debug&&console.log("WebMonitorSDK Report:",r))})}use(e){this.plugins.has(e.name)?console.warn(`Plugin ${e.name} already installed`):(this.plugins.set(e.name,e),e.install(this))}unuse(e){const t=this.plugins.get(e);t&&t.uninstall&&t.uninstall(this),this.plugins.delete(e)}destroy(){this.isDestroyed=!0,this.transport.destroy(),this.plugins.forEach(e=>{e.uninstall&&e.uninstall(this)}),this.plugins.clear(),this.breadcrumbs=[]}get isDebug(){return this.config.debug}get appId(){return this.config.appId}get currentSessionId(){return this.sessionId}get currentUserId(){return this.userId}}var i,a,s,c,u,l,d,h,m=-1,p=function(e){addEventListener("pageshow",function(t){t.persisted&&(m=t.timeStamp,e(t))},!0)},g=function(){return window.performance&&performance.getEntriesByType&&performance.getEntriesByType("navigation")[0]},f=function(){var e=g();return e&&e.activationStart||0},v=function(e,t){var r=g(),o="navigate";return m>=0?o="back-forward-cache":r&&(document.prerendering||f()>0?o="prerender":document.wasDiscarded?o="restore":r.type&&(o=r.type.replace(/_/g,"-"))),{name:e,value:void 0===t?-1:t,rating:"good",delta:0,entries:[],id:"v3-".concat(Date.now(),"-").concat(Math.floor(8999999999999*Math.random())+1e12),navigationType:o}},y=function(e,t,r){try{if(PerformanceObserver.supportedEntryTypes.includes(e)){var o=new PerformanceObserver(function(e){Promise.resolve().then(function(){t(e.getEntries())})});return o.observe(Object.assign({type:e,buffered:!0},r||{})),o}}catch(e){}},R=function(e,t,r,o){var n,i;return function(a){t.value>=0&&(a||o)&&((i=t.value-(n||0))||void 0===n)&&(n=t.value,t.delta=i,t.rating=function(e,t){return e>t[1]?"poor":e>t[0]?"needs-improvement":"good"}(t.value,r),e(t))}},w=function(e){requestAnimationFrame(function(){return requestAnimationFrame(function(){return e()})})},E=function(e){var t=function(t){"pagehide"!==t.type&&"hidden"!==document.visibilityState||e(t)};addEventListener("visibilitychange",t,!0),addEventListener("pagehide",t,!0)},S=function(e){var t=!1;return function(r){t||(e(r),t=!0)}},b=-1,I=function(){return"hidden"!==document.visibilityState||document.prerendering?1/0:0},T=function(e){"hidden"===document.visibilityState&&b>-1&&(b="visibilitychange"===e.type?e.timeStamp:0,D())},C=function(){addEventListener("visibilitychange",T,!0),addEventListener("prerenderingchange",T,!0)},D=function(){removeEventListener("visibilitychange",T,!0),removeEventListener("prerenderingchange",T,!0)},O=function(){return b<0&&(b=I(),C(),p(function(){setTimeout(function(){b=I(),C()},0)})),{get firstHiddenTime(){return b}}},_=function(e){document.prerendering?addEventListener("prerenderingchange",function(){return e()},!0):e()},M=[1800,3e3],L=function(e,t){t=t||{},_(function(){var r,o=O(),n=v("FCP"),i=y("paint",function(e){e.forEach(function(e){"first-contentful-paint"===e.name&&(i.disconnect(),e.startTime<o.firstHiddenTime&&(n.value=Math.max(e.startTime-f(),0),n.entries.push(e),r(!0)))})});i&&(r=R(e,n,M,t.reportAllChanges),p(function(o){n=v("FCP"),r=R(e,n,M,t.reportAllChanges),w(function(){n.value=performance.now()-o.timeStamp,r(!0)})}))})},A=[.1,.25],P={passive:!0,capture:!0},B=new Date,k=function(e,t){i||(i=t,a=e,s=new Date,H(removeEventListener),N())},N=function(){if(a>=0&&a<s-B){var e={entryType:"first-input",name:i.type,target:i.target,cancelable:i.cancelable,startTime:i.timeStamp,processingStart:i.timeStamp+a};c.forEach(function(t){t(e)}),c=[]}},$=function(e){if(e.cancelable){var t=(e.timeStamp>1e12?new Date:performance.now())-e.timeStamp;"pointerdown"==e.type?function(e,t){var r=function(){k(e,t),n()},o=function(){n()},n=function(){removeEventListener("pointerup",r,P),removeEventListener("pointercancel",o,P)};addEventListener("pointerup",r,P),addEventListener("pointercancel",o,P)}(t,e):k(t,e)}},H=function(e){["mousedown","keydown","touchstart","pointerdown"].forEach(function(t){return e(t,$,P)})},Q=[100,300],F=[2500,4e3],x={},U=[800,1800],V=function e(t){document.prerendering?_(function(){return e(t)}):"complete"!==document.readyState?addEventListener("load",function(){return e(t)},!0):setTimeout(t,0)},q=function(e,t){t=t||{};var r=v("TTFB"),o=R(e,r,U,t.reportAllChanges);V(function(){var n=g();if(n){var i=n.responseStart;if(i<=0||i>performance.now())return;r.value=Math.max(i-f(),0),r.entries=[n],o(!0),p(function(){r=v("TTFB",0),(o=R(e,r,U,t.reportAllChanges))(!0)})}})};!function(e){e.PERFORMANCE="performance",e.ERROR="error",e.BEHAVIOR="behavior"}(u||(u={})),function(e){e.LCP="LCP",e.INP="INP",e.CLS="CLS",e.FCP="FCP",e.FID="FID",e.TTFB="TTFB",e.NAVIGATION="navigation",e.RESOURCE="resource",e.API="api"}(l||(l={})),function(e){e.JS_ERROR="js_error",e.PROMISE_ERROR="promise_error",e.RESOURCE_ERROR="resource_error",e.API_ERROR="api_error",e.CUSTOM_ERROR="custom_error"}(d||(d={})),function(e){e.CLICK="click",e.INPUT="input",e.SCROLL="scroll",e.ROUTE_CHANGE="route_change",e.PAGE_VIEW="page_view"}(h||(h={}));class K{constructor(e){this.observer=null,this.monitor=e,this.init()}init(){this.collectWebVitals(),this.collectNavigationTiming(),this.collectResourceTiming(),this.collectAPITiming()}collectWebVitals(){!function(e,t){t=t||{},_(function(){var r,o=O(),n=v("LCP"),i=function(e){var t=e[e.length-1];t&&t.startTime<o.firstHiddenTime&&(n.value=Math.max(t.startTime-f(),0),n.entries=[t],r())},a=y("largest-contentful-paint",i);if(a){r=R(e,n,F,t.reportAllChanges);var s=S(function(){x[n.id]||(i(a.takeRecords()),a.disconnect(),x[n.id]=!0,r(!0))});["keydown","click"].forEach(function(e){addEventListener(e,function(){return setTimeout(s,0)},!0)}),E(s),p(function(o){n=v("LCP"),r=R(e,n,F,t.reportAllChanges),w(function(){n.value=performance.now()-o.timeStamp,x[n.id]=!0,r(!0)})})}})}(e=>{this.reportMetric({type:l.LCP,name:"LCP",value:e.value,rating:e.rating,delta:e.delta,entries:e.entries})}),function(e,t){t=t||{},_(function(){var r,o=O(),n=v("FID"),s=function(e){e.startTime<o.firstHiddenTime&&(n.value=e.processingStart-e.startTime,n.entries.push(e),r(!0))},u=function(e){e.forEach(s)},l=y("first-input",u);r=R(e,n,Q,t.reportAllChanges),l&&E(S(function(){u(l.takeRecords()),l.disconnect()})),l&&p(function(){var o;n=v("FID"),r=R(e,n,Q,t.reportAllChanges),c=[],a=-1,i=null,H(addEventListener),o=s,c.push(o),N()})})}(e=>{this.reportMetric({type:l.FID,name:"FID",value:e.value,rating:e.rating,delta:e.delta,entries:e.entries})}),function(e,t){t=t||{},L(S(function(){var r,o=v("CLS",0),n=0,i=[],a=function(e){e.forEach(function(e){if(!e.hadRecentInput){var t=i[0],r=i[i.length-1];n&&e.startTime-r.startTime<1e3&&e.startTime-t.startTime<5e3?(n+=e.value,i.push(e)):(n=e.value,i=[e])}}),n>o.value&&(o.value=n,o.entries=i,r())},s=y("layout-shift",a);s&&(r=R(e,o,A,t.reportAllChanges),E(function(){a(s.takeRecords()),r(!0)}),p(function(){n=0,o=v("CLS",0),r=R(e,o,A,t.reportAllChanges),w(function(){return r()})}),setTimeout(r,0))}))}(e=>{this.reportMetric({type:l.CLS,name:"CLS",value:e.value,rating:e.rating,delta:e.delta,entries:e.entries})}),L(e=>{this.reportMetric({type:l.FCP,name:"FCP",value:e.value,rating:e.rating,delta:e.delta,entries:e.entries})}),q(e=>{this.reportMetric({type:l.TTFB,name:"TTFB",value:e.value,rating:e.rating,delta:e.delta,entries:e.entries})})}collectNavigationTiming(){window.addEventListener("load",()=>{setTimeout(()=>{const e=performance.getEntriesByType("navigation")[0];if(!e)return;const t={dnsLookup:e.domainLookupEnd-e.domainLookupStart,tcpConnect:e.connectEnd-e.connectStart,sslConnect:e.secureConnectionStart>0?e.connectEnd-e.secureConnectionStart:0,request:e.responseStart-e.requestStart,response:e.responseEnd-e.responseStart,domParse:e.domInteractive-e.responseEnd,domContentLoaded:e.domContentLoadedEventEnd-e.fetchStart,loadComplete:e.loadEventEnd-e.fetchStart,firstPaint:this.getFirstPaint(),firstContentfulPaint:this.getFirstContentfulPaint()};this.reportMetric({type:l.NAVIGATION,name:"Navigation Timing",value:t.loadComplete,entries:[e],navigationType:this.getNavigationType("number"==typeof e.type?e.type:0)}),this.monitor.addBreadcrumb({timestamp:Date.now(),type:u.PERFORMANCE,category:"navigation",message:"Page loaded",level:"info",data:t})},0)})}collectResourceTiming(){if(PerformanceObserver)try{this.observer=new PerformanceObserver(e=>{e.getEntries().forEach(e=>{if("resource"===e.entryType){const t=e;if(t.name.includes(this.monitor.appId))return;this.reportMetric({type:l.RESOURCE,name:t.name,value:t.duration,entries:[e]}),t.duration>3e3&&this.monitor.addBreadcrumb({timestamp:Date.now(),type:u.PERFORMANCE,category:"resource",message:`Slow resource: ${t.name}`,level:"warning",data:{duration:t.duration,size:t.transferSize||0}})}})}),this.observer.observe({entryTypes:["resource"]})}catch(e){}}collectAPITiming(){const e=window.fetch;window.fetch=async(...t)=>{const r=performance.now(),o="string"==typeof t[0]?t[0]:t[0].url;try{const n=await e.apply(window,t),i=performance.now()-r;return this.reportMetric({type:l.API,name:o,value:i,entries:[]}),i>2e3&&this.monitor.addBreadcrumb({timestamp:Date.now(),type:u.PERFORMANCE,category:"api",message:`Slow API: ${o}`,level:"warning",data:{duration:i,status:n.status}}),n}catch(e){const t=performance.now()-r;throw this.reportMetric({type:l.API,name:o,value:t,entries:[]}),e}};const t=XMLHttpRequest.prototype.open,r=XMLHttpRequest.prototype.send,o=this;XMLHttpRequest.prototype.open=function(e,r,o,n,i){return this._monitor_url=r.toString(),this._monitor_startTime=performance.now(),t.call(this,e,r,null==o||o,n,i)},XMLHttpRequest.prototype.send=function(e){const t=this,n=t._monitor_startTime,i=t._monitor_url;return t.addEventListener("readystatechange",()=>{if(4===t.readyState){const e=performance.now()-n;o&&i&&(o.reportMetric({type:l.API,name:i,value:e,entries:[]}),e>2e3&&o.monitor.addBreadcrumb({timestamp:Date.now(),type:u.PERFORMANCE,category:"api",message:`Slow XHR: ${i}`,level:"warning",data:{duration:e,status:t.status}}))}}),r.call(this,e)}}getFirstPaint(){const e=performance.getEntriesByType("paint").find(e=>"first-paint"===e.name);return e?e.startTime:0}getFirstContentfulPaint(){const e=performance.getEntriesByType("paint").find(e=>"first-contentful-paint"===e.name);return e?e.startTime:0}getNavigationType(e){return["navigate","reload","back_forward","prerender"][e]||"unknown"}reportMetric(e){this.monitor.report({type:u.PERFORMANCE,data:e})}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null)}}class z{constructor(e){this.monitor=e,this.originalFetch=window.fetch,this.originalXHROpen=XMLHttpRequest.prototype.open,this.originalXHRSend=XMLHttpRequest.prototype.send,this.init()}init(){this.handleJSError(),this.handlePromiseError(),this.handleResourceError(),this.handleAPIError()}handleJSError(){window.addEventListener("error",e=>{const{message:t,filename:r,lineno:o,colno:n,error:i}=e,a={type:d.JS_ERROR,message:t||"Unknown error",filename:r,lineno:o,colno:n,stack:null==i?void 0:i.stack};this.reportError(a),this.monitor.addBreadcrumb({timestamp:Date.now(),type:u.ERROR,category:"javascript",message:`JS Error: ${t}`,level:"error",data:{filename:r,lineno:o,colno:n}})},!0)}handlePromiseError(){window.addEventListener("unhandledrejection",e=>{let t="Unhandled Promise Rejection",r="";if(e.reason)if(e.reason instanceof Error)t=e.reason.message,r=e.reason.stack||"";else if("string"==typeof e.reason)t=e.reason;else try{t=JSON.stringify(e.reason)}catch(r){t=String(e.reason)}const o={type:d.PROMISE_ERROR,message:t,stack:r};this.reportError(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:u.ERROR,category:"promise",message:`Promise Error: ${t}`,level:"error",data:{reason:e.reason}})})}handleResourceError(){window.addEventListener("error",e=>{const t=e.target;if(t&&t!==window&&("IMG"===t.tagName||"SCRIPT"===t.tagName||"LINK"===t.tagName||"AUDIO"===t.tagName||"VIDEO"===t.tagName)){const e={type:d.RESOURCE_ERROR,message:`Resource load error: ${t.tagName}`,resourceUrl:t.src||t.href||"",elementSelector:r(t)};this.reportError(e),this.monitor.addBreadcrumb({timestamp:Date.now(),type:u.ERROR,category:"resource",message:`Resource Error: ${t.tagName}`,level:"error",data:{url:e.resourceUrl,element:t.tagName}})}},!0)}handleAPIError(){window.fetch=async(...e)=>{const t="string"==typeof e[0]?e[0]:e[0].url,r=Date.now();try{const o=await this.originalFetch.apply(window,e);if(!o.ok){const e={type:d.API_ERROR,message:`API Error: ${o.status} ${o.statusText}`,resourceUrl:t,statusCode:o.status};this.reportError(e),this.monitor.addBreadcrumb({timestamp:Date.now(),type:u.ERROR,category:"api",message:`API Error: ${t}`,level:"error",data:{status:o.status,statusText:o.statusText,duration:Date.now()-r}})}return o}catch(e){const o={type:d.API_ERROR,message:`Network Error: ${e instanceof Error?e.message:"Unknown error"}`,resourceUrl:t,stack:e instanceof Error?e.stack:void 0};throw this.reportError(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:u.ERROR,category:"api",message:`Network Error: ${t}`,level:"error",data:{error:e instanceof Error?e.message:String(e),duration:Date.now()-r}}),e}};const e=this;XMLHttpRequest.prototype.open=function(t,r,o,n,i){return this._monitor_url=r.toString(),this._monitor_method=t,this._monitor_startTime=Date.now(),e.originalXHROpen.call(this,t,r,null==o||o,n,i)},XMLHttpRequest.prototype.send=function(t){const r=this,o=r._monitor_url,n=r._monitor_method,i=r._monitor_startTime;return r.addEventListener("error",()=>{const t={type:d.API_ERROR,message:`XMLHttpRequest Error: ${n} ${o}`,resourceUrl:o,statusCode:r.status};e.reportError(t),e.monitor.addBreadcrumb({timestamp:Date.now(),type:u.ERROR,category:"api",message:`XHR Error: ${n} ${o}`,level:"error",data:{method:n,status:r.status,duration:Date.now()-i}})}),r.addEventListener("load",()=>{if(r.status>=400){const t={type:d.API_ERROR,message:`API Error: ${r.status} ${r.statusText}`,resourceUrl:o,statusCode:r.status};e.reportError(t),e.monitor.addBreadcrumb({timestamp:Date.now(),type:u.ERROR,category:"api",message:`XHR ${r.status}: ${n} ${o}`,level:"error",data:{method:n,status:r.status,statusText:r.statusText,duration:Date.now()-i}})}}),e.originalXHRSend.call(this,t)}}reportError(e){this.monitor.report({type:u.ERROR,data:e})}reportCustomError(e,t){const r={type:d.CUSTOM_ERROR,message:e,stack:(new Error).stack,...t};this.reportError(r),this.monitor.addBreadcrumb({timestamp:Date.now(),type:u.ERROR,category:"custom",message:`Custom Error: ${e}`,level:"error",data:t})}destroy(){window.fetch=this.originalFetch,XMLHttpRequest.prototype.open=this.originalXHROpen,XMLHttpRequest.prototype.send=this.originalXHRSend}}class X{constructor(e){this.monitor=e,this.currentUrl=window.location.href,this.startTime=Date.now(),this.init()}init(){this.trackPageView(),this.trackClicks(),this.trackInputs(),this.trackScrolls(),this.trackRouteChanges()}trackPageView(){const e={type:h.PAGE_VIEW,url:this.currentUrl};this.reportBehavior(e),this.monitor.addBreadcrumb({timestamp:Date.now(),type:u.BEHAVIOR,category:"navigation",message:`Page view: ${this.currentUrl}`,level:"info",data:{url:this.currentUrl,referrer:document.referrer}})}trackClicks(){document.addEventListener("click",e=>{const t=e.target;if(!t)return;const o={type:h.CLICK,element:t.tagName,selector:r(t),text:(n=t,"INPUT"===n.tagName?n.value||n.placeholder||"":(null===(i=n.textContent)||void 0===i?void 0:i.trim().slice(0,100))||"")};var n,i;this.reportBehavior(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:u.BEHAVIOR,category:"interaction",message:`Click: ${t.tagName}`,level:"info",data:{text:o.text,selector:o.selector}})},!0)}trackInputs(){const e=function(e,t){let r=null;return function(...o){const n=this;r&&clearTimeout(r),r=window.setTimeout(()=>{e.apply(n,o),r=null},t)}}(e=>{const t=e.target;if(!t||"password"===t.type)return;const o={type:h.INPUT,element:t.tagName,selector:r(t),text:"password"===t.type?"***":t.value.slice(0,100)};this.reportBehavior(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:u.BEHAVIOR,category:"interaction",message:`Input: ${t.tagName}`,level:"info",data:{type:t.type,selector:o.selector}})},500);document.addEventListener("input",e,!0),document.addEventListener("change",e,!0)}trackScrolls(){let e=0;const t=function(e,t){let r=null,o=0;return function(...n){const i=Date.now(),a=this;i-o>t?(e.apply(a,n),o=i):(r&&clearTimeout(r),r=window.setTimeout(()=>{e.apply(a,n),o=Date.now(),r=null},t-(i-o)))}}(()=>{const t=window.pageYOffset||document.documentElement.scrollTop,r=window.innerHeight,o=document.documentElement.scrollHeight,n=Math.round((t+r)/o*100);if(n>e&&(e=n,n>=25&&n%25==0)){const e={type:h.SCROLL,text:`${n}%`};this.reportBehavior(e),this.monitor.addBreadcrumb({timestamp:Date.now(),type:u.BEHAVIOR,category:"interaction",message:`Scroll: ${n}%`,level:"info",data:{depth:n,scrollTop:t,documentHeight:o}})}},1e3);window.addEventListener("scroll",t,{passive:!0})}trackRouteChanges(){const e=history.pushState,t=history.replaceState,r=(e,t)=>{const r=Date.now()-this.startTime,o={type:h.ROUTE_CHANGE,from:e,to:t,duration:r};this.reportBehavior(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:u.BEHAVIOR,category:"navigation",message:`Route change: ${e} -> ${t}`,level:"info",data:{from:e,to:t,duration:r}}),this.currentUrl=t,this.startTime=Date.now()};history.pushState=function(t,o,n){const i=window.location.href,a=e.apply(this,arguments),s=window.location.href;return i!==s&&r(i,s),a},history.replaceState=function(e,o,n){const i=window.location.href,a=t.apply(this,arguments),s=window.location.href;return i!==s&&r(i,s),a},window.addEventListener("popstate",()=>{const e=window.location.href;r(this.currentUrl,e)}),window.addEventListener("hashchange",()=>{const e=window.location.href;r(this.currentUrl,e)})}reportCustomBehavior(e,t){const r={type:e,...t};this.reportBehavior(r),this.monitor.addBreadcrumb({timestamp:Date.now(),type:u.BEHAVIOR,category:"custom",message:`Custom behavior: ${e}`,level:"info",data:t})}reportBehavior(e){this.monitor.report({type:u.BEHAVIOR,data:e})}destroy(){}}const W={name:"vue",install(e){if("undefined"!=typeof window&&window.Vue){window.Vue.config.errorHandler=(t,r,o)=>{var n,i;const a={type:d.JS_ERROR,message:t.message,stack:t.stack,source:`Vue ${o}`,filename:(null===(n=null==r?void 0:r.$options)||void 0===n?void 0:n.__file)||"Vue Component"};e.report({type:u.ERROR,data:a}),e.addBreadcrumb({timestamp:Date.now(),type:u.ERROR,category:"vue",message:`Vue Error: ${t.message}`,level:"error",data:{info:o,component:(null===(i=null==r?void 0:r.$options)||void 0===i?void 0:i.name)||"Anonymous Component"}})}}if("undefined"!=typeof window&&window.Vue&&window.Vue.version&&window.Vue.version.startsWith("3")){window.Vue.createApp({}).config.errorHandler=(t,r,o)=>{var n,i;const a={type:d.JS_ERROR,message:t.message,stack:t.stack,source:`Vue3 ${o}`,filename:(null===(n=null==r?void 0:r.$options)||void 0===n?void 0:n.__file)||"Vue3 Component"};e.report({type:u.ERROR,data:a}),e.addBreadcrumb({timestamp:Date.now(),type:u.ERROR,category:"vue3",message:`Vue3 Error: ${t.message}`,level:"error",data:{info:o,component:(null===(i=null==r?void 0:r.type)||void 0===i?void 0:i.name)||"Anonymous Component"}})}}}},G={name:"react",install(e){if("undefined"!=typeof window&&window.React){const t=window.React.createElement;window.React.createElement=function(r,o,...n){if("function"==typeof r&&r.prototype&&r.prototype.isReactComponent){const t=r.prototype.componentDidCatch;r.prototype.componentDidCatch=function(o,n){const i={type:d.JS_ERROR,message:o.message,stack:o.stack,source:"React Component",filename:n.componentStack};e.report({type:u.ERROR,data:i}),e.addBreadcrumb({timestamp:Date.now(),type:u.ERROR,category:"react",message:`React Error: ${o.message}`,level:"error",data:{componentStack:n.componentStack,component:r.name||"Anonymous Component"}}),t&&t.call(this,o,n)}}return t.apply(this,arguments)}}if("undefined"!=typeof window&&window.ReactDOM&&window.ReactDOM.createRoot){const t=window.ReactDOM.createRoot;window.ReactDOM.createRoot=function(r,o={}){const n={...o,onRecoverableError:(t,r)=>{const n={type:d.JS_ERROR,message:t.message,stack:t.stack,source:"React Recoverable Error"};e.report({type:u.ERROR,data:n}),e.addBreadcrumb({timestamp:Date.now(),type:u.ERROR,category:"react",message:`React Recoverable Error: ${t.message}`,level:"warning",data:r}),o.onRecoverableError&&o.onRecoverableError(t,r)}};return t.call(this,r,n)}}}};class J{constructor(e){this.isInitialized=!1,/bot|crawler|spider|crawling/i.test(navigator.userAgent)?this.monitor={}:(this.monitor=new n(e),this.init(),window.__webMonitorSDK=this)}init(){if(this.isInitialized)console.warn("WebMonitorSDK already initialized");else try{this.monitor.config.enablePerformance&&(this.performanceMonitor=new K(this.monitor)),this.monitor.config.enableError&&(this.errorMonitor=new z(this.monitor)),this.monitor.config.enableBehavior&&(this.behaviorMonitor=new X(this.monitor)),this.isInitialized=!0,this.monitor.isDebug&&console.log("WebMonitorSDK initialized successfully")}catch(e){console.error("Failed to initialize WebMonitorSDK:",e)}}reportError(e,t){this.errorMonitor&&this.errorMonitor.reportCustomError(e,t)}reportBehavior(e,t){this.behaviorMonitor&&this.behaviorMonitor.reportCustomBehavior(e,t)}report(e){this.monitor.report(e)}use(e){return this.monitor.use(e),this}unuse(e){return this.monitor.unuse(e),this}setUser(e,t){this.monitor.userId=e,this.monitor.addBreadcrumb({timestamp:Date.now(),type:"behavior",category:"user",message:`User set: ${e}`,level:"info",data:t})}setTag(e,t){this.monitor.tags||(this.monitor.tags={}),this.monitor.tags[e]=t}setContext(e,t){this.monitor.contexts||(this.monitor.contexts={}),this.monitor.contexts[e]=t}destroy(){var e,t,r;this.isInitialized&&(null===(e=this.performanceMonitor)||void 0===e||e.destroy(),null===(t=this.errorMonitor)||void 0===t||t.destroy(),null===(r=this.behaviorMonitor)||void 0===r||r.destroy(),this.monitor.destroy(),this.isInitialized=!1,delete window.__webMonitorSDK,this.monitor.isDebug&&console.log("WebMonitorSDK destroyed"))}getConfig(){return this.monitor.config}getSessionId(){return this.monitor.currentSessionId}getUserId(){return this.monitor.currentUserId}}function j(e){return new J(e)}export{h as BehaviorType,u as DataType,d as ErrorType,l as PerformanceType,G as ReactPlugin,W as VuePlugin,J as WebMonitorSDK,j as createWebMonitorSDK,J as default};
