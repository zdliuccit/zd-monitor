"use strict";var e,t,r,o,i;Object.defineProperty(exports,"__esModule",{value:!0}),exports.DataType=void 0,(e=exports.DataType||(exports.DataType={})).PERFORMANCE="performance",e.ERROR="error",e.BEHAVIOR="behavior",exports.PerformanceType=void 0,(t=exports.PerformanceType||(exports.PerformanceType={})).LCP="LCP",t.INP="INP",t.CLS="CLS",t.FCP="FCP",t.FID="FID",t.TTFB="TTFB",t.NAVIGATION="navigation",t.RESOURCE="resource",t.API="api",exports.ErrorType=void 0,(r=exports.ErrorType||(exports.ErrorType={})).JS_ERROR="js_error",r.PROMISE_ERROR="promise_error",r.RESOURCE_ERROR="resource_error",r.API_ERROR="api_error",r.CUSTOM_ERROR="custom_error",exports.BehaviorType=void 0,(o=exports.BehaviorType||(exports.BehaviorType={})).CLICK="click",o.INPUT="input",o.SCROLL="scroll",o.ROUTE_CHANGE="route_change",o.PAGE_VIEW="page_view",exports.ReportPriority=void 0,(i=exports.ReportPriority||(exports.ReportPriority={})).LOW="low",i.MEDIUM="medium",i.HIGH="high";class n{constructor(){this.STORAGE_KEY="web_monitor_queue",this.MAX_STORAGE_SIZE=1048576}save(e){if(!this.isLocalStorageAvailable())return!1;try{const t=JSON.stringify(e);return t.length>this.MAX_STORAGE_SIZE?(console.warn("WebMonitorSDK: Data too large for localStorage"),!1):(localStorage.setItem(this.STORAGE_KEY,t),!0)}catch(e){return console.warn("WebMonitorSDK: Failed to save to localStorage:",e),!1}}load(){if(!this.isLocalStorageAvailable())return[];try{const e=localStorage.getItem(this.STORAGE_KEY);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return console.warn("WebMonitorSDK: Failed to load from localStorage:",e),this.clear(),[]}}clear(){if(this.isLocalStorageAvailable())try{localStorage.removeItem(this.STORAGE_KEY)}catch(e){console.warn("WebMonitorSDK: Failed to clear localStorage:",e)}}isLocalStorageAvailable(){try{const e="__localStorage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}getStorageSize(){if(!this.isLocalStorageAvailable())return 0;try{const e=localStorage.getItem(this.STORAGE_KEY);return e?e.length:0}catch(e){return 0}}}class s{constructor(e){var t,r,o,i,s,a,c,u,l;this.highPriorityQueue=[],this.mediumPriorityQueue=[],this.lowPriorityQueue=[],this.reportTimer=null,this.isDestroyed=!1,this.pendingRequests=0,this.retryQueue=[],this.options={url:e.url,timeout:null!==(t=e.timeout)&&void 0!==t?t:5e3,withCredentials:null!==(r=e.withCredentials)&&void 0!==r&&r,headers:null!==(o=e.headers)&&void 0!==o?o:{},reportInterval:null!==(i=e.reportInterval)&&void 0!==i?i:6e4,batchSize:null!==(s=e.batchSize)&&void 0!==s?s:10,maxQueueSize:null!==(a=e.maxQueueSize)&&void 0!==a?a:100,enableImmediateReport:null===(c=e.enableImmediateReport)||void 0===c||c,retryCount:null!==(u=e.retryCount)&&void 0!==u?u:3,retryInterval:null!==(l=e.retryInterval)&&void 0!==l?l:1e3},this.storageManager=new n,this.loadDataFromStorage(),this.startReportTimer(),this.setupBeforeUnload(),this.startRetryTimer()}loadDataFromStorage(){this.storageManager.load().forEach(e=>{const t=e.priority||this.getDefaultPriority(e.type);this.addToQueue(e,t)}),this.storageManager.clear()}saveDataToStorage(){const e=[...this.highPriorityQueue,...this.mediumPriorityQueue,...this.lowPriorityQueue];e.length>0&&this.storageManager.save(e)}startReportTimer(){this.reportTimer=window.setInterval(()=>{this.processQueuedData()},this.options.reportInterval)}startRetryTimer(){setInterval(()=>{this.processRetryQueue()},this.options.retryInterval)}setupBeforeUnload(){window.addEventListener("beforeunload",()=>{this.saveDataToStorage(),this.flushAllQueues()}),window.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&(this.saveDataToStorage(),this.flushAllQueues())})}flushAllQueues(){const e=[...this.highPriorityQueue,...this.mediumPriorityQueue,...this.lowPriorityQueue];e.length>0&&(this.trySendBeacon(e),this.highPriorityQueue=[],this.mediumPriorityQueue=[],this.lowPriorityQueue=[])}send(e){if(this.isDestroyed)return;const t=e.priority||this.getDefaultPriority(e.type);t===exports.ReportPriority.HIGH&&this.options.enableImmediateReport?this.sendImmediately([e]):(this.addToQueue(e,t),this.checkQueueOverflow())}processQueuedData(){if(this.isDestroyed||this.pendingRequests>3)return;const e=this.highPriorityQueue.length>0||this.mediumPriorityQueue.length>0||this.lowPriorityQueue.length>0;if(this.mediumPriorityQueue.length>0){const e=this.mediumPriorityQueue.splice(0,this.options.batchSize);this.sendBatch(e,exports.ReportPriority.MEDIUM)}if(this.lowPriorityQueue.length>0){const e=this.lowPriorityQueue.splice(0,this.options.batchSize);this.sendBatch(e,exports.ReportPriority.LOW)}e&&this.storageManager.clear()}sendBatch(e,t){if(this.isDestroyed)return;this.pendingRequests++;const r=JSON.stringify(e),o=t===exports.ReportPriority.HIGH?this.trySendBeacon(e)||this.sendFetch(r):this.sendFetch(r).catch(()=>this.sendXHR(r));Promise.resolve(o).then(()=>{var r;this.pendingRequests--,(null===(r=this.options.headers)||void 0===r?void 0:r.debug)&&console.log(`数据上报成功: ${e.length} 条数据, 优先级: ${t}`)}).catch(()=>{this.pendingRequests--,this.addToRetryQueue(e)})}sendImmediately(e){this.sendBatch(e,exports.ReportPriority.HIGH)}trySendBeacon(e){if(!navigator.sendBeacon)return null;try{const t=JSON.stringify(e),r=new Blob([t],{type:"application/json"});return navigator.sendBeacon(this.options.url,r)?Promise.resolve():Promise.reject(new Error("SendBeacon failed"))}catch(e){return Promise.reject(e)}}getDefaultPriority(e){switch(e){case"error":return exports.ReportPriority.HIGH;case"performance":default:return exports.ReportPriority.MEDIUM;case"behavior":return exports.ReportPriority.LOW}}addToQueue(e,t){switch(t){case exports.ReportPriority.HIGH:this.highPriorityQueue.push(e);break;case exports.ReportPriority.MEDIUM:this.mediumPriorityQueue.push(e);break;case exports.ReportPriority.LOW:this.lowPriorityQueue.push(e)}}checkQueueOverflow(){this.highPriorityQueue.length+this.mediumPriorityQueue.length+this.lowPriorityQueue.length>=this.options.maxQueueSize&&this.processQueuedData()}addToRetryQueue(e){const t={data:e,retryCount:0,nextRetryTime:Date.now()+this.options.retryInterval};this.retryQueue.push(t)}processRetryQueue(){if(0===this.retryQueue.length||this.pendingRequests>3)return;const e=Date.now();this.retryQueue.filter(t=>e>=t.nextRetryTime).forEach(t=>{if(t.retryCount<this.options.retryCount)t.retryCount++,t.nextRetryTime=e+this.options.retryInterval*Math.pow(2,t.retryCount),this.sendBatch(t.data,exports.ReportPriority.MEDIUM);else{const e=this.retryQueue.indexOf(t);e>-1&&this.retryQueue.splice(e,1)}})}async sendFetch(e){const t=new AbortController,r=setTimeout(()=>t.abort(),this.options.timeout);try{await fetch(this.options.url,{method:"POST",headers:{"Content-Type":"application/json",...this.options.headers},body:e,credentials:this.options.withCredentials?"include":"omit",signal:t.signal})}finally{clearTimeout(r)}}sendXHR(e){const t=new XMLHttpRequest;t.open("POST",this.options.url,!0),t.timeout=this.options.timeout,t.withCredentials=this.options.withCredentials,t.setRequestHeader("Content-Type","application/json"),Object.entries(this.options.headers).forEach(([e,r])=>{t.setRequestHeader(e,r)}),t.onerror=()=>{},t.ontimeout=()=>{};try{t.send(e)}catch(e){}}destroy(){this.isDestroyed=!0,this.reportTimer&&(clearInterval(this.reportTimer),this.reportTimer=null),this.flushAllQueues(),this.retryQueue=[]}getQueueStatus(){return{high:this.highPriorityQueue.length,medium:this.mediumPriorityQueue.length,low:this.lowPriorityQueue.length,retry:this.retryQueue.length,pending:this.pendingRequests}}flush(){this.processQueuedData()}}function a(e){const t=[];let r=e;for(;r&&r.nodeType===Node.ELEMENT_NODE;){let e=r.nodeName.toLowerCase();if(r.id){e+=`#${r.id}`,t.unshift(e);break}{let t=1,o=r.previousElementSibling;for(;o;)o.nodeName.toLowerCase()===e&&t++,o=o.previousElementSibling;t>1&&(e+=`:nth-child(${t})`)}t.unshift(e),r=r.parentElement}return t.join(" > ")}class c{constructor(e){this.breadcrumbs=[],this.plugins=new Map,this.isDestroyed=!1,this.config=this.mergeConfig(e),this.sessionId=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,this.userId=function(){const e=localStorage.getItem("web_monitor_user_id");if(e)return e;const t=`user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{localStorage.setItem("web_monitor_user_id",t)}catch(e){}return t}(),this.transport=new s({url:this.config.reportUrl,reportInterval:this.config.reportInterval,batchSize:this.config.batchSize,maxQueueSize:this.config.maxQueueSize,enableImmediateReport:this.config.enableImmediateReport}),this.init()}mergeConfig(e){var t,r,o,i,n,s,a,c,u,l,p;return{appId:e.appId,reportUrl:e.reportUrl,sampling:null!==(t=e.sampling)&&void 0!==t?t:1,debug:null!==(r=e.debug)&&void 0!==r&&r,enablePerformance:null===(o=e.enablePerformance)||void 0===o||o,enableError:null===(i=e.enableError)||void 0===i||i,enableBehavior:null===(n=e.enableBehavior)||void 0===n||n,maxBreadcrumbsNum:null!==(s=e.maxBreadcrumbsNum)&&void 0!==s?s:20,beforeSend:null!==(a=e.beforeSend)&&void 0!==a?a:e=>e,reportInterval:null!==(c=e.reportInterval)&&void 0!==c?c:6e4,batchSize:null!==(u=e.batchSize)&&void 0!==u?u:10,maxQueueSize:null!==(l=e.maxQueueSize)&&void 0!==l?l:100,enableImmediateReport:null===(p=e.enableImmediateReport)||void 0===p||p}}init(){this.shouldSample()&&this.setupErrorHandling()}shouldSample(){return Math.random()<this.config.sampling}setupErrorHandling(){const e=console.error;console.error=(...t)=>{try{e.apply(console,t)}catch(e){}},window.addEventListener("error",e=>{this.safeExecute(()=>{})}),window.addEventListener("unhandledrejection",e=>{this.safeExecute(()=>{})})}safeExecute(e){try{this.isDestroyed||e()}catch(e){this.config.debug&&console.warn("WebMonitorSDK internal error:",e)}}addBreadcrumb(e){this.breadcrumbs.length>=this.config.maxBreadcrumbsNum&&this.breadcrumbs.shift(),this.breadcrumbs.push(e)}report(e){this.safeExecute(()=>{const t={appId:this.config.appId,timestamp:Date.now(),sessionId:this.sessionId,userId:this.userId,url:window.location.href,userAgent:navigator.userAgent,breadcrumbs:[...this.breadcrumbs],...e},r=this.config.beforeSend(t);r&&(this.transport.send(r),this.config.debug&&console.log("WebMonitorSDK Report:",r))})}use(e){this.plugins.has(e.name)?console.warn(`Plugin ${e.name} already installed`):(this.plugins.set(e.name,e),e.install(this))}unuse(e){const t=this.plugins.get(e);t&&t.uninstall&&t.uninstall(this),this.plugins.delete(e)}destroy(){this.isDestroyed=!0,this.transport.destroy(),this.plugins.forEach(e=>{e.uninstall&&e.uninstall(this)}),this.plugins.clear(),this.breadcrumbs=[]}get isDebug(){return this.config.debug}get appId(){return this.config.appId}get currentSessionId(){return this.sessionId}get currentUserId(){return this.userId}}var u,l,p,d,h=-1,m=function(e){addEventListener("pageshow",function(t){t.persisted&&(h=t.timeStamp,e(t))},!0)},y=function(){return window.performance&&performance.getEntriesByType&&performance.getEntriesByType("navigation")[0]},g=function(){var e=y();return e&&e.activationStart||0},f=function(e,t){var r=y(),o="navigate";return h>=0?o="back-forward-cache":r&&(document.prerendering||g()>0?o="prerender":document.wasDiscarded?o="restore":r.type&&(o=r.type.replace(/_/g,"-"))),{name:e,value:void 0===t?-1:t,rating:"good",delta:0,entries:[],id:"v3-".concat(Date.now(),"-").concat(Math.floor(8999999999999*Math.random())+1e12),navigationType:o}},v=function(e,t,r){try{if(PerformanceObserver.supportedEntryTypes.includes(e)){var o=new PerformanceObserver(function(e){Promise.resolve().then(function(){t(e.getEntries())})});return o.observe(Object.assign({type:e,buffered:!0},r||{})),o}}catch(e){}},R=function(e,t,r,o){var i,n;return function(s){t.value>=0&&(s||o)&&((n=t.value-(i||0))||void 0===i)&&(i=t.value,t.delta=n,t.rating=function(e,t){return e>t[1]?"poor":e>t[0]?"needs-improvement":"good"}(t.value,r),e(t))}},w=function(e){requestAnimationFrame(function(){return requestAnimationFrame(function(){return e()})})},E=function(e){var t=function(t){"pagehide"!==t.type&&"hidden"!==document.visibilityState||e(t)};addEventListener("visibilitychange",t,!0),addEventListener("pagehide",t,!0)},T=function(e){var t=!1;return function(r){t||(e(r),t=!0)}},S=-1,b=function(){return"hidden"!==document.visibilityState||document.prerendering?1/0:0},P=function(e){"hidden"===document.visibilityState&&S>-1&&(S="visibilitychange"===e.type?e.timeStamp:0,I())},D=function(){addEventListener("visibilitychange",P,!0),addEventListener("prerenderingchange",P,!0)},I=function(){removeEventListener("visibilitychange",P,!0),removeEventListener("prerenderingchange",P,!0)},x=function(){return S<0&&(S=b(),D(),m(function(){setTimeout(function(){S=b(),D()},0)})),{get firstHiddenTime(){return S}}},C=function(e){document.prerendering?addEventListener("prerenderingchange",function(){return e()},!0):e()},O=[1800,3e3],M=function(e,t){t=t||{},C(function(){var r,o=x(),i=f("FCP"),n=v("paint",function(e){e.forEach(function(e){"first-contentful-paint"===e.name&&(n.disconnect(),e.startTime<o.firstHiddenTime&&(i.value=Math.max(e.startTime-g(),0),i.entries.push(e),r(!0)))})});n&&(r=R(e,i,O,t.reportAllChanges),m(function(o){i=f("FCP"),r=R(e,i,O,t.reportAllChanges),w(function(){i.value=performance.now()-o.timeStamp,r(!0)})}))})},_=[.1,.25],B={passive:!0,capture:!0},L=new Date,A=function(e,t){u||(u=t,l=e,p=new Date,k(removeEventListener),Q())},Q=function(){if(l>=0&&l<p-L){var e={entryType:"first-input",name:u.type,target:u.target,cancelable:u.cancelable,startTime:u.timeStamp,processingStart:u.timeStamp+l};d.forEach(function(t){t(e)}),d=[]}},H=function(e){if(e.cancelable){var t=(e.timeStamp>1e12?new Date:performance.now())-e.timeStamp;"pointerdown"==e.type?function(e,t){var r=function(){A(e,t),i()},o=function(){i()},i=function(){removeEventListener("pointerup",r,B),removeEventListener("pointercancel",o,B)};addEventListener("pointerup",r,B),addEventListener("pointercancel",o,B)}(t,e):A(t,e)}},k=function(e){["mousedown","keydown","touchstart","pointerdown"].forEach(function(t){return e(t,H,B)})},N=[100,300],$=[2500,4e3],U={},F=[800,1800],V=function e(t){document.prerendering?C(function(){return e(t)}):"complete"!==document.readyState?addEventListener("load",function(){return e(t)},!0):setTimeout(t,0)},q=function(e,t){t=t||{};var r=f("TTFB"),o=R(e,r,F,t.reportAllChanges);V(function(){var i=y();if(i){var n=i.responseStart;if(n<=0||n>performance.now())return;r.value=Math.max(n-g(),0),r.entries=[i],o(!0),m(function(){r=f("TTFB",0),(o=R(e,r,F,t.reportAllChanges))(!0)})}})};class z{constructor(e){this.observer=null,this.monitor=e,this.init()}init(){this.collectWebVitals(),this.collectNavigationTiming(),this.collectResourceTiming(),this.collectAPITiming()}collectWebVitals(){!function(e,t){t=t||{},C(function(){var r,o=x(),i=f("LCP"),n=function(e){var t=e[e.length-1];t&&t.startTime<o.firstHiddenTime&&(i.value=Math.max(t.startTime-g(),0),i.entries=[t],r())},s=v("largest-contentful-paint",n);if(s){r=R(e,i,$,t.reportAllChanges);var a=T(function(){U[i.id]||(n(s.takeRecords()),s.disconnect(),U[i.id]=!0,r(!0))});["keydown","click"].forEach(function(e){addEventListener(e,function(){return setTimeout(a,0)},!0)}),E(a),m(function(o){i=f("LCP"),r=R(e,i,$,t.reportAllChanges),w(function(){i.value=performance.now()-o.timeStamp,U[i.id]=!0,r(!0)})})}})}(e=>{this.reportMetric({type:exports.PerformanceType.LCP,name:"LCP",value:e.value,rating:e.rating,delta:e.delta,entries:e.entries})}),function(e,t){t=t||{},C(function(){var r,o=x(),i=f("FID"),n=function(e){e.startTime<o.firstHiddenTime&&(i.value=e.processingStart-e.startTime,i.entries.push(e),r(!0))},s=function(e){e.forEach(n)},a=v("first-input",s);r=R(e,i,N,t.reportAllChanges),a&&E(T(function(){s(a.takeRecords()),a.disconnect()})),a&&m(function(){var o;i=f("FID"),r=R(e,i,N,t.reportAllChanges),d=[],l=-1,u=null,k(addEventListener),o=n,d.push(o),Q()})})}(e=>{this.reportMetric({type:exports.PerformanceType.FID,name:"FID",value:e.value,rating:e.rating,delta:e.delta,entries:e.entries})}),function(e,t){t=t||{},M(T(function(){var r,o=f("CLS",0),i=0,n=[],s=function(e){e.forEach(function(e){if(!e.hadRecentInput){var t=n[0],r=n[n.length-1];i&&e.startTime-r.startTime<1e3&&e.startTime-t.startTime<5e3?(i+=e.value,n.push(e)):(i=e.value,n=[e])}}),i>o.value&&(o.value=i,o.entries=n,r())},a=v("layout-shift",s);a&&(r=R(e,o,_,t.reportAllChanges),E(function(){s(a.takeRecords()),r(!0)}),m(function(){i=0,o=f("CLS",0),r=R(e,o,_,t.reportAllChanges),w(function(){return r()})}),setTimeout(r,0))}))}(e=>{this.reportMetric({type:exports.PerformanceType.CLS,name:"CLS",value:e.value,rating:e.rating,delta:e.delta,entries:e.entries})}),M(e=>{this.reportMetric({type:exports.PerformanceType.FCP,name:"FCP",value:e.value,rating:e.rating,delta:e.delta,entries:e.entries})}),q(e=>{this.reportMetric({type:exports.PerformanceType.TTFB,name:"TTFB",value:e.value,rating:e.rating,delta:e.delta,entries:e.entries})})}collectNavigationTiming(){window.addEventListener("load",()=>{setTimeout(()=>{const e=performance.getEntriesByType("navigation")[0];if(!e)return;const t={dnsLookup:e.domainLookupEnd-e.domainLookupStart,tcpConnect:e.connectEnd-e.connectStart,sslConnect:e.secureConnectionStart>0?e.connectEnd-e.secureConnectionStart:0,request:e.responseStart-e.requestStart,response:e.responseEnd-e.responseStart,domParse:e.domInteractive-e.responseEnd,domContentLoaded:e.domContentLoadedEventEnd-e.fetchStart,loadComplete:e.loadEventEnd-e.fetchStart,firstPaint:this.getFirstPaint(),firstContentfulPaint:this.getFirstContentfulPaint()};this.reportMetric({type:exports.PerformanceType.NAVIGATION,name:"Navigation Timing",value:t.loadComplete,entries:[e],navigationType:this.getNavigationType("number"==typeof e.type?e.type:0)}),this.monitor.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.PERFORMANCE,category:"navigation",message:"Page loaded",level:"info",data:t})},0)})}collectResourceTiming(){if(PerformanceObserver)try{this.observer=new PerformanceObserver(e=>{e.getEntries().forEach(e=>{if("resource"===e.entryType){const t=e;if(t.name.includes(this.monitor.appId))return;this.reportMetric({type:exports.PerformanceType.RESOURCE,name:t.name,value:t.duration,entries:[e]}),t.duration>3e3&&this.monitor.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.PERFORMANCE,category:"resource",message:`Slow resource: ${t.name}`,level:"warning",data:{duration:t.duration,size:t.transferSize||0}})}})}),this.observer.observe({entryTypes:["resource"]})}catch(e){}}collectAPITiming(){const e=window.fetch;window.fetch=async(...t)=>{const r=performance.now(),o="string"==typeof t[0]?t[0]:t[0].url;try{const i=await e.apply(window,t),n=performance.now()-r;return this.reportMetric({type:exports.PerformanceType.API,name:o,value:n,entries:[]}),n>2e3&&this.monitor.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.PERFORMANCE,category:"api",message:`Slow API: ${o}`,level:"warning",data:{duration:n,status:i.status}}),i}catch(e){const t=performance.now()-r;throw this.reportMetric({type:exports.PerformanceType.API,name:o,value:t,entries:[]}),e}};const t=XMLHttpRequest.prototype.open,r=XMLHttpRequest.prototype.send,o=this;XMLHttpRequest.prototype.open=function(e,r,o,i,n){return this._monitor_url=r.toString(),this._monitor_startTime=performance.now(),t.call(this,e,r,null==o||o,i,n)},XMLHttpRequest.prototype.send=function(e){const t=this,i=t._monitor_startTime,n=t._monitor_url;return t.addEventListener("readystatechange",()=>{if(4===t.readyState){const e=performance.now()-i;o&&n&&(o.reportMetric({type:exports.PerformanceType.API,name:n,value:e,entries:[]}),e>2e3&&o.monitor.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.PERFORMANCE,category:"api",message:`Slow XHR: ${n}`,level:"warning",data:{duration:e,status:t.status}}))}}),r.call(this,e)}}getFirstPaint(){const e=performance.getEntriesByType("paint").find(e=>"first-paint"===e.name);return e?e.startTime:0}getFirstContentfulPaint(){const e=performance.getEntriesByType("paint").find(e=>"first-contentful-paint"===e.name);return e?e.startTime:0}getNavigationType(e){return["navigate","reload","back_forward","prerender"][e]||"unknown"}reportMetric(e){this.monitor.report({type:exports.DataType.PERFORMANCE,data:e})}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null)}}class X{constructor(e){this.monitor=e,this.originalFetch=window.fetch,this.originalXHROpen=XMLHttpRequest.prototype.open,this.originalXHRSend=XMLHttpRequest.prototype.send,this.init()}init(){this.handleJSError(),this.handlePromiseError(),this.handleResourceError(),this.handleAPIError()}handleJSError(){window.addEventListener("error",e=>{const{message:t,filename:r,lineno:o,colno:i,error:n}=e,s={type:exports.ErrorType.JS_ERROR,message:t||"Unknown error",filename:r,lineno:o,colno:i,stack:null==n?void 0:n.stack};this.reportError(s),this.monitor.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.ERROR,category:"javascript",message:`JS Error: ${t}`,level:"error",data:{filename:r,lineno:o,colno:i}})},!0)}handlePromiseError(){window.addEventListener("unhandledrejection",e=>{let t="Unhandled Promise Rejection",r="";if(e.reason)if(e.reason instanceof Error)t=e.reason.message,r=e.reason.stack||"";else if("string"==typeof e.reason)t=e.reason;else try{t=JSON.stringify(e.reason)}catch(r){t=String(e.reason)}const o={type:exports.ErrorType.PROMISE_ERROR,message:t,stack:r};this.reportError(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.ERROR,category:"promise",message:`Promise Error: ${t}`,level:"error",data:{reason:e.reason}})})}handleResourceError(){window.addEventListener("error",e=>{const t=e.target;if(t&&t!==window&&("IMG"===t.tagName||"SCRIPT"===t.tagName||"LINK"===t.tagName||"AUDIO"===t.tagName||"VIDEO"===t.tagName)){const e={type:exports.ErrorType.RESOURCE_ERROR,message:`Resource load error: ${t.tagName}`,resourceUrl:t.src||t.href||"",elementSelector:a(t)};this.reportError(e),this.monitor.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.ERROR,category:"resource",message:`Resource Error: ${t.tagName}`,level:"error",data:{url:e.resourceUrl,element:t.tagName}})}},!0)}handleAPIError(){window.fetch=async(...e)=>{const t="string"==typeof e[0]?e[0]:e[0].url,r=Date.now();try{const o=await this.originalFetch.apply(window,e);if(!o.ok){const e={type:exports.ErrorType.API_ERROR,message:`API Error: ${o.status} ${o.statusText}`,resourceUrl:t,statusCode:o.status};this.reportError(e),this.monitor.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.ERROR,category:"api",message:`API Error: ${t}`,level:"error",data:{status:o.status,statusText:o.statusText,duration:Date.now()-r}})}return o}catch(e){const o={type:exports.ErrorType.API_ERROR,message:`Network Error: ${e instanceof Error?e.message:"Unknown error"}`,resourceUrl:t,stack:e instanceof Error?e.stack:void 0};throw this.reportError(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.ERROR,category:"api",message:`Network Error: ${t}`,level:"error",data:{error:e instanceof Error?e.message:String(e),duration:Date.now()-r}}),e}};const e=this;XMLHttpRequest.prototype.open=function(t,r,o,i,n){return this._monitor_url=r.toString(),this._monitor_method=t,this._monitor_startTime=Date.now(),e.originalXHROpen.call(this,t,r,null==o||o,i,n)},XMLHttpRequest.prototype.send=function(t){const r=this,o=r._monitor_url,i=r._monitor_method,n=r._monitor_startTime;return r.addEventListener("error",()=>{const t={type:exports.ErrorType.API_ERROR,message:`XMLHttpRequest Error: ${i} ${o}`,resourceUrl:o,statusCode:r.status};e.reportError(t),e.monitor.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.ERROR,category:"api",message:`XHR Error: ${i} ${o}`,level:"error",data:{method:i,status:r.status,duration:Date.now()-n}})}),r.addEventListener("load",()=>{if(r.status>=400){const t={type:exports.ErrorType.API_ERROR,message:`API Error: ${r.status} ${r.statusText}`,resourceUrl:o,statusCode:r.status};e.reportError(t),e.monitor.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.ERROR,category:"api",message:`XHR ${r.status}: ${i} ${o}`,level:"error",data:{method:i,status:r.status,statusText:r.statusText,duration:Date.now()-n}})}}),e.originalXHRSend.call(this,t)}}reportError(e){this.monitor.report({type:exports.DataType.ERROR,data:e})}reportCustomError(e,t){const r={type:exports.ErrorType.CUSTOM_ERROR,message:e,stack:(new Error).stack,...t};this.reportError(r),this.monitor.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.ERROR,category:"custom",message:`Custom Error: ${e}`,level:"error",data:t})}destroy(){window.fetch=this.originalFetch,XMLHttpRequest.prototype.open=this.originalXHROpen,XMLHttpRequest.prototype.send=this.originalXHRSend}}class K{constructor(e){this.monitor=e,this.currentUrl=window.location.href,this.startTime=Date.now(),this.init()}init(){this.trackPageView(),this.trackClicks(),this.trackInputs(),this.trackScrolls(),this.trackRouteChanges()}trackPageView(){const e={type:exports.BehaviorType.PAGE_VIEW,url:this.currentUrl};this.reportBehavior(e),this.monitor.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.BEHAVIOR,category:"navigation",message:`Page view: ${this.currentUrl}`,level:"info",data:{url:this.currentUrl,referrer:document.referrer}})}trackClicks(){document.addEventListener("click",e=>{const t=e.target;if(!t)return;const r={type:exports.BehaviorType.CLICK,element:t.tagName,selector:a(t),text:(o=t,"INPUT"===o.tagName?o.value||o.placeholder||"":(null===(i=o.textContent)||void 0===i?void 0:i.trim().slice(0,100))||"")};var o,i;this.reportBehavior(r),this.monitor.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.BEHAVIOR,category:"interaction",message:`Click: ${t.tagName}`,level:"info",data:{text:r.text,selector:r.selector}})},!0)}trackInputs(){const e=function(e,t){let r=null;return function(...o){const i=this;r&&clearTimeout(r),r=window.setTimeout(()=>{e.apply(i,o),r=null},t)}}(e=>{const t=e.target;if(!t||"password"===t.type)return;const r={type:exports.BehaviorType.INPUT,element:t.tagName,selector:a(t),text:"password"===t.type?"***":t.value.slice(0,100)};this.reportBehavior(r),this.monitor.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.BEHAVIOR,category:"interaction",message:`Input: ${t.tagName}`,level:"info",data:{type:t.type,selector:r.selector}})},500);document.addEventListener("input",e,!0),document.addEventListener("change",e,!0)}trackScrolls(){let e=0;const t=function(e,t){let r=null,o=0;return function(...i){const n=Date.now(),s=this;n-o>t?(e.apply(s,i),o=n):(r&&clearTimeout(r),r=window.setTimeout(()=>{e.apply(s,i),o=Date.now(),r=null},t-(n-o)))}}(()=>{const t=window.pageYOffset||document.documentElement.scrollTop,r=window.innerHeight,o=document.documentElement.scrollHeight,i=Math.round((t+r)/o*100);if(i>e&&(e=i,i>=25&&i%25==0)){const e={type:exports.BehaviorType.SCROLL,text:`${i}%`};this.reportBehavior(e),this.monitor.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.BEHAVIOR,category:"interaction",message:`Scroll: ${i}%`,level:"info",data:{depth:i,scrollTop:t,documentHeight:o}})}},1e3);window.addEventListener("scroll",t,{passive:!0})}trackRouteChanges(){const e=history.pushState,t=history.replaceState,r=(e,t)=>{const r=Date.now()-this.startTime,o={type:exports.BehaviorType.ROUTE_CHANGE,from:e,to:t,duration:r};this.reportBehavior(o),this.monitor.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.BEHAVIOR,category:"navigation",message:`Route change: ${e} -> ${t}`,level:"info",data:{from:e,to:t,duration:r}}),this.currentUrl=t,this.startTime=Date.now()};history.pushState=function(t,o,i){const n=window.location.href,s=e.apply(this,arguments),a=window.location.href;return n!==a&&r(n,a),s},history.replaceState=function(e,o,i){const n=window.location.href,s=t.apply(this,arguments),a=window.location.href;return n!==a&&r(n,a),s},window.addEventListener("popstate",()=>{const e=window.location.href;r(this.currentUrl,e)}),window.addEventListener("hashchange",()=>{const e=window.location.href;r(this.currentUrl,e)})}reportCustomBehavior(e,t){const r={type:e,...t};this.reportBehavior(r),this.monitor.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.BEHAVIOR,category:"custom",message:`Custom behavior: ${e}`,level:"info",data:t})}reportBehavior(e){this.monitor.report({type:exports.DataType.BEHAVIOR,data:e})}destroy(){}}const W={name:"vue",install(e){if("undefined"!=typeof window&&window.Vue){window.Vue.config.errorHandler=(t,r,o)=>{var i,n;const s={type:exports.ErrorType.JS_ERROR,message:t.message,stack:t.stack,source:`Vue ${o}`,filename:(null===(i=null==r?void 0:r.$options)||void 0===i?void 0:i.__file)||"Vue Component"};e.report({type:exports.DataType.ERROR,data:s}),e.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.ERROR,category:"vue",message:`Vue Error: ${t.message}`,level:"error",data:{info:o,component:(null===(n=null==r?void 0:r.$options)||void 0===n?void 0:n.name)||"Anonymous Component"}})}}if("undefined"!=typeof window&&window.Vue&&window.Vue.version&&window.Vue.version.startsWith("3")){window.Vue.createApp({}).config.errorHandler=(t,r,o)=>{var i,n;const s={type:exports.ErrorType.JS_ERROR,message:t.message,stack:t.stack,source:`Vue3 ${o}`,filename:(null===(i=null==r?void 0:r.$options)||void 0===i?void 0:i.__file)||"Vue3 Component"};e.report({type:exports.DataType.ERROR,data:s}),e.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.ERROR,category:"vue3",message:`Vue3 Error: ${t.message}`,level:"error",data:{info:o,component:(null===(n=null==r?void 0:r.type)||void 0===n?void 0:n.name)||"Anonymous Component"}})}}}},G={name:"react",install(e){if("undefined"!=typeof window&&window.React){const t=window.React.createElement;window.React.createElement=function(r,o,...i){if("function"==typeof r&&r.prototype&&r.prototype.isReactComponent){const t=r.prototype.componentDidCatch;r.prototype.componentDidCatch=function(o,i){const n={type:exports.ErrorType.JS_ERROR,message:o.message,stack:o.stack,source:"React Component",filename:i.componentStack};e.report({type:exports.DataType.ERROR,data:n}),e.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.ERROR,category:"react",message:`React Error: ${o.message}`,level:"error",data:{componentStack:i.componentStack,component:r.name||"Anonymous Component"}}),t&&t.call(this,o,i)}}return t.apply(this,arguments)}}if("undefined"!=typeof window&&window.ReactDOM&&window.ReactDOM.createRoot){const t=window.ReactDOM.createRoot;window.ReactDOM.createRoot=function(r,o={}){const i={...o,onRecoverableError:(t,r)=>{const i={type:exports.ErrorType.JS_ERROR,message:t.message,stack:t.stack,source:"React Recoverable Error"};e.report({type:exports.DataType.ERROR,data:i}),e.addBreadcrumb({timestamp:Date.now(),type:exports.DataType.ERROR,category:"react",message:`React Recoverable Error: ${t.message}`,level:"warning",data:r}),o.onRecoverableError&&o.onRecoverableError(t,r)}};return t.call(this,r,i)}}}};class j{constructor(e){this.isInitialized=!1,/bot|crawler|spider|crawling/i.test(navigator.userAgent)?this.monitor={}:(this.monitor=new c(e),this.init(),window.__webMonitorSDK=this)}init(){if(this.isInitialized)console.warn("WebMonitorSDK already initialized");else try{this.monitor.config.enablePerformance&&(this.performanceMonitor=new z(this.monitor)),this.monitor.config.enableError&&(this.errorMonitor=new X(this.monitor)),this.monitor.config.enableBehavior&&(this.behaviorMonitor=new K(this.monitor)),this.isInitialized=!0,this.monitor.isDebug&&console.log("WebMonitorSDK initialized successfully")}catch(e){console.error("Failed to initialize WebMonitorSDK:",e)}}reportError(e,t){this.errorMonitor&&this.errorMonitor.reportCustomError(e,t)}reportBehavior(e,t){this.behaviorMonitor&&this.behaviorMonitor.reportCustomBehavior(e,t)}report(e){this.monitor.report(e)}use(e){return this.monitor.use(e),this}unuse(e){return this.monitor.unuse(e),this}setUser(e,t){this.monitor.userId=e,this.monitor.addBreadcrumb({timestamp:Date.now(),type:"behavior",category:"user",message:`User set: ${e}`,level:"info",data:t})}setTag(e,t){this.monitor.tags||(this.monitor.tags={}),this.monitor.tags[e]=t}setContext(e,t){this.monitor.contexts||(this.monitor.contexts={}),this.monitor.contexts[e]=t}destroy(){var e,t,r;this.isInitialized&&(null===(e=this.performanceMonitor)||void 0===e||e.destroy(),null===(t=this.errorMonitor)||void 0===t||t.destroy(),null===(r=this.behaviorMonitor)||void 0===r||r.destroy(),this.monitor.destroy(),this.isInitialized=!1,delete window.__webMonitorSDK,this.monitor.isDebug&&console.log("WebMonitorSDK destroyed"))}getConfig(){return this.monitor.config}getSessionId(){return this.monitor.currentSessionId}getUserId(){return this.monitor.currentUserId}}exports.ReactPlugin=G,exports.VuePlugin=W,exports.WebMonitorSDK=j,exports.createWebMonitorSDK=function(e){return new j(e)},exports.default=j;
